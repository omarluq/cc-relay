# Phase 4.2: Config File Cleanup - Research

**Researched:** 2026-01-23
**Domain:** Configuration file management, Go CLI patterns
**Confidence:** HIGH

## Summary

This phase involves removing the duplicate `config.yaml` from the project root while keeping `example.yaml` as the canonical reference. The research confirms that `example.yaml` is more complete (10.4KB with HTTP/2, auth, cache, models sections) while `config.yaml` (7.5KB) is a simpler development artifact that causes confusion.

The cleanup requires:
1. Removing `config.yaml` from root
2. Updating the `defaultConfigFile` constant in `cmd/cc-relay/main.go` (currently hardcoded to `"config.yaml"`)
3. Updating documentation references that mention `config.yaml` as a file to create/edit
4. Ensuring `cc-relay config init` remains the recommended way to generate user configs

**Primary recommendation:** Change the default config search to look for `example.yaml` in the working directory, or simply rely on `~/.config/cc-relay/config.yaml` as the runtime config location (generated by `config init`).

## Standard Stack

### Core
| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| Go standard library `os`, `filepath` | 1.24+ | File existence checks, path manipulation | Built-in, no dependencies |
| Cobra CLI | v1.8+ | Command-line flag parsing | Already used in project |
| git | latest | File removal, history tracking | Standard VCS |

### Supporting
| Tool | Purpose | When to Use |
|------|---------|-------------|
| `grep`/`rg` | Finding references | During audit of code/docs |
| `git rm` | Removing tracked files | To ensure proper git history |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Remove `config.yaml` entirely | Rename to `.config.yaml.example` | More confusion, not cleaner |
| Keep both | Document clearly which to use | Maintains user confusion |

## Architecture Patterns

### Current File Search Order

```go
// cmd/cc-relay/main.go:12
const defaultConfigFile = "config.yaml"

// cmd/cc-relay/serve.go:145-159
func findConfigFile() string {
    // 1. Check current directory for defaultConfigFile
    if _, err := os.Stat(defaultConfigFile); err == nil {
        return defaultConfigFile
    }
    // 2. Check ~/.config/cc-relay/defaultConfigFile
    home, err := os.UserHomeDir()
    if err == nil && home != "" {
        p := filepath.Join(home, ".config", "cc-relay", defaultConfigFile)
        if _, err := os.Stat(p); err == nil {
            return p
        }
    }
    // 3. Return defaultConfigFile (will error if not found)
    return defaultConfigFile
}
```

### Recommended Config File Strategy

After cleanup:
```
Repository Root:
├── example.yaml           # Canonical reference (comprehensive)
└── (no config.yaml)       # REMOVED

User Runtime:
~/.config/cc-relay/
└── config.yaml            # Generated by 'cc-relay config init'

Development:
- Developers use: --config example.yaml
- Or run: cc-relay config init
```

### Pattern: Default Config Naming

**Decision:** Keep `defaultConfigFile = "config.yaml"` but remove the root file.

**Rationale:**
- Users expect `config.yaml` as the runtime config name
- `example.yaml` is clearly a template/reference, not runtime
- `cc-relay config init` generates `~/.config/cc-relay/config.yaml`
- The search order (`./config.yaml` -> `~/.config/cc-relay/config.yaml`) remains sensible

### Anti-Patterns to Avoid
- **Renaming example.yaml to config.yaml:** Would lose the "example" semantic
- **Changing default search to example.yaml:** Confusing - examples shouldn't auto-load
- **Keeping both files:** Current problem - duplication and drift

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Finding references | Manual file-by-file check | `grep -r "config\.yaml"` | Consistent, thorough |
| Tracking removal | Manual file deletion | `git rm config.yaml` | Proper git history |

**Key insight:** This is a simple file removal and documentation update - no custom tooling needed.

## Common Pitfalls

### Pitfall 1: Incomplete Reference Updates
**What goes wrong:** Remove file but leave dangling references in docs/code
**Why it happens:** Many docs reference `config.yaml` as the file to create
**How to avoid:** Full grep audit before and after removal
**Warning signs:** Docs telling users to create `config.yaml` that doesn't exist in repo

### Pitfall 2: Breaking Development Workflow
**What goes wrong:** Developers can't run `cc-relay serve` without explicit `--config`
**Why it happens:** Removing `./config.yaml` means no default config in repo root
**How to avoid:**
- Document: "Run `cc-relay config init` first" OR
- Document: "Use `--config example.yaml` for development"
**Warning signs:** README/CLAUDE.md doesn't explain setup

### Pitfall 3: Confusion About example.yaml Purpose
**What goes wrong:** Users copy `example.yaml` to `config.yaml` manually
**Why it happens:** Not clear that `config init` is the recommended path
**How to avoid:** Clear documentation that `config init` is preferred
**Warning signs:** `example.yaml` header doesn't mention `config init`

### Pitfall 4: Worktree Stale Files
**What goes wrong:** `worktrees/caching-improvements/config.yaml` still exists
**Why it happens:** Worktrees have their own copies of files
**How to avoid:** Document that worktrees need manual cleanup or rebase
**Warning signs:** Glob shows config.yaml in worktrees

## Code Examples

### Removing config.yaml with git

```bash
# Remove tracked file and stage deletion
git rm config.yaml

# Verify removal
git status
# Should show: deleted: config.yaml
```

### Updating defaultConfigFile Constant (NO CHANGE NEEDED)

```go
// cmd/cc-relay/main.go - KEEP AS IS
const defaultConfigFile = "config.yaml"

// This is correct because:
// 1. Users run 'cc-relay config init' which creates ~/.config/cc-relay/config.yaml
// 2. The search order finds it at ~/.config/cc-relay/config.yaml
// 3. Developers can use --config example.yaml explicitly
```

### Updating Documentation References

References to update (from grep audit):

**Keep as-is (correct references):**
- `~/.config/cc-relay/config.yaml` - This is the user config location
- `--config /path/to/config.yaml` - Generic CLI usage
- Docker mount examples (user provides their config)

**Update (incorrect references):**
- CLAUDE.md: `./cc-relay serve --config config/example.yaml` should be `--config example.yaml`
- Any "create config.yaml" instructions should become "run `cc-relay config init`"

### config init Command (ALREADY CORRECT)

```go
// cmd/cc-relay/config_init.go:57 - Already references example.yaml
defaultConfig := `# cc-relay configuration
# Generated by 'cc-relay config init'
# For full configuration options, see: https://github.com/omarluq/cc-relay/blob/main/example.yaml
...
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Ship config.yaml in repo | Ship example.yaml + config init | This phase | Cleaner separation |
| Manual config creation | CLI-generated config | Already implemented | Better UX |

**Deprecated/outdated:**
- `config.yaml` in repo root: Development artifact, being removed

## Open Questions

1. **Worktree cleanup**
   - What we know: `worktrees/caching-improvements/config.yaml` exists
   - What's unclear: Should this be cleaned up as part of this phase?
   - Recommendation: Out of scope - worktrees are developer-specific

2. **testdata/test-config.yaml**
   - What we know: Test config exists at `testdata/test-config.yaml`
   - What's unclear: Is this affected?
   - Recommendation: No change needed - this is for tests, not runtime

## Sources

### Primary (HIGH confidence)
- `/home/omarluq/sandbox/go/cc-relay/config.yaml` - File to remove (7,551 bytes)
- `/home/omarluq/sandbox/go/cc-relay/example.yaml` - Canonical reference (10,383 bytes)
- `/home/omarluq/sandbox/go/cc-relay/cmd/cc-relay/main.go` - defaultConfigFile constant
- `/home/omarluq/sandbox/go/cc-relay/cmd/cc-relay/serve.go` - findConfigFile implementation
- `/home/omarluq/sandbox/go/cc-relay/cmd/cc-relay/config_init.go` - config init implementation
- `/home/omarluq/sandbox/go/cc-relay/.goreleaser.yaml` - Releases include example.yaml only

### Secondary (MEDIUM confidence)
- `/home/omarluq/sandbox/go/cc-relay/.planning/v0.0.1-MILESTONE-AUDIT.md` - Extended audit findings

## Impact Summary

### Files to Modify

| File | Change |
|------|--------|
| `config.yaml` | DELETE |
| `.claude/CLAUDE.md` | Update serve example to use `example.yaml` or `config init` |
| `PROJECT_INDEX.md` | Remove/update config.yaml references |
| `PROJECT_INDEX.json` | Remove/update config.yaml references |
| `llms.txt` | Update if references config.yaml |
| `docs-site/content/**/getting-started.md` | Verify instructions match new workflow |

### Files NOT to Modify

| File | Why |
|------|-----|
| `cmd/cc-relay/main.go` | defaultConfigFile="config.yaml" is correct for user config |
| `testdata/test-config.yaml` | Test fixture, not runtime config |
| `worktrees/*/config.yaml` | Worktree-specific, out of scope |
| Docker examples | Users provide their own config |

### Reference Count (from grep)

- `config.yaml` mentioned: ~150 times across all files
- Most are correct (referring to user config location or Docker mounts)
- ~10-15 need updating (referring to repo root config.yaml)

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Standard Go file operations, well-understood
- Architecture: HIGH - Direct code inspection, clear patterns
- Pitfalls: HIGH - Based on actual codebase analysis

**Research date:** 2026-01-23
**Valid until:** Indefinite (simple file operation patterns)
