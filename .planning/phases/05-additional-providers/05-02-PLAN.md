---
phase: 05-additional-providers
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - internal/providers/integration_test.go
  - docs-site/content/en/docs/providers.md
  - docs-site/content/de/docs/providers.md
  - docs-site/content/es/docs/providers.md
  - docs-site/content/ja/docs/providers.md
  - docs-site/content/zh-cn/docs/providers.md
  - docs-site/content/ko/docs/providers.md
autonomous: true

must_haves:
  truths:
    - "Integration test verifies Z.AI provider routing works end-to-end"
    - "Integration test verifies Ollama provider routing works end-to-end"
    - "Model mapping transforms Anthropic model names to provider models"
    - "Documentation explains Z.AI and Ollama configuration"
  artifacts:
    - path: "internal/providers/integration_test.go"
      provides: "Integration tests for provider routing"
      contains: "//go:build integration"
    - path: "docs-site/content/en/docs/providers.md"
      provides: "Provider documentation in English"
      min_lines: 150
  key_links:
    - from: "internal/providers/integration_test.go"
      to: "internal/providers/ollama.go"
      via: "NewOllamaProviderWithModels instantiation"
      pattern: "NewOllamaProvider"
    - from: "internal/providers/integration_test.go"
      to: "internal/providers/zai.go"
      via: "NewZAIProviderWithModels instantiation"
      pattern: "NewZAIProvider"
---

<objective>
Create integration tests validating Z.AI and Ollama provider routing, and comprehensive provider documentation.

Purpose: Verify the complete provider integration works end-to-end (config -> DI -> routing -> response) and document provider-specific configuration for users.

Output:
- `internal/providers/integration_test.go` - Integration tests with mock backends
- `docs-site/content/*/docs/providers.md` - Provider documentation in all 6 languages
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-additional-providers/05-RESEARCH.md

# Prior plan output
@.planning/phases/05-additional-providers/05-01-SUMMARY.md

# Existing integration test patterns
@internal/keypool/integration_test.go

# Documentation patterns
@docs-site/content/en/docs/configuration.md
@docs-site/content/en/docs/routing.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider integration tests</name>
  <files>internal/providers/integration_test.go</files>
  <action>
Create `internal/providers/integration_test.go` with build tag `//go:build integration`:

1. **Test: TestZAIProvider_EndToEnd**
   - Create httptest.Server mocking Z.AI API (return valid Anthropic-format response)
   - Create ZAIProvider pointing to mock server
   - Build http.Request with Anthropic Messages API format
   - Call provider.Authenticate() and provider.ForwardHeaders()
   - Verify request reaches mock server with correct headers
   - Verify x-api-key header is set
   - Verify anthropic-* headers are forwarded

2. **Test: TestOllamaProvider_EndToEnd**
   - Create httptest.Server mocking Ollama's Anthropic endpoint
   - Create OllamaProvider pointing to mock server
   - Build http.Request with Anthropic Messages API format
   - Verify request reaches mock server
   - Verify response is passed through unchanged
   - Test with streaming response (SSE events)

3. **Test: TestProvider_ModelMapping**
   - Verify provider.ListModels() returns configured models
   - Verify Z.AI default models when none configured
   - Verify Ollama empty models when none configured

4. **Test: TestProvider_HealthCheck_Integration**
   - Create provider with mock server that returns 200
   - Verify health check can reach endpoint
   - Create provider with mock server that returns 500
   - Verify health check detects failure

Use httptest.NewServer for mock backends (following keypool/integration_test.go pattern).
All tests skippable when backend not available.
  </action>
  <verify>`go test -v -tags=integration ./internal/providers/` passes (with mock servers)</verify>
  <done>Integration tests exist, pass with mock backends, demonstrate provider routing</done>
</task>

<task type="auto">
  <name>Task 2: Create English provider documentation</name>
  <files>docs-site/content/en/docs/providers.md</files>
  <action>
Create comprehensive provider documentation at `docs-site/content/en/docs/providers.md`:

Frontmatter:
```yaml
---
title: "Providers"
description: "Configure Anthropic, Z.AI, and Ollama providers in cc-relay"
weight: 5
---
```

Sections:

1. **Overview**
   - Brief explanation of multi-provider support
   - List supported providers: Anthropic (direct), Z.AI (Anthropic-compatible), Ollama (local)
   - Mention cloud providers coming in Phase 6 (Bedrock, Azure, Vertex)

2. **Anthropic Provider**
   - Configuration example (from example.yaml)
   - API key setup
   - Models available
   - Transparent auth support (subscription tokens work)

3. **Z.AI Provider**
   - What is Z.AI (Zhipu AI, GLM models, Anthropic-compatible)
   - Cost advantage (~1/7 of Anthropic pricing)
   - Configuration example with model_mapping
   - API key setup (link to Z.AI developer portal)
   - Model mapping explanation (claude-sonnet-4-5 -> GLM-4.7)

4. **Ollama Provider**
   - What is Ollama (local models, privacy, no API costs)
   - Anthropic compatibility since v0.14
   - Configuration example with model_mapping
   - Feature limitations (no prompt caching, no PDF, no image URLs - base64 only)
   - Extended thinking: budget_tokens accepted but not enforced
   - Docker networking note (localhost vs host.docker.internal)

5. **Model Mapping**
   - Explain model_mapping field
   - Examples for translating Anthropic model names to provider models
   - Wildcard patterns (if supported)

6. **Troubleshooting**
   - Connection refused (Ollama not running, wrong port)
   - Authentication failed (Z.AI API key issues)
   - Model not found (check model_mapping)

Keep technical terms in English (Ollama, Z.AI, model_mapping).
Use YAML code blocks for examples.
~200 lines.
  </action>
  <verify>Hugo builds successfully: `cd docs-site && hugo --minify` shows no errors</verify>
  <done>providers.md exists in English with all sections, Hugo builds</done>
</task>

<task type="auto">
  <name>Task 3: Translate provider documentation to all languages</name>
  <files>
    docs-site/content/de/docs/providers.md
    docs-site/content/es/docs/providers.md
    docs-site/content/ja/docs/providers.md
    docs-site/content/zh-cn/docs/providers.md
    docs-site/content/ko/docs/providers.md
  </files>
  <action>
Create provider documentation translations following established patterns:

**German (de/docs/providers.md):**
- Title: "Anbieter"
- Section headers: "Ubersicht", "Anthropic-Anbieter", "Z.AI-Anbieter", "Ollama-Anbieter", etc.
- Keep technical terms in English: Ollama, Z.AI, model_mapping, base_url

**Spanish (es/docs/providers.md):**
- Title: "Proveedores"
- Section headers: "Descripcion general", "Proveedor Anthropic", "Proveedor Z.AI", etc.
- Keep technical terms in English

**Japanese (ja/docs/providers.md):**
- Title: "providers (providers)"
- Use katakana for borrowed terms
- Keep YAML blocks and technical terms in English

**Chinese Simplified (zh-cn/docs/providers.md):**
- Title: "providers"
- Keep technical terms and YAML in English

**Korean (ko/docs/providers.md):**
- Title: "providers (providers)"
- Keep technical terms and YAML in English

All translations:
- Same frontmatter weight: 5
- Same code blocks (YAML examples unchanged)
- Same structure as English
- Update cross-references to use language-specific paths (/de/docs/, /es/docs/, etc.)
  </action>
  <verify>Hugo builds all languages: `cd docs-site && hugo --minify` shows no errors for any language</verify>
  <done>providers.md exists in all 6 languages, Hugo builds successfully</done>
</task>

</tasks>

<verification>
1. Integration tests pass: `go test -v -tags=integration ./internal/providers/`
2. Hugo site builds: `cd docs-site && hugo --minify`
3. All 6 language versions exist: `ls docs-site/content/*/docs/providers.md`
4. Linters pass: `task lint`
</verification>

<success_criteria>
- Integration tests verify Z.AI and Ollama provider routing with mock backends
- Provider documentation covers all three providers (Anthropic, Z.AI, Ollama)
- Model mapping explained with examples
- Feature limitations documented (Ollama: no prompt caching, PDF, image URLs)
- All 6 language translations complete
- Hugo site builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-additional-providers/05-02-SUMMARY.md`
</output>
