---
phase: 05-additional-providers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/providers/ollama.go
  - internal/providers/ollama_test.go
  - cmd/cc-relay/di/providers.go
autonomous: true

must_haves:
  truths:
    - "Ollama provider can be instantiated with default localhost URL"
    - "Ollama provider can be instantiated with custom URL"
    - "Ollama provider implements Provider interface"
    - "DI container creates Ollama provider when type: ollama configured"
  artifacts:
    - path: "internal/providers/ollama.go"
      provides: "OllamaProvider type with BaseProvider embedding"
      exports: ["OllamaProvider", "NewOllamaProvider", "NewOllamaProviderWithModels", "DefaultOllamaBaseURL", "OllamaOwner"]
    - path: "internal/providers/ollama_test.go"
      provides: "Unit tests for Ollama provider"
      min_lines: 150
    - path: "cmd/cc-relay/di/providers.go"
      provides: "DI wiring for ollama provider type"
      contains: 'case "ollama"'
  key_links:
    - from: "internal/providers/ollama.go"
      to: "internal/providers/base.go"
      via: "BaseProvider embedding"
      pattern: "BaseProvider"
    - from: "cmd/cc-relay/di/providers.go"
      to: "internal/providers/ollama.go"
      via: "NewOllamaProviderWithModels call"
      pattern: "NewOllamaProviderWithModels"
---

<objective>
Implement OllamaProvider following the established BaseProvider embedding pattern used by Z.AI.

Purpose: Enable cc-relay to route requests to local Ollama instances using Ollama's native Anthropic Messages API compatibility (v0.14+). This is a direct passthrough - no request transformation needed.

Output:
- `internal/providers/ollama.go` - Provider implementation
- `internal/providers/ollama_test.go` - Comprehensive unit tests
- Updated DI container wiring for `type: "ollama"`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-additional-providers/05-RESEARCH.md

# Existing patterns to follow
@internal/providers/zai.go
@internal/providers/zai_test.go
@internal/providers/base.go
@internal/providers/provider.go
@cmd/cc-relay/di/providers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OllamaProvider implementation</name>
  <files>internal/providers/ollama.go</files>
  <action>
Create `internal/providers/ollama.go` following the exact pattern from `zai.go`:

1. Define constants:
   - `DefaultOllamaBaseURL = "http://localhost:11434"` (standard Ollama port)
   - `OllamaOwner = "ollama"`
   - No default models (unlike Z.AI) - Ollama models are user-installed, so empty slice is appropriate

2. Define OllamaProvider struct embedding BaseProvider (identical to ZAIProvider pattern)

3. Implement constructors:
   - `NewOllamaProvider(name, baseURL string) *OllamaProvider`
   - `NewOllamaProviderWithModels(name, baseURL string, models []string) *OllamaProvider`

   Key difference from Z.AI: When baseURL is empty, use DefaultOllamaBaseURL.
   When models is empty/nil, use empty slice (NOT default models - Ollama has no standard model list).

4. BaseProvider handles all methods via embedding - no overrides needed:
   - Name(), BaseURL(), Owner() - from BaseProvider
   - Authenticate() - BaseProvider sets x-api-key (Ollama accepts but ignores)
   - ForwardHeaders() - BaseProvider forwards anthropic-* headers
   - SupportsStreaming() - returns true (Ollama supports SSE)
   - SupportsTransparentAuth() - returns false (Ollama cannot validate Anthropic tokens)
   - ListModels() - returns configured models

File should be ~50 lines, very similar to zai.go but simpler (no default models).
  </action>
  <verify>`go build ./internal/providers/` compiles without errors</verify>
  <done>ollama.go exists with OllamaProvider type, constructors exported, embeds BaseProvider</done>
</task>

<task type="auto">
  <name>Task 2: Create OllamaProvider unit tests</name>
  <files>internal/providers/ollama_test.go</files>
  <action>
Create `internal/providers/ollama_test.go` following the exact pattern from `zai_test.go`:

1. TestNewOllamaProvider - test constructor with custom and default URLs
2. TestOllamaAuthenticate - verify x-api-key header is set (even though Ollama ignores it)
3. TestOllamaForwardHeaders - verify anthropic-* headers forwarded, Content-Type set
4. TestOllamaSupportsStreaming - verify returns true
5. TestOllamaForwardHeaders_EdgeCases - empty headers, multiple anthropic headers, short header names
6. TestOllamaProviderInterface - verify `var _ Provider = (*OllamaProvider)(nil)` compiles
7. TestOllamaOwner - verify returns "ollama"
8. TestOllamaListModels_WithConfiguredModels - verify configured models returned correctly
9. TestOllamaListModels_Empty - verify empty slice returned when no models configured (different from Z.AI which has defaults)

All tests should be parallel (`t.Parallel()`).
Use table-driven tests where appropriate.
File should be ~200 lines, similar structure to zai_test.go.
  </action>
  <verify>`go test -v ./internal/providers/ -run Ollama` passes all tests</verify>
  <done>ollama_test.go exists with comprehensive tests, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Wire OllamaProvider into DI container</name>
  <files>cmd/cc-relay/di/providers.go</files>
  <action>
Update `cmd/cc-relay/di/providers.go` NewProviderMap function to handle `type: "ollama"`:

1. Add case to the switch statement (around line 217-224):
```go
case "ollama":
    prov = providers.NewOllamaProviderWithModels(p.Name, p.BaseURL, p.Models)
```

2. Update the error message (line 239) to include "ollama" in supported types:
```go
return nil, fmt.Errorf("no enabled provider found (supported types: anthropic, zai, ollama)")
```

This is a minimal 2-line change following the established pattern for anthropic and zai.
  </action>
  <verify>`go build ./cmd/cc-relay/...` compiles without errors; `go test ./cmd/cc-relay/di/...` passes</verify>
  <done>DI container handles type: "ollama" configuration, error message updated</done>
</task>

</tasks>

<verification>
1. All new code compiles: `go build ./...`
2. All tests pass: `go test ./internal/providers/... ./cmd/cc-relay/di/...`
3. Linters pass: `task lint`
4. OllamaProvider is wired: grep for `case "ollama"` in providers.go returns match
</verification>

<success_criteria>
- OllamaProvider struct exists with BaseProvider embedding
- DefaultOllamaBaseURL is "http://localhost:11434"
- Constructor handles empty baseURL (uses default) and empty models (uses empty slice)
- Unit tests cover all Provider interface methods
- DI container creates OllamaProvider for type: "ollama"
- All tests pass, linters pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-additional-providers/05-01-SUMMARY.md`
</output>
