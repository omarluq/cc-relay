---
phase: 04-circuit-breaker-health
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - internal/health/config.go
  - internal/health/errors.go
  - internal/config/config.go
autonomous: true

must_haves:
  truths:
    - "Circuit breaker configuration loads from YAML without errors"
    - "Default values applied when config fields omitted"
    - "Health-related errors have typed sentinels for programmatic handling"
  artifacts:
    - path: "internal/health/config.go"
      provides: "CircuitBreakerConfig and HealthCheckConfig structs"
      exports: ["CircuitBreakerConfig", "HealthCheckConfig"]
    - path: "internal/health/errors.go"
      provides: "Health-related error sentinels"
      exports: ["ErrCircuitOpen", "ErrHealthCheckFailed"]
    - path: "internal/config/config.go"
      provides: "HealthConfig integration in main Config"
      contains: "Health.*HealthConfig"
  key_links:
    - from: "internal/config/config.go"
      to: "internal/health/config.go"
      via: "import and struct embedding"
      pattern: "health\\.HealthConfig|health\\.CircuitBreakerConfig"
---

<objective>
Create the foundation for health tracking: install sony/gobreaker library, define configuration structs for circuit breaker and health checks, and add health-related error types.

Purpose: Establish the configuration schema and error types that will be used by the circuit breaker state machine and health checker implementations in subsequent plans.

Output: New internal/health package with config.go and errors.go, gobreaker dependency installed, Config struct extended with HealthConfig.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-circuit-breaker-health/04-RESEARCH.md
@.planning/phases/04-circuit-breaker-health/04-CONTEXT.md
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sony/gobreaker and create health config structs</name>
  <files>
    go.mod
    go.sum
    internal/health/config.go
  </files>
  <action>
1. Install sony/gobreaker v2.4.0:
   ```bash
   go get github.com/sony/gobreaker/v2@v2.4.0
   ```

2. Create internal/health/config.go with:
   - Package doc explaining circuit breaker and health tracking purpose
   - CircuitBreakerConfig struct:
     - FailureThreshold int (yaml:"failure_threshold") - consecutive failures to open circuit, default 5
     - OpenDurationMS int (yaml:"open_duration_ms") - milliseconds before half-open, default 30000
     - HalfOpenProbes int (yaml:"half_open_probes") - probes allowed in half-open, default 3
   - HealthCheckConfig struct:
     - IntervalMS int (yaml:"interval_ms") - check interval during OPEN state, default 10000
     - Enabled bool (yaml:"enabled") - enable synthetic health checks, default true
   - HealthConfig struct combining both:
     - CircuitBreaker CircuitBreakerConfig (yaml:"circuit_breaker")
     - HealthCheck HealthCheckConfig (yaml:"health_check")
   - Helper methods:
     - (c *CircuitBreakerConfig) GetFailureThreshold() int - returns configured or default 5
     - (c *CircuitBreakerConfig) GetOpenDuration() time.Duration - returns duration from ms or default 30s
     - (c *CircuitBreakerConfig) GetHalfOpenProbes() int - returns configured or default 3
     - (c *HealthCheckConfig) GetInterval() time.Duration - returns duration from ms or default 10s
     - (c *HealthCheckConfig) IsEnabled() bool - returns Enabled (true by default if not set)

Use consistent patterns with existing config helpers (GetEffectiveStrategy, GetFailoverTimeoutOption).
  </action>
  <verify>
    - `go build ./...` passes
    - `grep "gobreaker/v2" go.mod` shows v2.4.0
  </verify>
  <done>
    - gobreaker v2.4.0 in go.mod
    - internal/health/config.go exists with all structs and methods
    - Package compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create health error types and integrate with main Config</name>
  <files>
    internal/health/errors.go
    internal/config/config.go
  </files>
  <action>
1. Create internal/health/errors.go with:
   - Package-level sentinel errors:
     - ErrCircuitOpen = errors.New("health: circuit breaker is open")
     - ErrHealthCheckFailed = errors.New("health: health check failed")
     - ErrProviderUnhealthy = errors.New("health: provider is unhealthy")
   - These will be used by circuit breaker and health checker implementations

2. Update internal/config/config.go:
   - Add import for "github.com/omarluq/cc-relay/internal/health"
   - Add Health field to Config struct:
     ```go
     type Config struct {
         Providers []ProviderConfig `yaml:"providers"`
         Routing   RoutingConfig    `yaml:"routing"`
         Logging   LoggingConfig    `yaml:"logging"`
         Server    ServerConfig     `yaml:"server"`
         Cache     cache.Config     `yaml:"cache"`
         Health    health.HealthConfig `yaml:"health"`  // NEW
     }
     ```

Note: Keep existing Config fields in same order, add Health at end before closing brace.
  </action>
  <verify>
    - `go build ./...` passes
    - `go test ./internal/health/... ./internal/config/...` passes
  </verify>
  <done>
    - internal/health/errors.go exists with sentinel errors
    - Config struct has Health field of type health.HealthConfig
    - Existing config tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for health config</name>
  <files>
    internal/health/config_test.go
  </files>
  <action>
Create internal/health/config_test.go with comprehensive tests:

1. TestCircuitBreakerConfig_GetFailureThreshold:
   - Zero value returns default 5
   - Custom value returns that value
   - Negative value returns default 5

2. TestCircuitBreakerConfig_GetOpenDuration:
   - Zero value returns default 30s
   - Custom value (e.g., 60000) returns 60s
   - Negative value returns default 30s

3. TestCircuitBreakerConfig_GetHalfOpenProbes:
   - Zero value returns default 3
   - Custom value returns that value
   - Negative value returns default 3

4. TestHealthCheckConfig_GetInterval:
   - Zero value returns default 10s
   - Custom value (e.g., 5000) returns 5s

5. TestHealthCheckConfig_IsEnabled:
   - Default (zero value) returns true
   - Explicit true returns true
   - Explicit false returns false

Use table-driven tests following existing config_test.go patterns.
  </action>
  <verify>
    - `go test -v ./internal/health/...` passes all tests
    - `go test -cover ./internal/health/...` shows >80% coverage
  </verify>
  <done>
    - internal/health/config_test.go exists
    - All tests pass
    - Coverage >80% for health package config
  </done>
</task>

</tasks>

<verification>
```bash
# All must pass
go build ./...
go test ./internal/health/... ./internal/config/...
grep "gobreaker/v2" go.mod
```
</verification>

<success_criteria>
1. sony/gobreaker v2.4.0 installed in go.mod
2. internal/health/config.go with CircuitBreakerConfig, HealthCheckConfig, HealthConfig
3. internal/health/errors.go with ErrCircuitOpen, ErrHealthCheckFailed, ErrProviderUnhealthy
4. Config struct in internal/config/config.go has Health field
5. All tests pass including existing config tests
6. Health config test coverage >80%
</success_criteria>

<output>
After completion, create `.planning/phases/04-circuit-breaker-health/04-01-SUMMARY.md`
</output>
