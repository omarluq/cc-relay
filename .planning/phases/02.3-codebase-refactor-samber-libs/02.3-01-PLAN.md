---
phase: 02.3-codebase-refactor-samber-libs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/cc-relay/serve_test.go
  - cmd/cc-relay/config_test.go
  - cmd/cc-relay/config_cc_test.go
  - cmd/cc-relay/status_test.go
  - internal/cache/olric_test.go
  - internal/cache/ristretto_test.go
  - internal/cache/factory_test.go
  - .planning/codebase/ARCHITECTURE.md
  - .planning/codebase/STRUCTURE.md
autonomous: true

must_haves:
  truths:
    - "cmd/cc-relay package has >80% test coverage"
    - "internal/cache package has >80% test coverage"
    - "All existing tests still pass"
    - "Codebase architecture is mapped and documented"
  artifacts:
    - path: "cmd/cc-relay/serve_test.go"
      provides: "Unit tests for serve command"
      min_lines: 100
    - path: "cmd/cc-relay/config_test.go"
      provides: "Unit tests for config commands"
      min_lines: 50
    - path: ".planning/codebase/ARCHITECTURE.md"
      provides: "Codebase architecture documentation"
      min_lines: 100
  key_links:
    - from: "cmd/cc-relay/serve_test.go"
      to: "cmd/cc-relay/serve.go"
      via: "function coverage"
      pattern: "func Test"
---

<objective>
Establish comprehensive test coverage baseline for low-coverage packages before refactoring, and map the codebase architecture.

Purpose: Refactoring without tests leads to silent regressions. The cmd package has only 13.6% coverage (the main gap), and internal/cache has 77.3%. These must be covered before any refactoring begins. Additionally, understanding the codebase architecture is essential for planning effective refactoring.
Output: Test files with >80% coverage for cmd/cc-relay and internal/cache packages, plus codebase architecture documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Source files to test
@cmd/cc-relay/serve.go
@cmd/cc-relay/config.go
@cmd/cc-relay/status.go
@internal/cache/olric.go
@internal/cache/ristretto.go
@internal/cache/factory.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Map codebase architecture and document structure</name>
  <files>
    .planning/codebase/ARCHITECTURE.md
    .planning/codebase/STRUCTURE.md
  </files>
  <action>
Create codebase architecture documentation using /gsd:map-codebase workflow or manual analysis:

1. ARCHITECTURE.md:
   - Package dependency graph (which packages import which)
   - Layer identification (delivery, application, infrastructure, domain)
   - Singleton services vs request-scoped services
   - Data flow diagrams for key paths (request routing, SSE streaming)
   - Circular dependency analysis (any import cycles)

2. STRUCTURE.md:
   - Directory structure with purposes
   - File naming conventions
   - Key files per package
   - Public API surface per package

3. Identify refactoring targets:
   - God objects (structs with too many responsibilities)
   - Long functions (cognitive complexity hotspots)
   - Code smells (duplicated code, magic strings)

Run: `go list -m -json all` for dependency graph
Run: `golangci-lint run --enable=gocognit --max-same-issues 0 ./...` for complexity
  </action>
  <verify>
ARCHITECTURE.md exists with package dependency graph
STRUCTURE.md exists with directory documentation
Run: `ls .planning/codebase/*.md` shows both files
  </verify>
  <done>Codebase architecture mapped and documented for refactoring planning</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for cmd/cc-relay package</name>
  <files>
    cmd/cc-relay/serve_test.go
    cmd/cc-relay/config_test.go
    cmd/cc-relay/config_cc_test.go
    cmd/cc-relay/status_test.go
  </files>
  <action>
Create characterization tests for cmd/cc-relay package to achieve >80% coverage:

1. serve_test.go:
   - Test runServe() with mock config (use httptest.Server pattern)
   - Test server startup and graceful shutdown
   - Test signal handling (SIGINT, SIGTERM)
   - Test invalid config path error handling
   - Use table-driven tests for different config scenarios

2. config_test.go:
   - Test config validate command with valid/invalid configs
   - Test config path resolution (--config flag, default paths)
   - Test error messages for missing files

3. config_cc_test.go:
   - Test Claude Code config integration
   - Test init and remove subcommands

4. status_test.go:
   - Test status command output
   - Test connection failure handling

Use Go standard testing patterns (no external assertion library yet - that's a later task).
Mock external dependencies (HTTP server, file system) using interfaces.
  </action>
  <verify>
Run: `go test -cover ./cmd/cc-relay/`
Coverage should be >80% of statements.
  </verify>
  <done>cmd/cc-relay package coverage increased from 13.6% to >80%</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for internal/cache package gaps</name>
  <files>
    internal/cache/olric_test.go
    internal/cache/ristretto_test.go
    internal/cache/factory_test.go
  </files>
  <action>
Expand test coverage for internal/cache package from 77.3% to >80%:

1. olric_test.go:
   - Test embedded Olric initialization with various configs
   - Test cluster joining scenarios (success, failure, retry)
   - Test ClusterInfo methods (safe defaults when stats unavailable)
   - Test graceful shutdown behavior
   - Use integration build tag for actual cluster tests

2. ristretto_test.go:
   - Test cache operations (Get, Set, Delete)
   - Test TTL expiration behavior
   - Test concurrent access patterns
   - Test memory limits and eviction

3. factory_test.go:
   - Test factory with different backend types
   - Test fallback to noop cache on errors
   - Test invalid config handling

Focus on error paths and edge cases that aren't currently covered.
  </action>
  <verify>
Run: `go test -cover ./internal/cache/`
Coverage should be >80% of statements.
  </verify>
  <done>internal/cache package coverage increased from 77.3% to >80%</done>
</task>

</tasks>

<verification>
1. `go test -race -cover ./...` passes with all packages at >80% coverage
2. No race conditions detected
3. .planning/codebase/ARCHITECTURE.md exists with documented architecture
4. .planning/codebase/STRUCTURE.md exists with directory documentation
5. Git shows only new/modified test files and codebase docs (no production code changes)
</verification>

<success_criteria>
- Codebase architecture documented (ARCHITECTURE.md, STRUCTURE.md)
- cmd/cc-relay coverage: 13.6% -> >80%
- internal/cache coverage: 77.3% -> >80%
- All other packages maintain current coverage
- Zero test failures
- Zero race conditions
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-01-SUMMARY.md`
</output>
