---
phase: 02.3-codebase-refactor-samber-libs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/cc-relay/serve_test.go
  - cmd/cc-relay/config_test.go
  - cmd/cc-relay/config_cc_test.go
  - cmd/cc-relay/status_test.go
  - internal/cache/olric_test.go
  - internal/cache/ristretto_test.go
autonomous: true

must_haves:
  truths:
    - "cmd/cc-relay package has >80% test coverage"
    - "internal/cache package has >80% test coverage"
    - "All existing tests still pass"
  artifacts:
    - path: "cmd/cc-relay/serve_test.go"
      provides: "Unit tests for serve command"
      min_lines: 100
    - path: "cmd/cc-relay/config_test.go"
      provides: "Unit tests for config commands"
      min_lines: 50
  key_links:
    - from: "cmd/cc-relay/serve_test.go"
      to: "cmd/cc-relay/serve.go"
      via: "function coverage"
      pattern: "func Test"
---

<objective>
Establish comprehensive test coverage baseline for low-coverage packages before refactoring.

Purpose: Refactoring without tests leads to silent regressions. The cmd package has only 13.6% coverage (the main gap), and internal/cache has 77.3%. These must be covered before any refactoring begins.
Output: Test files with >80% coverage for cmd/cc-relay and internal/cache packages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Source files to test
@cmd/cc-relay/serve.go
@cmd/cc-relay/config.go
@cmd/cc-relay/status.go
@internal/cache/olric.go
@internal/cache/ristretto.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for cmd/cc-relay package</name>
  <files>
    cmd/cc-relay/serve_test.go
    cmd/cc-relay/config_test.go
    cmd/cc-relay/config_cc_test.go
    cmd/cc-relay/status_test.go
  </files>
  <action>
Create characterization tests for cmd/cc-relay package to achieve >80% coverage:

1. serve_test.go:
   - Test runServe() with mock config (use httptest.Server pattern)
   - Test server startup and graceful shutdown
   - Test signal handling (SIGINT, SIGTERM)
   - Test invalid config path error handling
   - Use table-driven tests for different config scenarios

2. config_test.go:
   - Test config validate command with valid/invalid configs
   - Test config path resolution (--config flag, default paths)
   - Test error messages for missing files

3. config_cc_test.go:
   - Test Claude Code config integration
   - Test init and remove subcommands

4. status_test.go:
   - Test status command output
   - Test connection failure handling

Use Go standard testing patterns (no external assertion library yet - that's a later task).
Mock external dependencies (HTTP server, file system) using interfaces.
  </action>
  <verify>
Run: `go test -cover ./cmd/cc-relay/`
Coverage should be >80% of statements.
  </verify>
  <done>cmd/cc-relay package coverage increased from 13.6% to >80%</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for internal/cache package gaps</name>
  <files>
    internal/cache/olric_test.go
    internal/cache/ristretto_test.go
    internal/cache/factory_test.go
  </files>
  <action>
Expand test coverage for internal/cache package from 77.3% to >80%:

1. olric_test.go:
   - Test embedded Olric initialization with various configs
   - Test cluster joining scenarios (success, failure, retry)
   - Test ClusterInfo methods (safe defaults when stats unavailable)
   - Test graceful shutdown behavior
   - Use integration build tag for actual cluster tests

2. ristretto_test.go:
   - Test cache operations (Get, Set, Delete)
   - Test TTL expiration behavior
   - Test concurrent access patterns
   - Test memory limits and eviction

3. factory_test.go:
   - Test factory with different backend types
   - Test fallback to noop cache on errors
   - Test invalid config handling

Focus on error paths and edge cases that aren't currently covered.
  </action>
  <verify>
Run: `go test -cover ./internal/cache/`
Coverage should be >80% of statements.
  </verify>
  <done>internal/cache package coverage increased from 77.3% to >80%</done>
</task>

<task type="auto">
  <name>Task 3: Verify all tests pass and document baseline</name>
  <files>
    .planning/phases/02.3-codebase-refactor-samber-libs/COVERAGE_BASELINE.md
  </files>
  <action>
1. Run full test suite with race detector:
   `go test -race -cover ./...`

2. Generate coverage profile:
   `go test -coverprofile=coverage.out ./...`

3. Create COVERAGE_BASELINE.md documenting:
   - Per-package coverage percentages (before/after)
   - Total lines of test code added
   - Any tests that needed fixes
   - Coverage gaps that remain (and why acceptable)

4. Verify no regressions:
   - All existing tests must still pass
   - No new race conditions detected
  </action>
  <verify>
Run: `go test -race ./...` - all tests pass
Run: `go test -cover ./...` - all packages >80% (except version which is already 100%)
  </verify>
  <done>All tests pass, coverage baseline documented, ready for refactoring</done>
</task>

</tasks>

<verification>
1. `go test -race -cover ./...` passes with all packages at >80% coverage
2. No race conditions detected
3. COVERAGE_BASELINE.md exists with documented metrics
4. Git shows only new/modified test files (no production code changes)
</verification>

<success_criteria>
- cmd/cc-relay coverage: 13.6% -> >80%
- internal/cache coverage: 77.3% -> >80%
- All other packages maintain current coverage
- Zero test failures
- Zero race conditions
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-01-SUMMARY.md`
</output>
