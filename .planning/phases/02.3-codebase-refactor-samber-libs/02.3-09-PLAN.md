---
phase: 02.3-codebase-refactor-samber-libs
plan: 09
type: execute
wave: 6
depends_on: ["02.3-07"]
files_modified:
  - .golangci.yml
  - internal/proxy/handler.go
  - internal/keypool/pool.go
  - cmd/cc-relay/serve.go
  - .planning/phases/02.3-codebase-refactor-samber-libs/TECH_DEBT_AUDIT.md
autonomous: true

must_haves:
  truths:
    - "Golangci-lint strictness increased (gocognit reduced)"
    - "High cognitive complexity functions refactored"
    - "Tech debt audit documented with before/after"
  artifacts:
    - path: ".planning/phases/02.3-codebase-refactor-samber-libs/TECH_DEBT_AUDIT.md"
      provides: "Tech debt audit findings and resolutions"
      min_lines: 100
    - path: ".golangci.yml"
      provides: "Stricter linter configuration"
      contains: "gocognit"
  key_links:
    - from: ".golangci.yml"
      to: "internal/*/*.go"
      via: "linting rules"
      pattern: "gocognit.*10"
---

<objective>
Audit and fix tech debt identified during refactoring - increase linter strictness and reduce cognitive complexity.

Purpose: With samber libraries integrated, the codebase is cleaner. Now increase linter strictness to catch future issues. Identify and fix remaining tech debt (long functions, god objects, inconsistent patterns).
Output: Stricter golangci-lint config, refactored high-complexity functions, documented tech debt audit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-CONTEXT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-RESEARCH.md
@.planning/codebase/CONCERNS.md

# Linter config
@.golangci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run tech debt audit and document findings</name>
  <files>
    .planning/phases/02.3-codebase-refactor-samber-libs/TECH_DEBT_AUDIT.md
  </files>
  <action>
Comprehensive tech debt audit:

1. Run cognitive complexity analysis:
   ```bash
   golangci-lint run --enable=gocognit --max-same-issues 0 ./...
   ```

2. Run cyclomatic complexity analysis:
   ```bash
   golangci-lint run --enable=gocyclo --max-same-issues 0 ./...
   ```

3. Run full linter suite with all checks:
   ```bash
   golangci-lint run --enable-all --disable=exhaustruct,varnamelen,forbidigo ./...
   ```

4. Identify issues by category:
   - High cognitive complexity (>15) functions
   - High cyclomatic complexity (>10) functions
   - Long functions (>50 lines)
   - God objects (structs with >10 methods)
   - Error handling inconsistencies
   - Dead code / unused exports
   - Missing error checks

5. Create TECH_DEBT_AUDIT.md with:
   - Summary of findings
   - List of high-priority fixes (must fix)
   - List of medium-priority fixes (should fix)
   - List of low-priority fixes (nice to fix)
   - Files sorted by debt severity

Format:
```markdown
# Tech Debt Audit

## Summary
- X high-complexity functions identified
- Y linter violations found
- Z patterns need improvement

## High Priority (Must Fix)

### internal/proxy/handler.go
- Function ServeHTTP: cognitive complexity 22 (target: <15)
- Suggested fix: Extract middleware logic to separate functions

## Medium Priority (Should Fix)
...

## Low Priority (Nice to Fix)
...
```
  </action>
  <verify>
TECH_DEBT_AUDIT.md exists with categorized findings
All high-complexity functions identified
Suggested fixes documented
  </verify>
  <done>Tech debt audit complete and documented</done>
</task>

<task type="auto">
  <name>Task 2: Fix high-priority tech debt issues</name>
  <files>
    internal/proxy/handler.go
    internal/keypool/pool.go
    internal/config/config.go
    cmd/cc-relay/serve.go
  </files>
  <action>
Fix high-priority issues from audit:

1. Reduce cognitive complexity:
   - Extract helper functions from long methods
   - Use early returns instead of deep nesting
   - Apply lo patterns to simplify loops
   - Use mo.Result to flatten error handling

2. Common refactoring patterns:
   ```go
   // Before: Deep nesting
   func Process(x *X) error {
       if x != nil {
           if x.Valid {
               if x.Ready {
                   // actual logic
               }
           }
       }
   }

   // After: Early returns
   func Process(x *X) error {
       if x == nil {
           return ErrNilInput
       }
       if !x.Valid {
           return ErrInvalid
       }
       if !x.Ready {
           return ErrNotReady
       }
       // actual logic
   }
   ```

3. Extract functions:
   ```go
   // Before: 80-line function
   func BigFunction() {
       // validation
       // processing
       // formatting
       // output
   }

   // After: Focused functions
   func BigFunction() {
       input := validate()
       result := process(input)
       output := format(result)
       return output
   }
   ```

4. Target: Reduce gocognit threshold from 20 to 15 for all functions.

5. Run tests after each refactoring to catch regressions.
  </action>
  <verify>
Run: `golangci-lint run --enable=gocognit ./...` - no functions >15 complexity
Run: `go test -race ./...` - all tests pass
  </verify>
  <done>High-priority tech debt fixed, complexity reduced</done>
</task>

<task type="auto">
  <name>Task 3: Increase linter strictness</name>
  <files>
    .golangci.yml
  </files>
  <action>
Update .golangci.yml for stricter enforcement:

1. Reduce complexity thresholds:
   ```yaml
   linters-settings:
     gocognit:
       min-complexity: 15  # Reduced from 20
     gocyclo:
       min-complexity: 10  # Reduced from 15
     funlen:
       lines: 60           # Max function length
       statements: 40
   ```

2. Enable additional linters:
   ```yaml
   linters:
     enable:
       - gocognit
       - gocyclo
       - funlen
       - gocritic
       - gosec
       - errcheck
       - staticcheck
       - unused
       - ineffassign
       - misspell
       - unconvert
       - dupl           # Duplicate code detection
       - goconst        # Repeated strings -> constants
       - prealloc       # Slice preallocation suggestions
     disable:
       - exhaustruct    # Too noisy
       - varnamelen     # Conflicts with Go conventions
       - forbidigo      # We need fmt.Printf for CLI
   ```

3. Run linter and fix remaining issues:
   ```bash
   golangci-lint run --fix ./...
   ```

4. Verify CI will pass:
   ```bash
   task lint
   ```

5. Document any disabled checks with reasons in .golangci.yml comments.
  </action>
  <verify>
Run: `task lint` - passes with stricter config
Run: `go test ./...` - all tests pass
No new linter violations introduced
  </verify>
  <done>Linter strictness increased, all checks pass</done>
</task>

</tasks>

<verification>
1. TECH_DEBT_AUDIT.md exists with comprehensive findings
2. `golangci-lint run ./...` passes with stricter config
3. No function has cognitive complexity >15
4. `go test -race ./...` passes
5. .golangci.yml has reduced thresholds
</verification>

<success_criteria>
- Tech debt audit documented
- High-complexity functions refactored (gocognit <15)
- .golangci.yml strictness increased
- All linters pass
- All tests pass
- Zero warnings in CI lint run
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-09-SUMMARY.md`
</output>
