---
phase: 02.3-codebase-refactor-samber-libs
plan: 08
type: execute
wave: 5
depends_on: ["02.3-07"]
files_modified:
  - .claude/agents/loop-to-lo.md
  - .claude/agents/error-to-result.md
  - .claude/agents/inject-di.md
  - .claude/skills/di-patterns.md
  - .claude/skills/error-handling.md
  - .claude/skills/collections.md
autonomous: true

must_haves:
  truths:
    - "Three refactoring agents created for samber patterns"
    - "Pattern-focused skills complement library reference skills"
    - "Agents and skills are generic + reusable with cc-relay examples"
  artifacts:
    - path: ".claude/agents/loop-to-lo.md"
      provides: "Agent for converting loops to lo functions"
      min_lines: 80
    - path: ".claude/agents/error-to-result.md"
      provides: "Agent for converting error tuples to Result"
      min_lines: 80
    - path: ".claude/skills/di-patterns.md"
      provides: "DI patterns and best practices"
      min_lines: 100
  key_links:
    - from: ".claude/agents/loop-to-lo.md"
      to: ".claude/skills/samber-lo.md"
      via: "reference"
      pattern: "@.claude/skills/samber-lo.md"
---

<objective>
Create specialized refactoring agents and pattern-focused skills for samber library adoption.

Purpose: Capture knowledge from this refactoring phase in reusable agents and skills. Future sessions can use these to maintain consistency and extend patterns. Agents automate common refactoring tasks.
Output: Three agents (loop-to-lo, error-to-result, inject-di) and three pattern skills (di-patterns, error-handling, collections).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-CONTEXT.md

# Reference existing skills for patterns
@.claude/skills/samber-lo.md
@.claude/skills/samber-mo.md
@.claude/skills/samber-do.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create refactoring agents</name>
  <files>
    .claude/agents/loop-to-lo.md
    .claude/agents/error-to-result.md
    .claude/agents/inject-di.md
  </files>
  <action>
Create three specialized refactoring agents:

1. **.claude/agents/loop-to-lo.md:**
   - Purpose: Convert imperative for-range loops to lo functions
   - Input: File path or code snippet with loops
   - Process:
     1. Identify loop pattern (filter, map, reduce, find)
     2. Select appropriate lo function
     3. Convert while preserving behavior
     4. Run tests to verify
   - Patterns covered:
     - Append-based filtering -> lo.Filter
     - Transform-append -> lo.Map
     - Accumulation -> lo.Reduce
     - Search -> lo.Find / lo.FindOrElse
     - Min/Max finding -> lo.MinBy / lo.MaxBy
   - Reference: @.claude/skills/samber-lo.md
   - Output: Refactored code with test verification

2. **.claude/agents/error-to-result.md:**
   - Purpose: Convert (value, error) tuples to mo.Result[T]
   - Input: Function or code block with error handling
   - Process:
     1. Identify error-returning functions
     2. Convert to Result pattern
     3. Chain with FlatMap where applicable
     4. Update tests
   - Patterns covered:
     - Simple conversion: mo.TupleToResult
     - Chained calls: FlatMap composition
     - Error creation: mo.Err[T](error)
     - Success: mo.Ok(value)
   - Reference: @.claude/skills/samber-mo.md
   - Anti-patterns to avoid: Immediate unwrapping with MustGet

3. **.claude/agents/inject-di.md:**
   - Purpose: Wire services into DI container
   - Input: Service struct that needs DI registration
   - Process:
     1. Identify dependencies (constructor parameters)
     2. Create provider function
     3. Register with do.Provide
     4. Update callers to use do.Invoke
   - Patterns covered:
     - Singleton registration
     - Transient registration
     - Scoped services
   - Reference: @.claude/skills/samber-do.md
  </action>
  <verify>
Agent files exist at specified paths
Each agent has clear input/process/output structure
Agents reference appropriate skill files
  </verify>
  <done>Three refactoring agents created</done>
</task>

<task type="auto">
  <name>Task 2: Create pattern-focused skills</name>
  <files>
    .claude/skills/di-patterns.md
    .claude/skills/error-handling.md
    .claude/skills/collections.md
  </files>
  <action>
Create pattern-focused skills (complement library reference skills):

1. **.claude/skills/di-patterns.md:**
   - When to use DI vs direct instantiation
   - Singleton vs Transient vs Scoped lifecycle
   - Request-scoped services pattern (with cc-relay middleware example)
   - Testing with DI (mocking, test containers)
   - Common mistakes:
     - Storing request data in singletons
     - Circular dependencies
     - Over-using DI for simple values
   - cc-relay examples: Container setup, provider registration

2. **.claude/skills/error-handling.md:**
   - Traditional Go vs Monadic error handling
   - When to use Result[T] (chains benefit)
   - When to use Option[T] (nullable fields)
   - API boundary pattern (convert at edges)
   - Testing error flows with Result
   - Common mistakes:
     - Mixing styles inconsistently
     - Ignoring error info in Err
     - Using MustGet without IsOk check
   - cc-relay examples: Auth chain, config loading

3. **.claude/skills/collections.md:**
   - When functional style improves readability
   - When imperative loops are clearer
   - Performance considerations (intermediate allocations)
   - Parallel variants for large datasets
   - Common patterns:
     - Filter+Map -> FilterMap (single pass)
     - GroupBy for organizing
     - Reduce for aggregation
   - cc-relay examples: Key filtering, provider mapping
  </action>
  <verify>
Skill files exist at specified paths
Each skill has practical examples from cc-relay
Skills complement (not duplicate) library reference skills
  </verify>
  <done>Three pattern-focused skills created</done>
</task>

<task type="auto">
  <name>Task 3: Update INDEX.md and verify skill/agent integration</name>
  <files>
    .claude/INDEX.md
    .claude/SKILLS_SUMMARY.md
    .claude/agents/README.md
  </files>
  <action>
Update documentation to include new agents and skills:

1. Update .claude/INDEX.md:
   - Add section for samber library skills
   - Add section for refactoring agents
   - Include usage examples

2. Update .claude/SKILLS_SUMMARY.md:
   - Add entries for new skills:
     - samber-lo.md, samber-mo.md, samber-do.md, samber-ro.md
     - di-patterns.md, error-handling.md, collections.md
   - Brief description of each

3. Update .claude/agents/README.md:
   - Add entries for new agents:
     - loop-to-lo.md
     - error-to-result.md
     - inject-di.md
   - Usage examples

4. Test agent invocation:
   - Verify agents can be referenced with @.claude/agents/loop-to-lo.md
   - Verify skills can be loaded

5. Cross-reference check:
   - Agents reference appropriate skills
   - Skills reference each other where relevant
   - No broken links
  </action>
  <verify>
INDEX.md includes new skills and agents
README files updated
Cross-references work correctly
  </verify>
  <done>Documentation updated, skills and agents integrated</done>
</task>

</tasks>

<verification>
1. Three agent files exist in .claude/agents/
2. Three pattern skill files exist in .claude/skills/
3. Four library skill files exist from Plan 02
4. INDEX.md updated with new entries
5. agents/README.md updated
6. SKILLS_SUMMARY.md updated
</verification>

<success_criteria>
- 3 refactoring agents created (loop-to-lo, error-to-result, inject-di)
- 3 pattern skills created (di-patterns, error-handling, collections)
- 4 library skills from Plan 02 (samber-lo, samber-mo, samber-do, samber-ro)
- All documentation updated
- Agents and skills are generic with cc-relay examples (reusable in other projects)
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-08-SUMMARY.md`
</output>
