---
phase: 02.3-codebase-refactor-samber-libs
plan: 08
type: execute
wave: 8
depends_on: ["02.3-07b"]
files_modified:
  - .claude/agents/loop-to-lo.md
  - .claude/agents/error-to-result.md
  - .claude/agents/inject-di.md
  - .claude/skills/di-patterns.md
  - .claude/skills/error-handling.md
  - .claude/skills/collections.md
  - .claude/skills/streams.md
autonomous: true

must_haves:
  truths:
    - "Three refactoring agents created for automated code transformation"
    - "Four pattern skills document established patterns"
    - "Skills reference cc-relay code as examples"
  artifacts:
    - path: ".claude/agents/loop-to-lo.md"
      provides: "Agent for converting loops to lo functions"
      min_lines: 50
    - path: ".claude/agents/error-to-result.md"
      provides: "Agent for converting errors to Result monad"
      min_lines: 50
    - path: ".claude/skills/di-patterns.md"
      provides: "DI patterns skill with cc-relay examples"
      min_lines: 80
    - path: ".claude/skills/streams.md"
      provides: "Reactive streams patterns with ro"
      min_lines: 60
  key_links:
    - from: ".claude/agents/loop-to-lo.md"
      to: ".claude/skills/samber-lo.md"
      via: "reference"
      pattern: "@.claude/skills/samber-lo.md"
---

<objective>
Create specialized refactoring agents and pattern-focused skills that capture knowledge from this refactoring phase.

Purpose: Agents automate repetitive refactoring tasks. Pattern skills document established patterns for future Claude sessions. Both reference cc-relay code as real-world examples.
Output: Three refactoring agents and four pattern skills in .claude/ directory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-CONTEXT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-RESEARCH.md

# Existing library skills for reference
@.claude/skills/samber-lo.md
@.claude/skills/samber-mo.md
@.claude/skills/samber-do.md
@.claude/skills/samber-ro.md

# Refactored code for examples
@internal/keypool/pool.go
@internal/auth/chain.go
@cmd/cc-relay/di/providers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create refactoring agents</name>
  <files>
    .claude/agents/loop-to-lo.md
    .claude/agents/error-to-result.md
    .claude/agents/inject-di.md
  </files>
  <action>
Create specialized refactoring agents:

1. **.claude/agents/loop-to-lo.md:**
   - Purpose: Automatically convert for-range loops to lo functions
   - Input: Go file path or package path
   - Process:
     1. Find all for-range loops in target
     2. Classify by pattern (filter, map, reduce, find)
     3. Convert to appropriate lo function
     4. Run tests to verify
   - Reference: @.claude/skills/samber-lo.md
   - Examples from cc-relay keypool/pool.go

2. **.claude/agents/error-to-result.md:**
   - Purpose: Convert (value, error) tuples to mo.Result[T]
   - Input: Go file path with functions to convert
   - Process:
     1. Identify functions returning (T, error)
     2. Convert to mo.Result[T] return type
     3. Update call sites to use FlatMap/Match
     4. Run tests to verify
   - Reference: @.claude/skills/samber-mo.md
   - Examples from cc-relay auth/chain.go

3. **.claude/agents/inject-di.md:**
   - Purpose: Wire new services into DI container
   - Input: Service interface/struct to register
   - Process:
     1. Create provider function in di/providers.go
     2. Register with do.Provide
     3. Identify dependencies, add to provider
     4. Add tests
   - Reference: @.claude/skills/samber-do.md
   - Examples from cc-relay cmd/cc-relay/di/
  </action>
  <verify>
All three agent files exist in .claude/agents/
Each agent has clear purpose, input, process, verification
  </verify>
  <done>Refactoring agents created</done>
</task>

<task type="auto">
  <name>Task 2: Create pattern-focused skills</name>
  <files>
    .claude/skills/di-patterns.md
    .claude/skills/error-handling.md
    .claude/skills/collections.md
    .claude/skills/streams.md
  </files>
  <action>
Create pattern skills that document established patterns:

1. **.claude/skills/di-patterns.md:**
   - Singleton vs transient services
   - Request-scoped services with do.NewScope
   - Lifecycle management (shutdown hooks)
   - cc-relay examples from di/providers.go
   - When to use DI vs direct construction
   - Anti-patterns (circular deps, storing request data in singletons)

2. **.claude/skills/error-handling.md:**
   - mo.Result[T] vs (value, error) decision guide
   - Railway-Oriented Programming patterns
   - Error chaining with FlatMap
   - Pattern matching with Match
   - Converting at API boundaries
   - cc-relay examples from auth/chain.go

3. **.claude/skills/collections.md:**
   - lo function selection guide
   - Common transformations (Map, Filter, Reduce)
   - Performance considerations (parallel variants, single-pass)
   - When NOT to use lo (simple loops)
   - cc-relay examples from keypool/pool.go

4. **.claude/skills/streams.md:**
   - samber/ro reactive stream patterns
   - Observable creation (ro.Just, ro.FromChannel, ro.FromSlice)
   - Operators (ro.Map, ro.Filter, ro.Pipe, ro.Catch)
   - Subscription patterns (OnNext, OnError, OnComplete)
   - When to use streams (SSE, websockets, events)
   - When NOT to use streams (simple request/response)
   - Note about ro v0.2.0 stability
   - Future cc-relay examples (SSE streaming preparation)
  </action>
  <verify>
All four skill files exist in .claude/skills/
Each skill has practical patterns with cc-relay examples
  </verify>
  <done>Pattern skills created with cc-relay examples</done>
</task>

<task type="auto">
  <name>Task 3: Verify agent and skill integration</name>
  <files>
    (no new files - verification only)
  </files>
  <action>
Verify agents and skills work together:

1. Test loop-to-lo agent workflow:
   - Identify a file with remaining loops
   - Mentally trace agent instructions
   - Verify transformation would be correct

2. Test error-to-result agent workflow:
   - Identify a function with (T, error) return
   - Mentally trace agent instructions
   - Verify Result conversion would be correct

3. Test inject-di agent workflow:
   - Consider adding a new service
   - Mentally trace agent instructions
   - Verify DI wiring would be correct

4. Cross-reference skills:
   - Verify agents reference appropriate skills
   - Verify skills have concrete cc-relay examples
   - Verify patterns are consistent across skills

5. Ensure CONTEXT.md requirements met:
   - Library reference skills: samber-lo.md, samber-do.md, samber-ro.md, samber-mo.md
   - Pattern-focused skills: di-patterns.md, error-handling.md, collections.md, streams.md
   - Specialized agents: loop-to-lo, error-to-result, inject-di
  </action>
  <verify>
All agents reference correct skills
All skills have cc-relay examples
Pattern documentation is consistent
  </verify>
  <done>Agents and skills verified working together</done>
</task>

</tasks>

<verification>
1. Three agent files exist in .claude/agents/
2. Four pattern skill files exist in .claude/skills/
3. Agents reference appropriate library skills
4. Skills contain cc-relay code examples
5. Documentation is consistent across agents and skills
</verification>

<success_criteria>
- loop-to-lo agent can guide loop-to-lo conversions
- error-to-result agent can guide error handling conversion
- inject-di agent can guide DI wiring
- di-patterns.md documents DI patterns with examples
- error-handling.md documents Result/Option patterns
- collections.md documents lo patterns
- streams.md documents ro reactive patterns
- All reference cc-relay code as examples
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-08-SUMMARY.md`
</output>
