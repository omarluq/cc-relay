---
phase: 02.3-codebase-refactor-samber-libs
plan: 10
type: execute
wave: 7
depends_on: ["02.3-08", "02.3-09"]
files_modified:
  - internal/keypool/pool_property_test.go
  - internal/ratelimit/limiter_property_test.go
  - internal/auth/chain_property_test.go
autonomous: true

must_haves:
  truths:
    - "Property-based tests added for complex logic"
    - "All packages maintain >80% coverage"
    - "All existing tests continue to pass"
  artifacts:
    - path: "internal/keypool/pool_property_test.go"
      provides: "Property tests for key selection"
      contains: "gopter"
      min_lines: 80
    - path: "internal/ratelimit/limiter_property_test.go"
      provides: "Property tests for rate limiting"
      contains: "gopter"
      min_lines: 80
  key_links:
    - from: "internal/keypool/pool_property_test.go"
      to: "internal/keypool/pool.go"
      via: "property verification"
      pattern: "prop\\.ForAll"
---

<objective>
Add property-based tests for complex logic to catch edge cases that example-based tests miss.

Purpose: Property-based testing generates hundreds of random inputs to verify invariants hold. Rate limiters, key selectors, and auth flows have complex state - property tests find edge cases that humans miss.
Output: Property tests for keypool, ratelimit, and auth packages using gopter.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-RESEARCH.md

# Source files to test with properties
@internal/keypool/pool.go
@internal/ratelimit/limiter.go
@internal/ratelimit/token_bucket.go
@internal/auth/chain.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add property tests for keypool package</name>
  <files>
    internal/keypool/pool_property_test.go
    internal/keypool/selector_property_test.go
  </files>
  <action>
Create property-based tests for key selection:

1. pool_property_test.go:
   ```go
   package keypool_test

   import (
       "testing"
       "github.com/leanovate/gopter"
       "github.com/leanovate/gopter/gen"
       "github.com/leanovate/gopter/prop"
   )

   func TestKeyPool_Properties(t *testing.T) {
       properties := gopter.NewProperties(nil)

       // Property 1: GetKey always returns a key or error, never hangs
       properties.Property("GetKey terminates", prop.ForAll(
           func(keyCount int) bool {
               pool := createTestPool(keyCount)
               _, err := pool.GetKey()
               return err != nil || true // Always terminates
           },
           gen.IntRange(0, 100),
       ))

       // Property 2: Selected key is always in the pool
       properties.Property("selected key belongs to pool", prop.ForAll(
           func(keyCount int) bool {
               if keyCount == 0 { return true } // Skip empty pools
               pool := createTestPoolWithKeys(keyCount)
               key, err := pool.GetKey()
               if err != nil { return true }
               return pool.ContainsKey(key.ID)
           },
           gen.IntRange(1, 50),
       ))

       // Property 3: Exhausted keys are not selected
       properties.Property("exhausted keys skipped", prop.ForAll(
           func(keyCount int) bool {
               // Create pool, exhaust some keys, verify selection
           },
           gen.IntRange(2, 20),
       ))

       properties.TestingRun(t)
   }
   ```

2. selector_property_test.go:
   - LeastLoaded always selects key with lowest load
   - RoundRobin distributes evenly over N iterations
   - Selection is deterministic for same input state

3. Custom generators:
   ```go
   func genKeyConfig() gopter.Gen {
       return gen.Struct(reflect.TypeOf(KeyConfig{}), map[string]gopter.Gen{
           "Key":       gen.AlphaString(),
           "RPMLimit":  gen.IntRange(1, 10000),
           "ITPMLimit": gen.IntRange(1000, 1000000),
       })
   }
   ```
  </action>
  <verify>
Run: `go test -v ./internal/keypool/...` - property tests pass
Run: `go test -cover ./internal/keypool/` - coverage maintained
  </verify>
  <done>Property tests added for keypool</done>
</task>

<task type="auto">
  <name>Task 2: Add property tests for ratelimit package</name>
  <files>
    internal/ratelimit/limiter_property_test.go
    internal/ratelimit/token_bucket_property_test.go
  </files>
  <action>
Create property-based tests for rate limiting:

1. limiter_property_test.go:
   ```go
   func TestRateLimiter_Properties(t *testing.T) {
       properties := gopter.NewProperties(nil)

       // Property 1: Rate limiter never allows more than limit in a burst
       properties.Property("respects burst limit", prop.ForAll(
           func(limit int) bool {
               if limit <= 0 { return true }
               limiter := ratelimit.NewTokenBucket(limit, limit)

               allowed := 0
               for i := 0; i < limit*2; i++ {
                   if limiter.Allow() {
                       allowed++
                   }
               }

               return allowed <= limit
           },
           gen.IntRange(1, 1000),
       ))

       // Property 2: After waiting, tokens replenish
       properties.Property("tokens replenish over time", prop.ForAll(
           func(limit int) bool {
               // Exhaust, wait, verify replenishment
           },
           gen.IntRange(10, 100),
       ))

       // Property 3: ConsumeTokens reduces available correctly
       properties.Property("ConsumeTokens reduces availability", prop.ForAll(
           func(tokens int) bool {
               limiter := ratelimit.NewTokenBucket(1000, 1000)
               before := limiter.Available()
               limiter.ConsumeTokens(tokens)
               after := limiter.Available()
               return after <= before
           },
           gen.IntRange(1, 500),
       ))

       properties.TestingRun(t)
   }
   ```

2. Test concurrent access properties:
   - Concurrent Allow() calls don't exceed limit
   - No race conditions (run with -race)
  </action>
  <verify>
Run: `go test -v ./internal/ratelimit/...` - property tests pass
Run: `go test -race ./internal/ratelimit/` - no race conditions
  </verify>
  <done>Property tests added for ratelimit</done>
</task>

<task type="auto">
  <name>Task 3: Add property tests for auth and final verification</name>
  <files>
    internal/auth/chain_property_test.go
  </files>
  <action>
Create property-based tests for auth chain and run final verification:

1. chain_property_test.go:
   ```go
   func TestAuthChain_Properties(t *testing.T) {
       properties := gopter.NewProperties(nil)

       // Property 1: Valid keys always authenticate
       properties.Property("valid keys authenticate", prop.ForAll(
           func(key string) bool {
               if key == "" { return true }
               chain := createChainWithKey(key)
               req := createRequestWithKey(key)
               result := chain.Authenticate(req)
               return result.IsOk()
           },
           gen.AlphaString().SuchThat(func(s string) bool { return len(s) > 0 }),
       ))

       // Property 2: Invalid keys always fail
       properties.Property("invalid keys fail", prop.ForAll(
           func(validKey, invalidKey string) bool {
               if validKey == invalidKey { return true }
               chain := createChainWithKey(validKey)
               req := createRequestWithKey(invalidKey)
               result := chain.Authenticate(req)
               return result.IsErr()
           },
           gen.AlphaString(), gen.AlphaString(),
       ))

       properties.TestingRun(t)
   }
   ```

2. Final verification across entire codebase:
   ```bash
   go test -v -race ./...
   go test -cover ./...
   ```

3. Generate coverage report:
   ```bash
   go test -coverprofile=coverage.out ./...
   go tool cover -func=coverage.out
   ```

4. Document final coverage numbers in summary.
  </action>
  <verify>
Run: `go test -race ./...` - all tests pass
Run: `go test -cover ./...` - all packages >80%
Property tests exercise edge cases
  </verify>
  <done>Property tests complete, final verification passed</done>
</task>

</tasks>

<verification>
1. `go test -v ./internal/keypool/` - property tests pass
2. `go test -v ./internal/ratelimit/` - property tests pass
3. `go test -v ./internal/auth/` - property tests pass (100% coverage)
4. `go test -race ./...` - no race conditions
5. `go test -cover ./...` - all packages >80%
</verification>

<success_criteria>
- Property tests added for keypool (key selection invariants)
- Property tests added for ratelimit (limit enforcement)
- Property tests added for auth (authentication correctness)
- All tests pass with race detector
- All packages maintain >80% coverage
- gopter library used for property generation
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-10-SUMMARY.md`
</output>
