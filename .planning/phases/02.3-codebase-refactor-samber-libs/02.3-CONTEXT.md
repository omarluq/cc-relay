# Phase 2.3: Codebase Refactor with Samber Libraries - Context

**Gathered:** 2026-01-22
**Status:** Ready for planning

<domain>
## Phase Boundary

Comprehensive codebase improvement using samber libraries (lo/do/ro/mo). Map codebase architecture, integrate all four libraries as primary patterns, fix all tech debt, improve test coverage to >80%, and create local skills/agents for the patterns. All existing tests must pass after refactoring.

</domain>

<decisions>
## Implementation Decisions

### Library Adoption - samber/lo (Collections)
- **Replace all loops** with functional style (Map, Filter, Reduce, etc.)
- Aggressive adoption — convert every for-loop where applicable
- Fully functional style throughout codebase

### Library Adoption - samber/do (Dependency Injection)
- **Primary pattern** — not just targeted, use everywhere
- **Request-scoped + singletons** DI container
  - Singletons: Providers, KeyPool, Cache, Config (long-lived services)
  - Request-scoped: Logger with request ID, timeout context, tracing span
- Clean up serve.go wiring with DI container

### Library Adoption - samber/mo (Monads)
- **All error-returning functions** → `Result[T]`
- **Nullable fields** → `Option[T]`
- **Auth flows** benefit from monadic chaining (validate → authenticate → authorize as Result chain)
- Replace error-prone nil checks throughout

### Library Adoption - samber/ro (Reactive Streams + Plugins)
- **Full plugin adoption** — not just core, use all relevant plugins:
  - **Zerolog** — Reactive logging streams (already using zerolog)
  - **HTTP** — HTTP request/response operators for proxy streams
  - **Hot** — In-memory cache operators (replace/enhance internal/cache/)
  - **Oops** — Structured error handling (complements mo)
  - **Signal** — Graceful shutdown handling
  - **Validation (ozzo)** — Config validation operators
  - **Native rate limiting** — Replace internal/ratelimit/ with ro operators
  - **FSNotify** — File system monitoring (prep for Phase 7 hot-reload)
- **Testify** — ro's testify extension for testing

### Tech Debt Priorities
- **Full audit** — identify all code smells:
  - Long functions (cognitive complexity)
  - God objects/structs (too many responsibilities)
  - Error handling inconsistency
  - Any other bad patterns
- **Fix it all** — comprehensive test coverage first, then refactor everything. No sacred cows.
- **Breaking changes**:
  - Internals: Free to change
  - Config format: Can change freely (early stage, no backward compat needed)
  - HTTP API: Must stay stable
- **Linter strictness**: Max — enable all golangci-lint rules, zero tolerance for warnings

### Test Coverage Approach
- **Target**: >80% across entire codebase
- **Exclude only**: Generated code (proto files)
- **Framework additions**:
  - Add `github.com/stretchr/testify`
  - Add ro testify extension
- **Test ratio**: Unit-heavy (70/20/10)
  - 70% unit tests — fast feedback, isolated
  - 20% integration tests — wiring confidence
  - 10% E2E tests — full flow validation
- **Mock strategy**: Hybrid
  - Unit tests: Interface mocks (mockery/gomock)
  - Integration tests: httptest.Server + testcontainers
- **Property-based testing**: Yes, for complex logic
  - Rate limiters
  - Key selectors
  - Header parsing

### Skills/Agents Design
- **Organization**: Both layers
  - Library reference skills: samber-lo.md, samber-do.md, samber-ro.md, samber-mo.md
  - Pattern-focused skills: di-patterns.md, error-handling.md, collections.md, streams.md
- **Scope**: Generic samber patterns with cc-relay as example code — reusable elsewhere
- **Agents**: Specialized refactor agents
  - loop-to-lo agent — convert loops to lo functions
  - error-to-result agent — convert (value, error) to Result[T]
  - inject-di agent — wire services into DI container
- **Location**: Project `.claude/skills/` and `.claude/agents/`

### Claude's Discretion
- Specific lo function choices (Map vs ForEach, etc.)
- DI container initialization order
- Exact property test generators
- Linter rule prioritization when conflicts arise

</decisions>

<specifics>
## Specific Ideas

- ro plugins list provided by user — full ecosystem adoption, not just core library
- Auth flows specifically called out as benefiting from monadic patterns
- Want skills/agents to be reusable in other projects (generic + examples pattern)
- Early stage project — config format can evolve without migration burden

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 02.3-codebase-refactor-samber-libs*
*Context gathered: 2026-01-22*
