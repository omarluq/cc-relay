---
phase: 02.3-codebase-refactor-samber-libs
plan: 04
type: execute
wave: 2
depends_on: ["02.3-01", "02.3-02"]
files_modified:
  - internal/providers/anthropic.go
  - internal/providers/zai.go
  - internal/providers/base.go
  - internal/auth/chain.go
  - internal/auth/apikey.go
autonomous: true

must_haves:
  truths:
    - "All for-range loops in providers and auth packages converted to lo functions"
    - "All existing tests pass"
    - "Provider implementations maintain Anthropic API compatibility"
  artifacts:
    - path: "internal/providers/anthropic.go"
      provides: "Anthropic provider with lo patterns"
      contains: "github.com/samber/lo"
    - path: "internal/auth/chain.go"
      provides: "Auth chain with lo patterns"
      contains: "github.com/samber/lo"
  key_links:
    - from: "internal/providers/anthropic.go"
      to: "github.com/samber/lo"
      via: "import"
      pattern: "lo\\."
---

<objective>
Convert internal/providers and internal/auth packages from imperative loops to samber/lo functional patterns.

Purpose: providers (91.7% coverage) and auth (100% coverage) are excellent refactoring targets - high coverage ensures safety, and both have collection operations on headers and configs.
Output: providers and auth packages using lo functions where appropriate.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-RESEARCH.md
@.claude/skills/samber-lo.md

# Source files to refactor
@internal/providers/anthropic.go
@internal/providers/zai.go
@internal/providers/base.go
@internal/providers/provider.go
@internal/auth/chain.go
@internal/auth/apikey.go
@internal/auth/auth.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor internal/providers package with lo patterns</name>
  <files>
    internal/providers/anthropic.go
    internal/providers/zai.go
    internal/providers/base.go
    internal/providers/provider.go
  </files>
  <action>
Convert imperative loops in providers package to lo functions:

1. First, identify all for-range loops:
   ```bash
   grep -n "for .*, .* := range" internal/providers/*.go
   ```

2. Common patterns to convert:
   - Header iteration: `lo.ForEach` or `lo.MapToSlice`
   - Model mapping lookups: `lo.Find` or `lo.FindOrElse`
   - Config validation: `lo.Filter` for filtering valid entries

3. anthropic.go:
   - Header forwarding logic
   - Model name transformations
   - Feature capability checks

4. zai.go:
   - Similar patterns to anthropic
   - Model mapping specifics

5. base.go:
   - Shared provider utilities
   - Any common iteration patterns

6. provider.go:
   - Interface definitions (likely minimal changes)

CRITICAL: Do NOT change HTTP API behavior. This is internal refactoring only.
  </action>
  <verify>
Run: `go test -v ./internal/providers/` - all tests pass
Run: `go test -race ./internal/providers/` - no race conditions
Coverage maintained at 91%+
  </verify>
  <done>providers package converted to lo patterns, all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Refactor internal/auth package with lo patterns</name>
  <files>
    internal/auth/chain.go
    internal/auth/apikey.go
    internal/auth/auth.go
    internal/auth/oauth.go
  </files>
  <action>
Convert imperative loops in auth package to lo functions:

1. First, identify loops:
   ```bash
   grep -n "for .*, .* := range" internal/auth/*.go
   ```

2. chain.go (auth chain pattern):
   - `lo.Find` for finding first successful authenticator
   - `lo.Filter` for filtering enabled authenticators
   - `lo.ForEach` for initializing chain members

3. apikey.go:
   - Key validation loops
   - Header extraction patterns

4. auth.go:
   - Main auth interface (minimal changes expected)

5. oauth.go:
   - Token handling patterns
   - Scope validation

This package has 100% coverage - excellent safety net for refactoring.
  </action>
  <verify>
Run: `go test -v ./internal/auth/` - all tests pass
Run: `go test -race ./internal/auth/` - no race conditions
Coverage maintained at 100%
  </verify>
  <done>auth package converted to lo patterns, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify full integration and cross-package tests</name>
  <files>
    (no new files - verification only)
  </files>
  <action>
Run comprehensive verification:

1. Run all unit tests:
   `go test -v ./internal/providers/ ./internal/auth/`

2. Run integration tests if they exist:
   `go test -v -tags=integration ./...`

3. Run full test suite with race detector:
   `go test -race ./...`

4. Verify Anthropic API compatibility:
   - Check that handler tests still pass
   - Verify SSE streaming tests pass
   - Confirm tool_use_id preservation tests pass

5. Check for any import cycles introduced:
   `go build ./...`

6. Verify coverage hasn't dropped:
   `go test -cover ./internal/providers/ ./internal/auth/`

Document any issues found and how they were resolved.
  </action>
  <verify>
Run: `go test -race ./...` - all tests pass
Run: `go build ./...` - builds successfully
Providers coverage: 91%+, Auth coverage: 100%
  </verify>
  <done>Full integration verified, no regressions detected</done>
</task>

</tasks>

<verification>
1. `go test -v ./internal/providers/` - all tests pass
2. `go test -v ./internal/auth/` - all tests pass (100% coverage)
3. `go test -race ./...` - no race conditions anywhere
4. `grep "github.com/samber/lo" internal/providers/*.go internal/auth/*.go` - lo imported
5. Coverage maintained or improved
</verification>

<success_criteria>
- providers package tests pass (91%+ coverage maintained)
- auth package tests pass (100% coverage maintained)
- lo imported and used appropriately
- No race conditions
- HTTP API behavior unchanged (verified by existing integration tests)
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-04-SUMMARY.md`
</output>
