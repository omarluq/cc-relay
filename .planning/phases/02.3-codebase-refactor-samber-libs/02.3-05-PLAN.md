---
phase: 02.3-codebase-refactor-samber-libs
plan: 05
type: execute
wave: 2
depends_on: ["02.3-01", "02.3-02"]
files_modified:
  - internal/proxy/handler.go
  - internal/proxy/middleware.go
  - internal/proxy/routes.go
  - internal/config/config.go
  - internal/config/loader.go
autonomous: true

must_haves:
  truths:
    - "All for-range loops in proxy and config packages converted to lo functions"
    - "All existing tests pass"
    - "HTTP API remains 100% Anthropic-compatible"
  artifacts:
    - path: "internal/proxy/handler.go"
      provides: "Proxy handler with lo patterns"
      contains: "github.com/samber/lo"
    - path: "internal/config/config.go"
      provides: "Config with lo patterns"
      contains: "github.com/samber/lo"
  key_links:
    - from: "internal/proxy/handler.go"
      to: "github.com/samber/lo"
      via: "import"
      pattern: "lo\\."
---

<objective>
Convert internal/proxy and internal/config packages from imperative loops to samber/lo functional patterns.

Purpose: proxy (83.6% coverage) and config (86.5% coverage) are critical packages. Refactoring them with solid test coverage ensures safety while modernizing the codebase core.
Output: proxy and config packages using lo functions where appropriate.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-RESEARCH.md
@.claude/skills/samber-lo.md

# Source files to refactor
@internal/proxy/handler.go
@internal/proxy/middleware.go
@internal/proxy/routes.go
@internal/proxy/server.go
@internal/config/config.go
@internal/config/loader.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor internal/proxy package with lo patterns</name>
  <files>
    internal/proxy/handler.go
    internal/proxy/middleware.go
    internal/proxy/routes.go
    internal/proxy/server.go
    internal/proxy/debug.go
  </files>
  <action>
Convert imperative loops in proxy package to lo functions:

1. First, identify all for-range loops:
   ```bash
   grep -n "for .*, .* := range" internal/proxy/*.go
   ```

2. handler.go:
   - Header copying: `lo.ForEach` or `lo.MapToSlice`
   - Key selection from pool (if loops exist)
   - Response header processing

3. middleware.go:
   - Middleware chain iteration
   - Header filtering for logging
   - Request/response transformations

4. routes.go:
   - Route registration (if loop-based)
   - Handler mapping

5. debug.go:
   - Header redaction patterns
   - Body truncation logic

CRITICAL: Preserve exact Anthropic API behavior. No changes to:
- SSE event sequence
- tool_use_id handling
- Header forwarding behavior
- Error response format
  </action>
  <verify>
Run: `go test -v ./internal/proxy/` - all tests pass
Run: `go test -race ./internal/proxy/` - no race conditions
Coverage maintained at 83%+
  </verify>
  <done>proxy package converted to lo patterns, API compatibility maintained</done>
</task>

<task type="auto">
  <name>Task 2: Refactor internal/config package with lo patterns</name>
  <files>
    internal/config/config.go
    internal/config/loader.go
  </files>
  <action>
Convert imperative loops in config package to lo functions:

1. First, identify loops:
   ```bash
   grep -n "for .*, .* := range" internal/config/*.go
   ```

2. config.go:
   - Provider config validation: `lo.Filter` for valid providers
   - Key config aggregation: `lo.Reduce` for totals
   - Model mapping iterations
   - Environment variable expansion in arrays

3. loader.go:
   - Config file search paths: `lo.Find` for first existing
   - YAML parsing post-processing
   - Default value application

Common patterns to use:
- `lo.Map(providers, func(p ProviderConfig, _ int) string { return p.Name })`
- `lo.Filter(keys, func(k KeyConfig, _ int) bool { return k.Enabled })`
- `lo.Reduce(keys, func(sum int, k KeyConfig, _ int) int { return sum + k.RPMLimit }, 0)`
  </action>
  <verify>
Run: `go test -v ./internal/config/` - all tests pass
Run: `go test -race ./internal/config/` - no race conditions
Coverage maintained at 86%+
  </verify>
  <done>config package converted to lo patterns, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify full system integration</name>
  <files>
    (no new files - verification only)
  </files>
  <action>
Run comprehensive integration verification:

1. Run all unit tests:
   `go test -v ./internal/proxy/ ./internal/config/`

2. Run ALL tests to catch cross-package issues:
   `go test -race ./...`

3. Verify Anthropic API compatibility specifically:
   - Handler tests must pass
   - SSE streaming tests must pass
   - Route tests must pass

4. Build and verify:
   `go build ./cmd/cc-relay/`

5. Check coverage summary:
   `go test -cover ./...`

6. Spot-check critical paths:
   - Load a config file programmatically
   - Verify provider list is correct
   - Check key pool initialization

Document total for-range loops remaining across codebase:
```bash
grep -r "for .*, .* := range" internal/ cmd/ | wc -l
```
  </action>
  <verify>
Run: `go test -race ./...` - all tests pass
Run: `go build ./cmd/cc-relay/` - builds successfully
All packages maintain or improve coverage
  </verify>
  <done>Full integration verified, lo refactoring complete for proxy and config</done>
</task>

</tasks>

<verification>
1. `go test -v ./internal/proxy/` - all tests pass (83%+ coverage)
2. `go test -v ./internal/config/` - all tests pass (86%+ coverage)
3. `go test -race ./...` - no race conditions
4. `go build ./cmd/cc-relay/` - builds successfully
5. Anthropic API compatibility verified by existing handler tests
</verification>

<success_criteria>
- proxy package tests pass (83%+ coverage maintained)
- config package tests pass (86%+ coverage maintained)
- lo imported and used appropriately in both packages
- No race conditions
- HTTP API behavior unchanged
- Binary builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-05-SUMMARY.md`
</output>
