---
phase: 02.3-codebase-refactor-samber-libs
plan: 07a
type: execute
wave: 6
depends_on: ["02.3-06"]
files_modified:
  - cmd/cc-relay/di/container.go
  - cmd/cc-relay/di/providers.go
  - cmd/cc-relay/di/container_test.go
  - cmd/cc-relay/di/providers_test.go
autonomous: true

must_haves:
  truths:
    - "DI container package created with samber/do v2"
    - "All service providers registered (Config, Cache, KeyPool, Providers, Handler)"
    - "Unit tests verify DI wiring works correctly"
  artifacts:
    - path: "cmd/cc-relay/di/container.go"
      provides: "DI container setup"
      contains: "github.com/samber/do/v2"
      min_lines: 50
    - path: "cmd/cc-relay/di/providers.go"
      provides: "Service provider registrations"
      contains: "do.Provide"
      min_lines: 80
  key_links:
    - from: "cmd/cc-relay/di/providers.go"
      to: "github.com/samber/do/v2"
      via: "import"
      pattern: "do\\.(Provide|Invoke|MustInvoke)"
---

<objective>
Create the DI container foundation with samber/do v2 for dependency injection.

Purpose: The DI container provides type-safe, lazy-loaded service initialization with lifecycle management. This plan creates the foundation; the next plan integrates it into serve.go.
Output: New di/ package with container setup and service providers, plus comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-RESEARCH.md

# Samber skills for consistent patterns
@.claude/skills/samber-lo.md
@.claude/skills/samber-mo.md
@.claude/skills/samber-do.md

# Prior summaries
@.planning/phases/02.3-codebase-refactor-samber-libs/02.3-06-SUMMARY.md

# Services that need registration
@internal/config/config.go
@internal/cache/cache.go
@internal/keypool/pool.go
@internal/providers/provider.go
@internal/proxy/handler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DI container foundation</name>
  <files>
    cmd/cc-relay/di/container.go
  </files>
  <action>
Create the DI container package:

1. cmd/cc-relay/di/container.go:
   ```go
   package di

   import "github.com/samber/do/v2"

   // NewContainer creates and configures the DI container
   func NewContainer(configPath string) (*do.Injector, error) {
       injector := do.New()

       // Provide config path as value
       do.ProvideValue(injector, configPath)

       // Register all service providers
       RegisterSingletons(injector)

       return injector, nil
   }

   // Shutdown gracefully shuts down all services
   func Shutdown(injector *do.Injector) error {
       return injector.Shutdown()
   }
   ```

2. Package responsibilities:
   - Create new DI container
   - Register all service providers
   - Provide shutdown mechanism
   - Error handling for initialization failures
  </action>
  <verify>
Run: `go build ./cmd/cc-relay/di/` - builds without errors
Verify package structure is correct
  </verify>
  <done>DI container foundation created</done>
</task>

<task type="auto">
  <name>Task 2: Create service providers</name>
  <files>
    cmd/cc-relay/di/providers.go
  </files>
  <action>
Create service provider registrations:

1. cmd/cc-relay/di/providers.go:
   ```go
   package di

   import (
       "github.com/samber/do/v2"
       "github.com/omarluq/cc-relay/internal/config"
       "github.com/omarluq/cc-relay/internal/cache"
       "github.com/omarluq/cc-relay/internal/keypool"
       "github.com/omarluq/cc-relay/internal/providers"
       "github.com/omarluq/cc-relay/internal/proxy"
   )

   func RegisterSingletons(i *do.Injector) {
       do.Provide(i, NewConfig)
       do.Provide(i, NewCache)
       do.Provide(i, NewKeyPool)
       do.Provide(i, NewProviderMap)
       do.Provide(i, NewProxyHandler)
       do.Provide(i, NewHTTPServer)
   }

   func NewConfig(i *do.Injector) (*config.Config, error) {
       path := do.MustInvoke[string](i) // config path
       return config.Load(path)
   }

   func NewCache(i *do.Injector) (*cache.Cache, error) {
       cfg := do.MustInvoke[*config.Config](i)
       return cache.NewFromConfig(cfg.Cache)
   }

   // ... similar for other services
   ```

2. Follow dependency order:
   - Config (no dependencies)
   - Cache (depends on Config)
   - Providers (depends on Config)
   - KeyPool (depends on Config, Cache)
   - Handler (depends on KeyPool, Providers, Cache)
   - Server (depends on Handler, Config)
  </action>
  <verify>
Run: `go build ./cmd/cc-relay/di/` - builds without errors
Verify all imports resolve correctly
  </verify>
  <done>Service providers created with correct dependency order</done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive tests for DI</name>
  <files>
    cmd/cc-relay/di/container_test.go
    cmd/cc-relay/di/providers_test.go
  </files>
  <action>
Add comprehensive tests for DI:

1. container_test.go:
   - Test container creation with valid config
   - Test container creation with invalid config (returns error)
   - Test shutdown behavior
   - Test service resolution order

2. providers_test.go:
   - Test each provider function individually
   - Test dependency injection works correctly
   - Test error propagation from providers
   - Mock dependencies for unit testing

3. Test patterns:
   ```go
   func TestNewContainer(t *testing.T) {
       // Use temp config file
       configPath := createTempConfig(t)

       injector, err := di.NewContainer(configPath)
       require.NoError(t, err)
       require.NotNil(t, injector)

       // Verify services can be resolved
       cfg := do.MustInvoke[*config.Config](injector)
       assert.NotNil(t, cfg)
   }
   ```

4. Run full test suite:
   ```bash
   go test -race ./cmd/cc-relay/di/...
   ```
  </action>
  <verify>
Run: `go test -v ./cmd/cc-relay/di/...` - all tests pass
Run: `go test -cover ./cmd/cc-relay/di/` - coverage >80%
  </verify>
  <done>DI tests added, container verified working</done>
</task>

</tasks>

<verification>
1. `go build ./cmd/cc-relay/di/` - builds successfully
2. `go test -v ./cmd/cc-relay/di/...` - all tests pass
3. `go test -cover ./cmd/cc-relay/di/` - coverage >80%
4. DI package exists at cmd/cc-relay/di/
5. All services can be resolved from container
</verification>

<success_criteria>
- DI container created with samber/do v2
- All services registered as singletons
- Dependency order correctly established
- Tests pass with >80% coverage
- No circular dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-codebase-refactor-samber-libs/02.3-07a-SUMMARY.md`
</output>
