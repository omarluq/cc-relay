---
phase: 01.2-cache-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/cache.md
autonomous: true

must_haves:
  truths:
    - "Developer can find cache key naming conventions with examples"
    - "Developer can understand cache busting strategies (TTL, manual, cluster)"
    - "Developer can implement a new cache backend using the documented interface"
    - "Operator can configure HA clustering using documented examples"
    - "Operator can troubleshoot common cache issues using the guide"
  artifacts:
    - path: "docs/cache.md"
      provides: "Comprehensive cache documentation"
      min_lines: 400
      contains:
        - "Cache Key Conventions"
        - "Cache Busting Strategies"
        - "Implementing a New Backend"
        - "HA Clustering"
        - "Troubleshooting"
  key_links:
    - from: "docs/cache.md"
      to: "internal/cache/cache.go"
      via: "interface documentation"
      pattern: "type Cache interface"
    - from: "docs/cache.md"
      to: "internal/cache/config.go"
      via: "configuration reference"
      pattern: "OlricConfig|RistrettoConfig"
---

<objective>
Create comprehensive cache system documentation covering all 6 success criteria for Phase 1.2.

Purpose: Enable developers to understand, configure, extend, and troubleshoot the cc-relay cache system without reading source code.

Output: A single `docs/cache.md` file with 10 sections covering:
1. Overview
2. Quick Start
3. Cache Modes (single/ha/disabled)
4. Cache Key Conventions
5. Configuration Reference
6. Cache Busting Strategies
7. HA Clustering Guide
8. Extending with New Backends
9. Troubleshooting
10. API Reference
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.2-cache-documentation/01.2-RESEARCH.md

# Source code for accurate documentation
@internal/cache/cache.go
@internal/cache/config.go
@internal/cache/errors.go
@internal/cache/factory.go

# Documentation style reference
@DEVELOPMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive cache documentation</name>
  <files>docs/cache.md</files>
  <action>
Create `docs/cache.md` with the following structure. Use the research document as the primary source for content.

## Section Structure

### 1. Overview (~30 lines)
- Brief intro to cc-relay cache subsystem
- Three modes: single (Ristretto), ha (Olric), disabled (noop)
- When to use each mode (decision guide)

### 2. Quick Start (~40 lines)
- Minimal configuration for single mode
- Code example showing basic Get/Set operations
- Import paths and error handling

### 3. Cache Modes (~60 lines)
Document each mode with:
- `single` - Ristretto local cache (default, high performance)
- `ha` - Olric distributed cache (multi-instance, shared state)
- `disabled` - Noop passthrough (no caching)
Include YAML config snippet for each mode.

### 4. Cache Key Conventions (~40 lines)
- Key format: `{domain}:{type}:{identifier}`
- Examples table with domain, type, example key, what it caches
- Best practices (lowercase, colon-separated, deterministic)
- Note: These are recommendations for users caching their own data

### 5. Configuration Reference (~80 lines)
Complete reference for all config fields:

**RistrettoConfig:**
| Field | Type | Default | Description |
- num_counters, max_cost, buffer_items

**OlricConfig:**
| Field | Type | Default | Description |
- dmap_name, bind_addr, environment, addresses, peers
- replica_count, read_quorum, write_quorum, member_count_quorum
- leave_timeout, embedded

Include defaults from DefaultRistrettoConfig() and DefaultOlricConfig().

### 6. Cache Busting Strategies (~50 lines)
Three strategies:
1. **TTL-Based Expiration** - SetWithTTL usage, recommended TTLs by use case
2. **Manual Invalidation** - Delete() for explicit removal, idempotent behavior
3. **Cluster Events (HA Mode)** - Automatic redistribution on node leave/join

### 7. HA Clustering Guide (~100 lines)
- Prerequisites (network connectivity, port requirements)
- Port usage: Memberlist port = Olric port + 2 (document explicitly!)
- Environment settings: local/lan/wan and when to use each
- Example: 2-node cluster YAML config
- Example: 3-node docker-compose.yaml (from research)
- Replication and quorum explained

### 8. Extending with New Backends (~80 lines)
- Cache interface definition (from cache.go)
- Implementation checklist:
  - Return ErrNotFound on cache miss
  - Return ErrClosed after Close() called
  - Be safe for concurrent use
  - Copy byte slices (don't share references)
  - Respect context cancellation
- Optional interfaces: StatsProvider, Pinger, ClusterInfo, MultiGetter, MultiSetter
- Example skeleton for a Redis backend

### 9. Troubleshooting (~60 lines)
Common issues and solutions:

| Error | Cause | Solution |
- ErrNotFound - Normal cache miss, not an error
- ErrClosed - Using cache after Close()
- Connection errors - Check bind_addr, firewall, peers
- Nodes can't join cluster - Check memberlist port (bind_addr + 2)
- Quorum errors - Ensure MemberCountQuorum <= actual nodes

Include: "Cache is ephemeral by design - restarts clear all data"

### 10. API Reference (~40 lines)
Quick reference for all interfaces:
- Cache (required): Get, Set, SetWithTTL, Delete, Exists, Close
- StatsProvider (optional): Stats()
- Pinger (optional): Ping()
- ClusterInfo (optional): MemberlistAddr(), ClusterMembers(), IsEmbedded()
- MultiGetter (optional): GetMulti()
- MultiSetter (optional): SetMulti(), SetMultiWithTTL()

## Style Guidelines
- Follow DEVELOPMENT.md markdown patterns
- Use fenced code blocks with language tags (go, yaml, bash)
- Use tables for configuration references
- Include working examples that can be copied directly
- No emojis
  </action>
  <verify>
- File exists at docs/cache.md
- File contains all 10 section headers
- File has 400+ lines
- YAML code blocks parse correctly: `grep -A5 '```yaml' docs/cache.md`
- Go code blocks have proper syntax
  </verify>
  <done>
All 6 success criteria documented:
1. Cache key naming conventions with examples (Section 4)
2. Cache busting strategies (Section 6)
3. Cache adapter interface with implementation guide (Section 8)
4. How to extend with new backends (Section 8)
5. HA clustering configuration with examples (Section 7)
6. Troubleshooting guide (Section 9)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify documentation accuracy</name>
  <files>docs/cache.md</files>
  <action>
Verify the documentation is accurate against the actual codebase:

1. **Interface accuracy**: Confirm Cache interface methods match internal/cache/cache.go
2. **Config field accuracy**: Confirm OlricConfig and RistrettoConfig fields match internal/cache/config.go
3. **Error types accuracy**: Confirm error names match internal/cache/errors.go
4. **Default values accuracy**: Confirm defaults match DefaultRistrettoConfig() and DefaultOlricConfig()
5. **Port calculation accuracy**: Confirm memberlist port = bind_addr + 2 (from Phase 1.1 research)

Fix any discrepancies found.
  </action>
  <verify>
- `grep -c "type Cache interface" internal/cache/cache.go` returns 1
- Documentation interface methods match source
- Configuration defaults match source code
- No TODO or placeholder text remains in docs/cache.md
  </verify>
  <done>
Documentation is verified accurate against codebase. All interfaces, configs, errors, and defaults match source code.
  </done>
</task>

</tasks>

<verification>
Phase verification:
1. `ls docs/cache.md` - File exists
2. `wc -l docs/cache.md` - At least 400 lines
3. `grep -c "## " docs/cache.md` - At least 10 major sections
4. Section headers present for all 6 success criteria
5. YAML examples are syntactically valid
6. Go examples are syntactically valid
</verification>

<success_criteria>
All 6 phase success criteria met:
- [ ] Cache key naming conventions documented with examples
- [ ] Cache busting strategies documented (TTL, manual invalidation, cluster events)
- [ ] Cache adapter interface documented with implementation guide
- [ ] How to extend cache with new backends (Redis, Memcached) documented
- [ ] HA clustering configuration documented with examples
- [ ] Troubleshooting guide for common cache issues
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-cache-documentation/01.2-01-SUMMARY.md`
</output>
