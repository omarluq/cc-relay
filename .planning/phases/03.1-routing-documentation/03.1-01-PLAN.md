---
phase: 03.1-routing-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs-site/content/en/docs/routing.md
  - docs-site/content/en/docs/configuration.md
autonomous: true

must_haves:
  truths:
    - "User can navigate to routing documentation in docs-site"
    - "User understands all four routing strategies (round-robin, weighted-round-robin, shuffle, failover)"
    - "User can configure routing via YAML"
    - "User knows how to enable debug headers and what they reveal"
    - "User understands failover triggers"
  artifacts:
    - path: "docs-site/content/en/docs/routing.md"
      provides: "Complete routing strategy documentation"
      contains: "weight: 4"
    - path: "docs-site/content/en/docs/configuration.md"
      provides: "Routing section in config reference"
      contains: "Routing Configuration"
  key_links:
    - from: "docs-site/content/en/docs/routing.md"
      to: "docs-site/content/en/docs/configuration.md"
      via: "Cross-reference link"
      pattern: "/docs/configuration"
---

<objective>
Create comprehensive English routing documentation for cc-relay docs-site.

Purpose: Provide users with complete routing strategy documentation so they can configure provider routing effectively. This is the source of truth for all translations.

Output:
- New `routing.md` file with weight 4 (between configuration at 3 and architecture at 5)
- Updated `configuration.md` with routing section linking to routing.md
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-routing-documentation/03.1-RESEARCH.md

# Documentation patterns
@docs-site/content/en/docs/caching.md
@docs-site/content/en/docs/configuration.md

# Implementation reference (for accurate documentation)
@internal/router/router.go
@internal/router/triggers.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create English routing.md</name>
  <files>docs-site/content/en/docs/routing.md</files>
  <action>
Create `docs-site/content/en/docs/routing.md` with weight 4 in frontmatter.

Structure (following caching.md pattern):

1. **Overview** - Brief intro explaining routing is how cc-relay chooses which provider handles a request. Include strategy comparison table:

| Strategy | Config Value | Description | Use Case |
|----------|--------------|-------------|----------|
| Round-Robin | `round_robin` | Sequential rotation | Even distribution |
| Weighted Round-Robin | `weighted_round_robin` | Proportional by weight | Capacity-based distribution |
| Shuffle | `shuffle` | Fair random ("dealing cards") | Randomized load balancing |
| Failover | `failover` (default) | Priority-based with retry | High availability |

2. **Configuration** - Complete RoutingConfig YAML:
```yaml
routing:
  strategy: failover        # round_robin, weighted_round_robin, shuffle, failover
  failover_timeout: 5000    # Timeout in milliseconds (default: 5000)
  debug: false              # Enable debug headers
```

Note: Default strategy is `failover` (safest - tries providers in priority order).

3. **Strategies** - Subsection for each:

**Round-Robin**: Sequential distribution using atomic counter. Each provider gets one request before any gets a second. Thread-safe.

**Weighted Round-Robin**: Nginx smooth weighted algorithm. Providers receive traffic proportional to weight. Default weight: 1. Higher weight = more requests.

Example config showing weight in provider keys:
```yaml
providers:
  - name: "anthropic"
    type: "anthropic"
    keys:
      - key: "${ANTHROPIC_API_KEY}"
        weight: 3  # 3x traffic
  - name: "zai"
    type: "zai"
    keys:
      - key: "${ZAI_API_KEY}"
        weight: 1  # 1x traffic
```

**Shuffle**: Fisher-Yates "dealing cards" pattern. Everyone gets one before anyone gets seconds. Provides fair random distribution.

**Failover** (Default): Tries providers in priority order. On failure (429, 5xx, timeout, connection error), parallel races remaining providers for fastest response.

Priority config (higher priority = tried first):
```yaml
providers:
  - name: "anthropic"
    keys:
      - key: "${ANTHROPIC_API_KEY}"
        priority: 2  # Tried first
  - name: "zai"
    keys:
      - key: "${ZAI_API_KEY}"
        priority: 1  # Fallback
```

4. **Debug Headers** - Only added when `routing.debug: true`:

| Header | Value | Description |
|--------|-------|-------------|
| `X-CC-Relay-Strategy` | Strategy name | Which routing strategy was used |
| `X-CC-Relay-Provider` | Provider name | Which provider was selected |

Security note: Debug headers expose internal routing decisions. Use only in development.

5. **Failover Triggers** - What causes failover:

| Trigger | Conditions | Description |
|---------|------------|-------------|
| Status Code | 429, 500, 502, 503, 504 | Rate limit or server errors |
| Timeout | context.DeadlineExceeded | Request timeout exceeded |
| Connection | net.Error | Network errors, DNS failures |

Important: 4xx client errors (except 429) do NOT trigger failover - they indicate client issues.

6. **Examples** - Practical configurations:

Simple failover:
```yaml
routing:
  strategy: failover
```

Load balanced with weights:
```yaml
routing:
  strategy: weighted_round_robin

providers:
  - name: "primary"
    keys:
      - key: "${PRIMARY_KEY}"
        weight: 3
  - name: "secondary"
    keys:
      - key: "${SECONDARY_KEY}"
        weight: 1
```

Development with debug:
```yaml
routing:
  strategy: round_robin
  debug: true
```

7. **Next Steps** - Link to configuration.md and architecture.md

Verify Hugo frontmatter:
```yaml
---
title: Routing
weight: 4
---
```
  </action>
  <verify>
Run: `hugo --source docs-site 2>&1 | grep -i error || echo "Hugo build OK"`
Check: File exists and contains "weight: 4" in frontmatter
Check: Contains all four strategy names (round_robin, weighted_round_robin, shuffle, failover)
  </verify>
  <done>
routing.md exists with weight 4, covers all strategies, includes YAML examples, documents debug headers and failover triggers
  </done>
</task>

<task type="auto">
  <name>Task 2: Add routing section to English configuration.md</name>
  <files>docs-site/content/en/docs/configuration.md</files>
  <action>
Add a "Routing Configuration" section to `docs-site/content/en/docs/configuration.md`.

Insert AFTER the "Cache Configuration" section (around line 127) and BEFORE "Example Configurations" section.

Content to add:

```markdown
## Routing Configuration

CC-Relay supports multiple routing strategies for distributing requests across providers.

```yaml
# ==========================================================================
# Routing Configuration
# ==========================================================================
routing:
  # Strategy: round_robin, weighted_round_robin, shuffle, failover (default)
  strategy: failover

  # Timeout for failover attempts in milliseconds (default: 5000)
  failover_timeout: 5000

  # Enable debug headers (X-CC-Relay-Strategy, X-CC-Relay-Provider)
  debug: false
```

### Routing Strategies

| Strategy | Description |
|----------|-------------|
| `failover` | Try providers in priority order, fallback on failure (default) |
| `round_robin` | Sequential rotation through providers |
| `weighted_round_robin` | Distribute proportionally by weight |
| `shuffle` | Fair random distribution |

### Provider Weight and Priority

Weight and priority are configured in the provider's first key:

```yaml
providers:
  - name: "anthropic"
    type: "anthropic"
    keys:
      - key: "${ANTHROPIC_API_KEY}"
        weight: 3      # For weighted-round-robin (higher = more traffic)
        priority: 2    # For failover (higher = tried first)
```

For detailed routing configuration including strategy explanations, debug headers, and failover triggers, see the [Routing documentation](/docs/routing/).
```

Also add to the Complete Configuration Reference YAML block (around line 36):
- After the cache section, add a routing section showing default values.

Also update "Next Steps" at the bottom to include routing.md link.
  </action>
  <verify>
Run: `hugo --source docs-site 2>&1 | grep -i error || echo "Hugo build OK"`
Check: configuration.md contains "Routing Configuration" section
Check: configuration.md links to /docs/routing/
  </verify>
  <done>
configuration.md includes routing section with strategy table, weight/priority example, and link to routing.md
  </done>
</task>

</tasks>

<verification>
1. Hugo builds successfully: `hugo --source docs-site`
2. routing.md has weight 4 in frontmatter
3. routing.md contains all strategy documentation
4. configuration.md has routing section
5. Cross-references work (routing links to config, config links to routing)
</verification>

<success_criteria>
- [ ] routing.md created with weight 4 (appears between configuration and architecture)
- [ ] All four strategies documented with examples
- [ ] Debug headers documented with security note
- [ ] Failover triggers documented (status codes, timeout, connection)
- [ ] configuration.md has routing section linking to routing.md
- [ ] Hugo builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-routing-documentation/03.1-01-SUMMARY.md`
</output>
