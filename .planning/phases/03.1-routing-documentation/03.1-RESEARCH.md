# Phase 3.1: Routing Documentation - Research

**Researched:** 2026-01-23
**Domain:** Hugo documentation site with i18n (routing strategies documentation)
**Confidence:** HIGH

## Summary

Phase 3 implemented four routing strategies (round-robin, weighted-round-robin, shuffle, failover) with configurable failover timeout, debug headers, and extensible trigger system. This documentation phase must add routing documentation to the Hugo-based docs-site in all 6 supported languages (EN, DE, ES, JA, ZH-CN, KO).

The documentation needs to cover:
1. **Routing strategies** - How each strategy works and when to use it
2. **Configuration** - YAML syntax for RoutingConfig (strategy, failover_timeout, debug)
3. **Debug headers** - X-CC-Relay-Strategy and X-CC-Relay-Provider (only when routing.debug=true)
4. **Failover triggers** - Status codes (429, 5xx), timeouts, connection errors
5. **Weight and priority** - How providers are weighted/prioritized from config

This follows the established documentation pattern from Phases 1.3 and 2.1: English first, then translations maintaining code blocks in English.

**Primary recommendation:** Create routing.md in docs-site/content/en/docs/ with weight 4 (between configuration.md at 3 and architecture.md at 5), then translate to all 5 other languages. Also add a concise routing section to configuration.md.

## Standard Stack

### Core Framework
| Framework | Purpose | Why Standard |
|-----------|---------|--------------|
| Hugo | Static site generator | Already used in docs-site |
| Hextra | Hugo theme | Already installed (github.com/imfing/hextra) |

### Content Structure
| Component | Location | Pattern |
|-----------|----------|---------|
| English docs | `docs-site/content/en/docs/` | Source of truth |
| German | `docs-site/content/de/docs/` | Translation |
| Spanish | `docs-site/content/es/docs/` | Translation |
| Japanese | `docs-site/content/ja/docs/` | Translation |
| Chinese | `docs-site/content/zh-cn/docs/` | Translation |
| Korean | `docs-site/content/ko/docs/` | Translation |

### Build Process
```bash
# Build site
hugo --source docs-site

# Local development
hugo server --source docs-site
```

## Architecture Patterns

### Documentation File Structure

```
docs-site/content/{lang}/docs/
├── _index.md           # Docs landing (weight: 1)
├── getting-started.md  # Quick start (weight: 2)
├── configuration.md    # Config reference (weight: 3)
├── routing.md          # NEW - Routing strategies (weight: 4)
├── architecture.md     # System design (weight: 5)
├── caching.md          # Cache system (weight: 6)
└── api.md              # API reference (weight: 7)
```

### Hugo Frontmatter Pattern

```yaml
---
title: Routing
weight: 4
---
```

### Content Organization Pattern (from caching.md)

1. **Overview** - Brief intro with table of strategies
2. **Configuration** - YAML examples with all options
3. **Strategy Details** - Each strategy in its own subsection
4. **Debug Headers** - When and how to use
5. **Failover Triggers** - What triggers failover
6. **Troubleshooting** - Common issues

### Translation Pattern (from Phase 1.3)

- Markdown frontmatter preserved (title translated, weight identical)
- Code blocks kept in English (Go, YAML, bash)
- Technical terms kept in English (round-robin, failover, etc.)
- Tables translated (headers and descriptions)
- Internal links use language-specific URL prefixes

## Implementation Details from Codebase

### Routing Strategies (from internal/router/)

| Strategy | Config Value | Description | Implementation |
|----------|--------------|-------------|----------------|
| **Round-Robin** | `round_robin` | Sequential rotation through healthy providers | Atomic counter, thread-safe |
| **Weighted Round-Robin** | `weighted_round_robin` | Nginx smooth algorithm, proportional distribution | Weight defaults to 1 if not specified |
| **Shuffle** | `shuffle` | Fisher-Yates "dealing cards" pattern | Everyone gets one before anyone gets seconds |
| **Failover** | `failover` (default) | Priority-based with parallel retry on failure | Default timeout 5s, DefaultTriggers() |

### RoutingConfig (from internal/config/config.go)

```yaml
routing:
  # Strategy: round_robin, weighted_round_robin, shuffle, failover (default)
  strategy: failover

  # Failover timeout in milliseconds (default: 5000)
  failover_timeout: 5000

  # Enable debug headers (X-CC-Relay-Strategy, X-CC-Relay-Provider)
  debug: false
```

### Debug Headers (from internal/proxy/handler.go)

Only added when `routing.debug: true`:

| Header | Value | Description |
|--------|-------|-------------|
| `X-CC-Relay-Strategy` | Strategy name (e.g., "round_robin") | Which routing strategy was used |
| `X-CC-Relay-Provider` | Provider name (e.g., "anthropic") | Which provider was selected |

### Failover Triggers (from internal/router/triggers.go)

| Trigger Type | Conditions | Description |
|--------------|------------|-------------|
| **Status Code** | 429, 500, 502, 503, 504 | Rate limit or server errors |
| **Timeout** | context.DeadlineExceeded | Request or response timeout |
| **Connection** | net.Error | Network errors, DNS failures, connection refused |

### Weight and Priority (from STATE.md decisions)

- Weight/priority from **first key** of each provider config
- Higher priority = tried first in failover
- Higher weight = more requests in weighted-round-robin
- Default weight: 1 (when Weight <= 0)

### Provider Config with Weight/Priority

```yaml
providers:
  - name: "anthropic"
    type: "anthropic"
    keys:
      - key: "${ANTHROPIC_API_KEY}"
        weight: 3      # For weighted-round-robin
        priority: 2    # For failover (higher = tried first)
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Translation generation | Manual translation | Follow existing translation patterns | Consistency with other docs |
| Documentation structure | New layout | Existing Hugo/Hextra patterns | Theme compatibility |
| Mermaid diagrams | ASCII diagrams | Mermaid code blocks | Hextra supports mermaid |

## Common Pitfalls

### Pitfall 1: Incorrect Weight Assignment

**What goes wrong:** Documenting weight in provider config without specifying where it comes from
**Why it happens:** Weight/priority are actually from the KeyConfig, not ProviderConfig directly
**How to avoid:** Document that weight/priority come from the first key's config
**Warning signs:** User confusion about where to set weight

### Pitfall 2: Missing Debug Header Caveat

**What goes wrong:** Users enable debug=true in production
**Why it happens:** Debug headers expose internal routing decisions
**How to avoid:** Clearly document that debug headers may leak internal info
**Warning signs:** Headers visible in production logs

### Pitfall 3: Wrong Timeout Units

**What goes wrong:** Users configure timeout in seconds instead of milliseconds
**Why it happens:** Many systems use seconds; cc-relay uses milliseconds
**How to avoid:** Clearly document "failover_timeout in milliseconds"
**Warning signs:** 5 instead of 5000 causing 5ms timeout

### Pitfall 4: Expecting Failover Without Triggers

**What goes wrong:** User expects failover on any error
**Why it happens:** Not understanding trigger conditions
**How to avoid:** Document exactly which errors trigger failover
**Warning signs:** 4xx client errors not causing failover (correct behavior)

### Pitfall 5: Translation Missing Code Blocks

**What goes wrong:** Code blocks get translated, breaking examples
**Why it happens:** Overzealous translation
**How to avoid:** Keep ALL code blocks (YAML, bash, Go) in English
**Warning signs:** Translated YAML keys won't work

## Content to Document

### New File: routing.md

**Sections to include:**

1. **Overview**
   - What routing strategies are
   - When you need them (multiple providers)
   - Strategy comparison table

2. **Configuration**
   - Complete RoutingConfig YAML
   - Default values (failover, 5000ms, debug=false)
   - Provider weight/priority configuration

3. **Strategies**
   - Round-Robin: Sequential distribution, use case
   - Weighted Round-Robin: Proportional distribution, weight calculation
   - Shuffle: Random fair distribution, dealing cards analogy
   - Failover (default): Priority-based with parallel retry

4. **Debug Headers**
   - When to enable
   - Available headers
   - Security consideration

5. **Failover Triggers**
   - Status code triggers (429, 5xx)
   - Timeout triggers
   - Connection error triggers
   - What does NOT trigger failover (4xx client errors)

6. **Examples**
   - Simple single-strategy config
   - Multi-provider failover config
   - Weighted distribution config

### Update: configuration.md

Add routing section under existing structure:

```yaml
# ==========================================================================
# Routing Configuration
# ==========================================================================
routing:
  strategy: failover
  failover_timeout: 5000
  debug: false
```

With brief explanation linking to routing.md for details.

## Code Examples

### Minimal Routing Config

```yaml
routing:
  strategy: failover  # Default - safest choice
```

### Full Routing Config

```yaml
routing:
  # Strategy: round_robin, weighted_round_robin, shuffle, failover
  strategy: failover

  # Timeout for failover attempts (milliseconds)
  failover_timeout: 5000

  # Enable debug headers (development only)
  debug: false
```

### Provider with Weight/Priority

```yaml
providers:
  - name: "anthropic"
    type: "anthropic"
    keys:
      - key: "${ANTHROPIC_API_KEY}"
        weight: 3      # Weighted round-robin: 3x traffic
        priority: 2    # Failover: tried first (higher = first)

  - name: "zai"
    type: "zai"
    keys:
      - key: "${ZAI_API_KEY}"
        weight: 1      # Weighted round-robin: 1x traffic
        priority: 1    # Failover: tried second
```

### Debug Headers Example Response

```http
HTTP/1.1 200 OK
X-CC-Relay-Strategy: round_robin
X-CC-Relay-Provider: anthropic
Content-Type: application/json
...
```

## State of the Art

| Implementation | Status | Notes |
|----------------|--------|-------|
| Round-Robin | Complete | Atomic counter, thread-safe |
| Weighted Round-Robin | Complete | Nginx smooth algorithm |
| Shuffle | Complete | Fisher-Yates shuffle |
| Failover | Complete | Parallel race, configurable triggers |
| Debug Headers | Complete | Disabled by default |
| Documentation | Missing | This phase adds it |

## Open Questions

None - all routing implementation details are documented in STATE.md and verified in source code.

## Sources

### Primary (HIGH confidence)
- `/home/omarluq/sandbox/go/cc-relay/internal/router/router.go` - Interface and strategy constants
- `/home/omarluq/sandbox/go/cc-relay/internal/router/round_robin.go` - Round-robin implementation
- `/home/omarluq/sandbox/go/cc-relay/internal/router/weighted_round_robin.go` - Weighted round-robin
- `/home/omarluq/sandbox/go/cc-relay/internal/router/shuffle.go` - Shuffle implementation
- `/home/omarluq/sandbox/go/cc-relay/internal/router/failover.go` - Failover with parallel retry
- `/home/omarluq/sandbox/go/cc-relay/internal/router/triggers.go` - Failover triggers
- `/home/omarluq/sandbox/go/cc-relay/internal/config/config.go` - RoutingConfig struct
- `/home/omarluq/sandbox/go/cc-relay/internal/proxy/handler.go` - Debug header implementation
- `/home/omarluq/sandbox/go/cc-relay/.planning/STATE.md` - Implementation decisions

### Secondary (MEDIUM confidence)
- `/home/omarluq/sandbox/go/cc-relay/.planning/phases/01.3-site-documentation-update/01.3-RESEARCH.md` - Documentation patterns
- `/home/omarluq/sandbox/go/cc-relay/docs-site/content/en/docs/caching.md` - Documentation style reference
- `/home/omarluq/sandbox/go/cc-relay/docs-site/content/en/docs/configuration.md` - Configuration format

### Tertiary (LOW confidence)
- None

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Verified existing docs-site structure
- Architecture: HIGH - Verified from source code and STATE.md
- Pitfalls: HIGH - Derived from implementation details
- Content to document: HIGH - Complete implementation analysis

**Research date:** 2026-01-23
**Valid until:** 2026-02-23 (stable - routing implementation complete)
