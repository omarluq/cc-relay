---
phase: 02.2-subscription-token-relay
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs-site/content/en/docs/configuration.md
  - internal/config/config.go
  - config/example.yaml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Documentation clearly explains two-tier auth model (client-to-proxy vs proxy-to-backend)"
    - "Users understand subscription tokens only authenticate to proxy, not to Anthropic"
    - "Config validation warns when allow_subscription=true but no provider keys configured"
    - "Example configurations have clear comments explaining auth flow"
  artifacts:
    - path: "docs-site/content/en/docs/configuration.md"
      provides: "Authentication Architecture section"
      contains: "Two-Tier Authentication"
    - path: "internal/config/config.go"
      provides: "Config validation warning for missing provider keys"
      contains: "allow_subscription enabled but no provider API keys"
    - path: "config/example.yaml"
      provides: "Updated comments explaining auth modes"
      contains: "proxy authentication only"
  key_links:
    - from: "docs-site/content/en/docs/configuration.md"
      to: "internal/config/config.go"
      via: "config field documentation"
      pattern: "allow_subscription"
---

<objective>
Add Authentication Architecture documentation to English site docs and enhance config validation with warnings

Purpose: Clarify the two-tier authentication model so users understand that subscription tokens only authenticate to the proxy, not to Anthropic's API. Users must configure provider API keys even when using subscription passthrough mode.

Output:
1. New "Authentication Architecture" section in English configuration.md
2. Config validation enhancement that warns (not errors) when allow_subscription=true but no provider keys
3. Updated example.yaml with clear comments explaining auth modes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-subscription-token-relay/02.2-RESEARCH.md

# Prior work
@.planning/phases/02.1-site-docs-multi-key-pooling/02.1-01-SUMMARY.md

# Current implementation
@internal/config/config.go (lines 62-91 for AuthConfig)
@internal/proxy/handler.go (lines 62-67 for header stripping)
@docs-site/content/en/docs/configuration.md (current auth section lines 165-213)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Authentication Architecture section to English configuration.md</name>
  <files>docs-site/content/en/docs/configuration.md</files>
  <action>
Add a new "Authentication Architecture" section BEFORE the existing "Authentication" section (around line 165). This section explains the two-tier auth model.

Content to add (approximately 80 lines):

```markdown
### Authentication Architecture

CC-Relay uses a **two-tier authentication model**:

1. **Client-to-Proxy**: Authenticates clients connecting to cc-relay
2. **Proxy-to-Backend**: Authenticates cc-relay to provider APIs (Anthropic, Z.AI, etc.)

These are **independent** - the client authentication method does NOT determine how cc-relay authenticates to providers.

#### Authentication Flow Diagram

```
Claude Code Client                    cc-relay Proxy                    Anthropic API
      |                                    |                                 |
      |-- Authorization: Bearer <token> -->|                                 |
      |    (or x-api-key: <key>)           |                                 |
      |                                    |                                 |
      |                              [VALIDATE CLIENT]                       |
      |                              [STRIP Authorization/x-api-key]         |
      |                                    |                                 |
      |                                    |-- x-api-key: <provider-key> --->|
      |                                    |                                 |
      |<----------- Response --------------|<--------- Response -------------|
```

#### Important: Subscription Tokens Are Proxy-Only

When using `allow_subscription: true`, Claude Code subscription tokens (Bearer tokens) are accepted for **proxy authentication only**. The proxy:

1. Validates the Bearer token format (not its value)
2. **Strips** the Authorization header before forwarding
3. Uses **configured provider API keys** to authenticate with Anthropic

**You MUST configure provider API keys** even when using subscription passthrough:

```yaml
# CORRECT: Subscription passthrough with provider API key
server:
  auth:
    allow_subscription: true  # Accept any Bearer token from clients

providers:
  - name: "anthropic"
    type: "anthropic"
    enabled: true
    keys:
      - key: "${ANTHROPIC_API_KEY}"  # Required! Proxy uses this for Anthropic
```

```yaml
# WRONG: This will fail - no provider keys!
server:
  auth:
    allow_subscription: true  # Accepts client auth, but...

providers:
  - name: "anthropic"
    type: "anthropic"
    enabled: true
    keys: []  # No keys - requests will fail with 401 from Anthropic
```

#### Why This Architecture?

In January 2026, Anthropic restricted subscription tokens to only work with the official Claude Code client. Third-party proxies cannot forward subscription tokens to Anthropic's API. CC-Relay's two-tier model allows:

- **Personal use**: Accept subscription tokens for convenience, use your own API keys for billing
- **Team use**: Centralize API key management while allowing various client auth methods
- **Cost control**: Route through your own keys to track and limit usage
```

Also update the existing "Claude Code Subscription Passthrough" subsection (around line 181-189) to add a clear warning:

```markdown
#### Claude Code Subscription Passthrough

Allow Claude Code subscription users to connect:

```yaml
server:
  auth:
    allow_subscription: true
```

This accepts `Authorization: Bearer` tokens from Claude Code for **proxy authentication**.

> **Important**: This does NOT forward subscription tokens to Anthropic. You must configure provider API keys separately. See [Authentication Architecture](#authentication-architecture) above.
```

Verify Hugo builds after changes:
```bash
cd docs-site && hugo --minify
```
  </action>
  <verify>
1. `cd /home/omarluq/sandbox/go/cc-relay/docs-site && hugo --minify` completes without errors
2. `grep -n "Two-Tier Authentication" docs-site/content/en/docs/configuration.md` shows the new section
3. `grep -n "proxy authentication only" docs-site/content/en/docs/configuration.md` shows the warning
  </verify>
  <done>
- English configuration.md has new "Authentication Architecture" section
- Existing "Subscription Passthrough" section has warning about API key requirement
- Hugo builds successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add config validation warning for missing provider keys</name>
  <files>internal/config/config.go</files>
  <action>
Add a new validation method to Config that logs a WARNING when `allow_subscription` or `allow_bearer` is true but no enabled provider has API keys configured. This is a warning (not an error) because the user might be intentionally running without providers for testing.

In internal/config/config.go, add a new method after the existing Validate() method on KeyConfig (around line 175):

```go
// ValidateAuthConfig checks for common authentication misconfigurations.
// Returns warnings (not errors) for configurations that may cause issues.
func (c *Config) ValidateAuthConfig(logger zerolog.Logger) {
    // Check if subscription/bearer auth is enabled
    if !c.Server.Auth.IsBearerEnabled() {
        return
    }

    // Check if any enabled provider has API keys
    hasProviderKey := false
    for _, p := range c.Providers {
        if p.Enabled && len(p.Keys) > 0 {
            hasProviderKey = true
            break
        }
    }

    if !hasProviderKey {
        logger.Warn().
            Bool("allow_subscription", c.Server.Auth.AllowSubscription).
            Bool("allow_bearer", c.Server.Auth.AllowBearer).
            Msg("allow_subscription enabled but no provider API keys configured - " +
                "subscription tokens only authenticate to proxy, not to backend providers")
    }
}
```

This method should be called from serve.go after config is loaded but before the server starts. Find the appropriate location in cmd/cc-relay/serve.go and add the call.

Note: Import "github.com/rs/zerolog" is already available in config.go.
  </action>
  <verify>
1. `go build ./...` succeeds
2. `go test ./internal/config/... -v` passes
3. `grep -n "ValidateAuthConfig" internal/config/config.go` shows the new method
4. Create a test config with allow_subscription=true and no keys, verify warning is logged on startup
  </verify>
  <done>
- Config.ValidateAuthConfig() method exists and logs warning
- Method is called from serve.go
- Tests pass
- Warning appears in logs when misconfigured
  </done>
</task>

<task type="auto">
  <name>Task 3: Update example.yaml with auth mode comments</name>
  <files>config/example.yaml</files>
  <action>
Update config/example.yaml to add clear comments explaining the authentication architecture. Find the auth section and add explanatory comments.

Update the server.auth section (around line 15-25) to include:

```yaml
  # ==========================================================================
  # Authentication (Two-Tier Model)
  # ==========================================================================
  # CC-Relay uses two SEPARATE authentication layers:
  #
  # 1. CLIENT-TO-PROXY: How clients authenticate to cc-relay
  #    - api_key: Require specific x-api-key header from clients
  #    - allow_subscription: Accept Bearer tokens (e.g., from Claude Code)
  #    - allow_bearer + bearer_secret: Require specific Bearer token
  #
  # 2. PROXY-TO-BACKEND: How cc-relay authenticates to providers (Anthropic, Z.AI)
  #    - Always uses provider keys configured below
  #    - Client auth tokens are STRIPPED before forwarding
  #
  # IMPORTANT: allow_subscription does NOT forward subscription tokens to
  # Anthropic. It only accepts them for proxy authentication. You MUST
  # configure provider API keys in the 'providers' section below.
  # ==========================================================================
  auth:
    # Require specific API key for proxy access (client-to-proxy)
    api_key: "${PROXY_API_KEY}"

    # Accept Claude Code subscription Bearer tokens (client-to-proxy only!)
    # NOTE: This authenticates clients to the proxy. It does NOT forward
    # tokens to Anthropic. You still need provider API keys below.
    allow_subscription: true

    # Optional: Require specific Bearer token value (for additional security)
    # bearer_secret: "${BEARER_SECRET}"
```

Also add a comment in the providers section (around line 35-40):

```yaml
# ==========================================================================
# Provider Configurations (Proxy-to-Backend Authentication)
# ==========================================================================
# These API keys authenticate cc-relay to backend providers.
# Client authentication (above) is handled separately.
# Even with allow_subscription=true, you MUST configure provider keys here.
# ==========================================================================
providers:
```
  </action>
  <verify>
1. `grep -n "Two-Tier Model" config/example.yaml` shows the new comments
2. `grep -n "Proxy-to-Backend Authentication" config/example.yaml` shows provider section comments
3. `cc-relay config validate --config config/example.yaml` (if available) succeeds
  </verify>
  <done>
- example.yaml has comprehensive auth architecture comments
- Comments clearly explain two-tier model
- Comments warn about subscription token limitations
  </done>
</task>

</tasks>

<verification>
1. Hugo site builds without errors: `cd docs-site && hugo --minify`
2. Go code compiles: `go build ./...`
3. Tests pass: `go test ./... -short`
4. New authentication section in docs: `grep "Two-Tier Authentication" docs-site/content/en/docs/configuration.md`
5. Config validation method exists: `grep "ValidateAuthConfig" internal/config/config.go`
6. Example config has comments: `grep "Two-Tier Model" config/example.yaml`
</verification>

<success_criteria>
1. English configuration.md has "Authentication Architecture" section explaining two-tier model
2. Config warns (logs) when allow_subscription=true but no provider keys configured
3. example.yaml has clear comments about auth architecture
4. All builds and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-subscription-token-relay/02.2-01-SUMMARY.md`
</output>
