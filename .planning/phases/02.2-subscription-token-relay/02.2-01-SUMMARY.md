---
phase: 02.2
plan: 01
subsystem: documentation
tags: [auth, configuration, two-tier-auth, subscription-tokens]

dependency_graph:
  requires: [02.1]
  provides: [auth-documentation, config-validation-warning]
  affects: [02.2-02, 02.2-03]

tech_stack:
  added: []
  patterns: [two-tier-auth-model, config-validation-warnings]

key_files:
  created: []
  modified:
    - docs-site/content/en/docs/configuration.md
    - internal/config/config.go
    - cmd/cc-relay/serve.go
    - config/example.yaml

decisions:
  - id: AUTH-DOC-01
    description: "Document two-tier auth model with ASCII flow diagram"
    rationale: "Visual diagram clearly shows header stripping and separate auth layers"

metrics:
  duration: 8 min
  completed: 2026-01-21
---

# Phase 02.2 Plan 01: Auth Architecture Documentation Summary

**Two-tier auth documentation with config validation warning for English site**

## Completed Tasks

| Task | Name | Commit | Files Modified |
|------|------|--------|----------------|
| 1 | Add Authentication Architecture section to English configuration.md | 6d1d7b2 | docs-site/content/en/docs/configuration.md |
| 2 | Add config validation warning for missing provider keys | cf93454 | internal/config/config.go, cmd/cc-relay/serve.go |
| 3 | Update example.yaml with auth mode comments | ca0a9d7 | config/example.yaml |

## What Was Built

### 1. English Documentation - Authentication Architecture Section

Added ~73 lines to `docs-site/content/en/docs/configuration.md`:

- **Two-tier authentication model explanation**: Client-to-Proxy vs Proxy-to-Backend
- **ASCII flow diagram**: Shows header stripping and provider key usage
- **Subscription token limitations**: Clear warning that tokens only authenticate to proxy
- **Correct/incorrect configuration examples**: YAML snippets showing proper usage
- **Why this architecture**: Historical context about January 2026 restrictions
- **Updated Subscription Passthrough section**: Added warning with link to architecture section

### 2. Config Validation Warning

Added `Config.ValidateAuthConfig()` method to `internal/config/config.go`:

```go
func (c *Config) ValidateAuthConfig(logger *zerolog.Logger) {
    if !c.Server.Auth.IsBearerEnabled() {
        return
    }

    hasProviderKey := false
    for i := range c.Providers {
        p := &c.Providers[i]
        if p.Enabled && len(p.Keys) > 0 {
            hasProviderKey = true
            break
        }
    }

    if !hasProviderKey {
        logger.Warn().
            Bool("allow_subscription", c.Server.Auth.AllowSubscription).
            Bool("allow_bearer", c.Server.Auth.AllowBearer).
            Msg("allow_subscription enabled but no provider API keys configured - " +
                "subscription tokens only authenticate to proxy, not to backend providers")
    }
}
```

Called from `cmd/cc-relay/serve.go` after logger initialization.

### 3. Example Configuration Comments

Updated `config/example.yaml` with comprehensive auth architecture comments:

- **Two-Tier Model header**: Explains CLIENT-TO-PROXY vs PROXY-TO-BACKEND
- **Clear warnings**: subscription tokens don't forward to Anthropic
- **Provider section header**: Emphasizes need for provider keys even with allow_subscription

## Verification Results

- Hugo build: PASS (all 6 languages, 17 EN pages)
- Go build: PASS
- Go tests: PASS (all 9 packages)
- Grep "Two-Tier Authentication": Found in docs
- Grep "ValidateAuthConfig": Found in config.go and serve.go
- Grep "Two-Tier Model": Found in example.yaml

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed gocritic linter warnings**

- **Found during:** Task 2 commit
- **Issue:** `logger zerolog.Logger` is heavy (112 bytes), range copy issue
- **Fix:** Changed to pointer `*zerolog.Logger` and used index-based range loop
- **Files modified:** internal/config/config.go, cmd/cc-relay/serve.go
- **Commit:** cf93454

## Must-Have Verification

| Must-Have | Status |
|-----------|--------|
| Documentation clearly explains two-tier auth model | VERIFIED - configuration.md has "Two-Tier Authentication" section |
| Users understand subscription tokens only authenticate to proxy | VERIFIED - multiple warnings in docs and example.yaml |
| Config validation warns when allow_subscription=true but no provider keys | VERIFIED - ValidateAuthConfig logs warning |
| Example configurations have clear comments explaining auth flow | VERIFIED - example.yaml has Two-Tier Model comments |

## Next Phase Readiness

Ready for 02.2-02 (translated documentation for DE, ES, JA, ZH-CN, KO languages).

**Dependencies satisfied:**
- English documentation complete with auth architecture section
- Config validation implemented and tested
- Example configuration updated with comprehensive comments

**No blockers identified.**
