---
phase: 06-cloud-providers
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/providers/vertex.go
  - internal/providers/vertex_test.go
  - go.mod
  - go.sum
autonomous: true

user_setup:
  - service: gcp
    why: "Google Cloud access for integration testing"
    env_vars:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        source: "GCP Console -> IAM -> Service Accounts -> Create key -> JSON"
      - name: GCP_PROJECT_ID
        source: "GCP Console -> Project settings"
    dashboard_config:
      - task: "Enable Vertex AI API"
        location: "GCP Console -> APIs & Services -> Enable APIs -> Vertex AI API"
      - task: "Enable Claude models"
        location: "GCP Console -> Vertex AI -> Model Garden -> Claude"

must_haves:
  truths:
    - "VertexProvider uses OAuth2 tokens for authentication"
    - "OAuth tokens auto-refresh without manual intervention"
    - "VertexProvider returns false for SupportsTransparentAuth"
  artifacts:
    - path: "internal/providers/vertex.go"
      provides: "Google Vertex AI provider with OAuth"
      contains: "TokenSource"
    - path: "internal/providers/vertex_test.go"
      provides: "Unit tests for Vertex provider"
  key_links:
    - from: "internal/providers/vertex.go"
      to: "golang.org/x/oauth2/google"
      via: "FindDefaultCredentials"
      pattern: "google\\.FindDefaultCredentials"
---

<objective>
Implement Google Vertex AI provider with OAuth2 token authentication using Application Default Credentials (ADC).

Purpose: Enable cc-relay to route requests to Vertex AI Claude models with automatic OAuth token refresh.
Output: VertexProvider implementation with OAuth TokenSource and comprehensive unit tests.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-cloud-providers/06-RESEARCH.md
@internal/providers/base.go
@internal/providers/ollama.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Google OAuth2 dependency</name>
  <files>go.mod, go.sum</files>
  <action>
Install required Google OAuth2 package:

```bash
go get golang.org/x/oauth2/google
```

This provides:
- FindDefaultCredentials: ADC credential loading
- TokenSource: Auto-refreshing OAuth tokens
- cloud-platform scope for Vertex AI access

Run `go mod tidy` after installation.
  </action>
  <verify>go mod tidy && go build ./... compiles</verify>
  <done>golang.org/x/oauth2/google installed in go.mod</done>
</task>

<task type="auto">
  <name>Task 2: Implement VertexProvider</name>
  <files>internal/providers/vertex.go</files>
  <action>
Create VertexProvider following the pattern from RESEARCH.md:

```go
package providers

import (
    "context"
    "fmt"
    "net/http"

    "golang.org/x/oauth2"
    "golang.org/x/oauth2/google"
)

const (
    VertexOwner            = "vertex"
    VertexAnthropicVersion = "vertex-2023-10-16"
    VertexScope            = "https://www.googleapis.com/auth/cloud-platform"
)

type VertexProvider struct {
    BaseProvider
    tokenSource oauth2.TokenSource
    projectID   string
    region      string
}
```

Key implementation details:

1. **NewVertexProvider(ctx, name, projectID, region string, models, modelMapping):**
   - Use google.FindDefaultCredentials(ctx, VertexScope)
   - Store creds.TokenSource for auto-refresh
   - Set baseURL to `https://{region}-aiplatform.googleapis.com`
   - Handle error if credentials not found

2. **NewVertexProviderWithTokenSource(name, projectID, region string, ts oauth2.TokenSource, models, modelMapping):**
   - For testing: accept pre-built TokenSource
   - Skip credential discovery

3. **Authenticate(req *http.Request, _ string) error:**
   - Call p.tokenSource.Token() (handles refresh automatically)
   - Set Authorization: Bearer {token.AccessToken}
   - Return error if token retrieval fails

4. **SupportsTransparentAuth() bool:** Return false (uses GCP creds, not client tokens)

5. **GetEndpointPath(model string) string:**
   - Return formatted path: `/v1/projects/{projectID}/locations/{region}/publishers/anthropic/models/{model}:streamRawPredict`
   - This will be used by proxy handler for model-in-URL routing

Important: TokenSource.Token() is safe to call concurrently and handles token caching/refresh internally. Do NOT cache tokens manually.
  </action>
  <verify>go build ./internal/providers/... compiles</verify>
  <done>VertexProvider struct with OAuth TokenSource authentication</done>
</task>

<task type="auto">
  <name>Task 3: Add VertexProvider unit tests</name>
  <files>internal/providers/vertex_test.go</files>
  <action>
Create comprehensive unit tests:

1. **TestNewVertexProviderWithTokenSource:**
   - Verify name, projectID, region stored correctly
   - Verify baseURL format

2. **TestVertexProvider_Authenticate:**
   - Create mock TokenSource that returns static token
   - Create mock request
   - Call Authenticate
   - Verify Authorization header is "Bearer {token}"

3. **TestVertexProvider_Authenticate_TokenError:**
   - Create mock TokenSource that returns error
   - Verify Authenticate returns error

4. **TestVertexProvider_SupportsTransparentAuth:**
   - Verify returns false

5. **TestVertexProvider_GetEndpointPath:**
   - Test various model names
   - Verify path format is correct

6. **TestVertexProvider_BaseProvider:**
   - Test inherited methods: Name(), BaseURL(), Owner(), ListModels()

Create a mock TokenSource for testing:
```go
type mockTokenSource struct {
    token *oauth2.Token
    err   error
}

func (m *mockTokenSource) Token() (*oauth2.Token, error) {
    return m.token, m.err
}

func newTestVertexProvider(projectID, region string) *VertexProvider {
    return NewVertexProviderWithTokenSource(
        "test-vertex",
        projectID,
        region,
        &mockTokenSource{
            token: &oauth2.Token{AccessToken: "test-token"},
        },
        nil,
        nil,
    )
}
```
  </action>
  <verify>go test ./internal/providers/... -v -run Vertex passes</verify>
  <done>Unit tests cover constructor, authentication, token errors, and inherited methods</done>
</task>

</tasks>

<verification>
1. `go build ./...` - compiles without errors
2. `go test ./internal/providers/... -v -run Vertex` - all Vertex tests pass
3. `task lint` - no linter errors
4. `go test ./internal/providers/... -cover` - coverage >80%
</verification>

<success_criteria>
- golang.org/x/oauth2/google package installed
- VertexProvider implements Provider interface
- Authenticate method uses OAuth TokenSource
- Token refresh is automatic (handled by TokenSource)
- Unit tests pass without real GCP credentials
- SupportsTransparentAuth returns false
</success_criteria>

<output>
After completion, create `.planning/phases/06-cloud-providers/06-03-SUMMARY.md`
</output>
