---
phase: 06-cloud-providers
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/providers/vertex.go
  - internal/providers/vertex_test.go
  - go.mod
  - go.sum
autonomous: true

user_setup:
  - service: gcp
    why: "Google Cloud access for integration testing"
    env_vars:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        source: "GCP Console -> IAM -> Service Accounts -> Create key -> JSON"
      - name: GCP_PROJECT_ID
        source: "GCP Console -> Project settings"
    dashboard_config:
      - task: "Enable Vertex AI API"
        location: "GCP Console -> APIs & Services -> Enable APIs -> Vertex AI API"
      - task: "Enable Claude models"
        location: "GCP Console -> Vertex AI -> Model Garden -> Claude"

must_haves:
  truths:
    - "VertexProvider uses OAuth2 tokens for authentication"
    - "OAuth tokens auto-refresh without manual intervention"
    - "Vertex requests include anthropic_version: vertex-2023-10-16 in body"
    - "VertexProvider returns false for SupportsTransparentAuth"
    - "GetEndpointPath returns model-in-URL path for Vertex"
  artifacts:
    - path: "internal/providers/vertex.go"
      provides: "Google Vertex AI provider with OAuth"
      contains: "TokenSource"
    - path: "internal/providers/vertex_test.go"
      provides: "Unit tests for Vertex provider"
  key_links:
    - from: "internal/providers/vertex.go"
      to: "golang.org/x/oauth2/google"
      via: "FindDefaultCredentials"
      pattern: "google\\.FindDefaultCredentials"
---

<objective>
Implement Google Vertex AI provider with OAuth2 token authentication using Application Default Credentials (ADC).

Purpose: Enable cc-relay to route requests to Vertex AI Claude models with automatic OAuth token refresh.
Output: VertexProvider implementation with OAuth TokenSource, body transformation, endpoint path routing, and comprehensive unit tests.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-cloud-providers/06-RESEARCH.md
@internal/providers/base.go
@internal/providers/ollama.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Google OAuth2 dependency</name>
  <files>go.mod, go.sum</files>
  <action>
Install required Google OAuth2 package:

```bash
go get golang.org/x/oauth2/google
```

This provides:
- FindDefaultCredentials: ADC credential loading
- TokenSource: Auto-refreshing OAuth tokens
- cloud-platform scope for Vertex AI access

Run `go mod tidy` after installation.
  </action>
  <verify>go mod tidy && go build ./... compiles</verify>
  <done>golang.org/x/oauth2/google installed in go.mod</done>
</task>

<task type="auto">
  <name>Task 2: Implement VertexProvider with body transformation and endpoint path</name>
  <files>internal/providers/vertex.go</files>
  <action>
Create VertexProvider following the pattern from RESEARCH.md:

```go
package providers

import (
    "context"
    "encoding/json"
    "fmt"
    "net/http"

    "golang.org/x/oauth2"
    "golang.org/x/oauth2/google"
)

const (
    VertexOwner            = "vertex"
    VertexAnthropicVersion = "vertex-2023-10-16"
    VertexScope            = "https://www.googleapis.com/auth/cloud-platform"
)

type VertexProvider struct {
    BaseProvider
    tokenSource oauth2.TokenSource
    projectID   string
    region      string
}
```

Key implementation details:

1. **NewVertexProvider(ctx, name, projectID, region string, models, modelMapping):**
   - Use google.FindDefaultCredentials(ctx, VertexScope)
   - Store creds.TokenSource for auto-refresh
   - Set baseURL to `https://{region}-aiplatform.googleapis.com`
   - Handle error if credentials not found

2. **NewVertexProviderWithTokenSource(name, projectID, region string, ts oauth2.TokenSource, models, modelMapping):**
   - For testing: accept pre-built TokenSource
   - Skip credential discovery

3. **Authenticate(req *http.Request, _ string) error:**
   - Call p.tokenSource.Token() (handles refresh automatically)
   - Set Authorization: Bearer {token.AccessToken}
   - Return error if token retrieval fails

4. **TransformRequestBody(body []byte) ([]byte, error):**
   - Parse body as JSON map
   - Inject `"anthropic_version": "vertex-2023-10-16"` into the body
   - Re-serialize and return
   - This is CRITICAL for Vertex AI compatibility

```go
func (p *VertexProvider) TransformRequestBody(body []byte) ([]byte, error) {
    var reqBody map[string]interface{}
    if err := json.Unmarshal(body, &reqBody); err != nil {
        return nil, fmt.Errorf("failed to parse request body: %w", err)
    }

    // Inject Vertex-specific anthropic_version
    reqBody["anthropic_version"] = VertexAnthropicVersion

    return json.Marshal(reqBody)
}
```

5. **GetEndpointPath(model string) string:**
   - Return formatted path: `/v1/projects/{projectID}/locations/{region}/publishers/anthropic/models/{model}:streamRawPredict`
   - This will be used by proxy handler for model-in-URL routing

```go
func (p *VertexProvider) GetEndpointPath(model string) string {
    return fmt.Sprintf("/v1/projects/%s/locations/%s/publishers/anthropic/models/%s:streamRawPredict",
        p.projectID, p.region, model)
}
```

6. **SupportsTransparentAuth() bool:** Return false (uses GCP creds, not client tokens)

Important: TokenSource.Token() is safe to call concurrently and handles token caching/refresh internally. Do NOT cache tokens manually.
  </action>
  <verify>go build ./internal/providers/... compiles</verify>
  <done>VertexProvider struct with OAuth TokenSource authentication, TransformRequestBody injecting anthropic_version, and GetEndpointPath for model-in-URL routing</done>
</task>

<task type="auto">
  <name>Task 3: Add VertexProvider unit tests</name>
  <files>internal/providers/vertex_test.go</files>
  <action>
Create comprehensive unit tests:

1. **TestNewVertexProviderWithTokenSource:**
   - Verify name, projectID, region stored correctly
   - Verify baseURL format

2. **TestVertexProvider_Authenticate:**
   - Create mock TokenSource that returns static token
   - Create mock request
   - Call Authenticate
   - Verify Authorization header is "Bearer {token}"

3. **TestVertexProvider_Authenticate_TokenError:**
   - Create mock TokenSource that returns error
   - Verify Authenticate returns error

4. **TestVertexProvider_TransformRequestBody:**
   - Test with standard Anthropic request body
   - Verify `anthropic_version: "vertex-2023-10-16"` is injected
   - Verify existing fields are preserved
   - Test with empty body (should still work)
   - Test with malformed JSON (should return error)

5. **TestVertexProvider_GetEndpointPath:**
   - Test with projectID "my-project", region "us-central1", model "claude-sonnet-4-5@20250929"
   - Verify returns `/v1/projects/my-project/locations/us-central1/publishers/anthropic/models/claude-sonnet-4-5@20250929:streamRawPredict`

6. **TestVertexProvider_SupportsTransparentAuth:**
   - Verify returns false

7. **TestVertexProvider_BaseProvider:**
   - Test inherited methods: Name(), BaseURL(), Owner(), ListModels()

Create a mock TokenSource for testing:
```go
type mockTokenSource struct {
    token *oauth2.Token
    err   error
}

func (m *mockTokenSource) Token() (*oauth2.Token, error) {
    return m.token, m.err
}

func newTestVertexProvider(projectID, region string) *VertexProvider {
    return NewVertexProviderWithTokenSource(
        "test-vertex",
        projectID,
        region,
        &mockTokenSource{
            token: &oauth2.Token{AccessToken: "test-token"},
        },
        nil,
        nil,
    )
}
```
  </action>
  <verify>go test ./internal/providers/... -v -run Vertex passes</verify>
  <done>Unit tests cover constructor, authentication, token errors, body transformation, endpoint path, and inherited methods</done>
</task>

</tasks>

<verification>
1. `go build ./...` - compiles without errors
2. `go test ./internal/providers/... -v -run Vertex` - all Vertex tests pass
3. `task lint` - no linter errors
4. `go test ./internal/providers/... -cover` - coverage >80%
</verification>

<success_criteria>
- golang.org/x/oauth2/google package installed
- VertexProvider implements Provider interface
- Authenticate method uses OAuth TokenSource
- TransformRequestBody injects `anthropic_version: "vertex-2023-10-16"`
- GetEndpointPath returns correct model-in-URL path
- Token refresh is automatic (handled by TokenSource)
- Unit tests pass without real GCP credentials
- SupportsTransparentAuth returns false
</success_criteria>

<output>
After completion, create `.planning/phases/06-cloud-providers/06-03-SUMMARY.md`
</output>
