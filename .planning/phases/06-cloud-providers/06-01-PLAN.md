---
phase: 06-cloud-providers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/providers/provider.go
  - internal/providers/transform.go
  - internal/config/config.go
autonomous: true

must_haves:
  truths:
    - "Provider interface includes request transformation methods"
    - "Cloud-specific config fields can be unmarshaled from YAML"
    - "Shared transformation utilities handle body/URL manipulation"
  artifacts:
    - path: "internal/providers/provider.go"
      provides: "Extended Provider interface with TransformRequest/TransformResponse"
      contains: "TransformRequest"
    - path: "internal/providers/transform.go"
      provides: "Shared transformation utilities"
      exports: ["ExtractModel", "RemoveModelFromBody", "AddAnthropicVersion"]
    - path: "internal/config/config.go"
      provides: "Cloud provider config fields"
      contains: "AWSRegion"
  key_links:
    - from: "internal/providers/provider.go"
      to: "internal/providers/transform.go"
      via: "interface uses transform utilities"
      pattern: "TransformRequest.*body"
---

<objective>
Extend Provider interface with request/response transformation capabilities and add cloud-specific configuration fields.

Purpose: Establish the foundation that enables all cloud providers (Bedrock, Azure, Vertex) to transform requests/responses while maintaining backward compatibility with existing providers.

Output: Extended Provider interface, shared transformation utilities, and cloud-specific config structs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cloud-providers/06-RESEARCH.md

# Existing provider implementations to maintain compatibility
@internal/providers/provider.go
@internal/providers/base.go
@internal/providers/anthropic.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Provider interface with transformation methods</name>
  <files>internal/providers/provider.go</files>
  <action>
Add new methods to the Provider interface:

```go
// TransformRequest modifies the request body for provider-specific requirements.
// For cloud providers: may remove model from body (goes in URL), add anthropic_version to body.
// Returns modified body, target URL (including model in path if needed), and error.
// Non-cloud providers return body unchanged and standard URL.
TransformRequest(body []byte, endpoint string) (newBody []byte, targetURL string, err error)

// TransformResponse modifies the response for provider-specific requirements.
// For Bedrock: converts Event Stream to SSE format.
// Other providers return response unchanged.
// The writer is used for streaming responses; non-streaming returns modified body.
TransformResponse(resp *http.Response, w http.ResponseWriter) error

// RequiresBodyTransform returns true if this provider needs request body modification.
// Cloud providers (Bedrock, Vertex) return true. Direct providers return false.
RequiresBodyTransform() bool

// StreamingContentType returns the expected Content-Type for streaming responses.
// Most providers: "text/event-stream"
// Bedrock: "application/vnd.amazon.eventstream"
StreamingContentType() string
```

Add these method signatures to the Provider interface (after existing methods).

IMPORTANT: This extends the interface - existing providers will need default implementations.
  </action>
  <verify>
- `go build ./internal/providers/...` fails (expected - existing providers don't implement new methods yet)
- Interface definition includes all 4 new methods
  </verify>
  <done>Provider interface extended with transformation methods for cloud provider support</done>
</task>

<task type="auto">
  <name>Task 2: Add default implementations to BaseProvider</name>
  <files>internal/providers/base.go</files>
  <action>
Add default implementations for the new interface methods to BaseProvider. These are no-op implementations for non-cloud providers:

```go
// TransformRequest returns the body and URL unchanged for standard providers.
// Cloud provider implementations override this.
func (p *BaseProvider) TransformRequest(body []byte, endpoint string) ([]byte, string, error) {
    // Standard providers: use base URL + endpoint, body unchanged
    targetURL := p.baseURL + endpoint
    return body, targetURL, nil
}

// TransformResponse passes through the response unchanged for standard providers.
// Cloud provider implementations (e.g., Bedrock) override this for format conversion.
func (p *BaseProvider) TransformResponse(resp *http.Response, w http.ResponseWriter) error {
    // Default: no transformation needed, handled by standard proxy
    return nil
}

// RequiresBodyTransform returns false for standard providers.
// Cloud providers override to return true.
func (p *BaseProvider) RequiresBodyTransform() bool {
    return false
}

// StreamingContentType returns the standard SSE content type.
// Bedrock overrides to return "application/vnd.amazon.eventstream".
func (p *BaseProvider) StreamingContentType() string {
    return "text/event-stream"
}
```

These default implementations ensure existing providers (Anthropic, Z.AI, Ollama) continue to work without modification.
  </action>
  <verify>
- `go build ./internal/providers/...` succeeds
- `go test ./internal/providers/...` passes (existing tests still work)
  </verify>
  <done>BaseProvider has default no-op implementations for all transformation methods</done>
</task>

<task type="auto">
  <name>Task 3: Create shared transformation utilities</name>
  <files>internal/providers/transform.go</files>
  <action>
Create a new file with shared utilities for request body transformation. Use tidwall/sjson and tidwall/gjson for JSON manipulation (add to go.mod if not present):

```go
// Package providers provides shared transformation utilities for cloud providers.
package providers

import (
    "github.com/tidwall/gjson"
    "github.com/tidwall/sjson"
)

// ExtractModel extracts the model field from a JSON request body.
// Returns empty string if model field is not present.
func ExtractModel(body []byte) string {
    return gjson.GetBytes(body, "model").String()
}

// RemoveModelFromBody removes the model field from a JSON request body.
// Used by Bedrock/Vertex which put model in URL path, not body.
func RemoveModelFromBody(body []byte) ([]byte, error) {
    return sjson.DeleteBytes(body, "model")
}

// AddAnthropicVersion adds or updates the anthropic_version field in the request body.
// Bedrock uses "bedrock-2023-05-31", Vertex uses "vertex-2023-10-16".
func AddAnthropicVersion(body []byte, version string) ([]byte, error) {
    return sjson.SetBytes(body, "anthropic_version", version)
}

// TransformBodyForCloudProvider performs the standard transformation for cloud providers:
// 1. Extract model (for URL construction)
// 2. Remove model from body
// 3. Add anthropic_version to body
// Returns the modified body and the extracted model name.
func TransformBodyForCloudProvider(body []byte, anthropicVersion string) (newBody []byte, model string, err error) {
    model = ExtractModel(body)

    newBody, err = RemoveModelFromBody(body)
    if err != nil {
        return nil, "", err
    }

    newBody, err = AddAnthropicVersion(newBody, anthropicVersion)
    if err != nil {
        return nil, "", err
    }

    return newBody, model, nil
}
```

Also run:
```bash
go get github.com/tidwall/gjson
go get github.com/tidwall/sjson
```

Create transform_test.go with unit tests for each function:
- ExtractModel with valid JSON, empty body, missing model field
- RemoveModelFromBody preserves other fields
- AddAnthropicVersion with existing/non-existing field
- TransformBodyForCloudProvider full pipeline test
  </action>
  <verify>
- `go build ./internal/providers/...` succeeds
- `go test ./internal/providers/... -v` passes including new transform tests
- Test coverage for transform.go > 80%
  </verify>
  <done>Shared transformation utilities created with full test coverage</done>
</task>

<task type="auto">
  <name>Task 4: Add cloud-specific configuration fields to ProviderConfig</name>
  <files>internal/config/config.go</files>
  <action>
Extend ProviderConfig struct with cloud provider fields:

```go
// ProviderConfig defines configuration for a backend LLM provider.
type ProviderConfig struct {
    // Existing fields
    ModelMapping map[string]string `yaml:"model_mapping"`
    Name         string            `yaml:"name"`
    Type         string            `yaml:"type"`
    BaseURL      string            `yaml:"base_url"`
    Keys         []KeyConfig       `yaml:"keys"`
    Models       []string          `yaml:"models"`
    Pooling      PoolingConfig     `yaml:"pooling"`
    Enabled      bool              `yaml:"enabled"`

    // Cloud provider fields (used when Type is bedrock, vertex, or azure)

    // AWSRegion is the AWS region for Bedrock (e.g., "us-east-1", "us-west-2").
    // Required when Type is "bedrock".
    AWSRegion string `yaml:"aws_region"`

    // AWSAccessKeyID and AWSSecretAccessKey for explicit credentials.
    // If empty, uses AWS SDK default credential chain (env vars, IAM role, etc.).
    AWSAccessKeyID     string `yaml:"aws_access_key_id"`
    AWSSecretAccessKey string `yaml:"aws_secret_access_key"`

    // GCPProjectID is the Google Cloud project ID for Vertex AI.
    // Required when Type is "vertex".
    GCPProjectID string `yaml:"gcp_project_id"`

    // GCPRegion is the Google Cloud region for Vertex AI (e.g., "us-central1").
    // Required when Type is "vertex".
    GCPRegion string `yaml:"gcp_region"`

    // AzureResourceName is the Azure resource name for Foundry.
    // Required when Type is "azure".
    AzureResourceName string `yaml:"azure_resource_name"`

    // AzureDeploymentID is the deployment ID (model) for Azure Foundry.
    // Required when Type is "azure".
    AzureDeploymentID string `yaml:"azure_deployment_id"`

    // AzureAPIVersion is the Azure API version (e.g., "2024-06-01").
    // Defaults to "2024-06-01" if not specified.
    AzureAPIVersion string `yaml:"azure_api_version"`
}

// GetAzureAPIVersion returns the Azure API version with default fallback.
func (p *ProviderConfig) GetAzureAPIVersion() string {
    if p.AzureAPIVersion == "" {
        return "2024-06-01"
    }
    return p.AzureAPIVersion
}
```

Add validation method:

```go
// ValidateCloudConfig validates cloud provider-specific configuration.
func (p *ProviderConfig) ValidateCloudConfig() error {
    switch p.Type {
    case "bedrock":
        if p.AWSRegion == "" {
            return errors.New("config: aws_region required for bedrock provider")
        }
    case "vertex":
        if p.GCPProjectID == "" {
            return errors.New("config: gcp_project_id required for vertex provider")
        }
        if p.GCPRegion == "" {
            return errors.New("config: gcp_region required for vertex provider")
        }
    case "azure":
        if p.AzureResourceName == "" {
            return errors.New("config: azure_resource_name required for azure provider")
        }
    }
    return nil
}
```
  </action>
  <verify>
- `go build ./internal/config/...` succeeds
- `go test ./internal/config/...` passes
- Example YAML with cloud fields parses correctly (manual test or add config test)
  </verify>
  <done>ProviderConfig extended with AWS, GCP, and Azure configuration fields</done>
</task>

</tasks>

<verification>
After all tasks:
1. `go build ./...` succeeds
2. `go test ./...` passes
3. `task lint` passes
4. Provider interface has 4 new methods
5. BaseProvider has default implementations
6. Transform utilities have >80% coverage
7. ProviderConfig has all cloud fields with validation
</verification>

<success_criteria>
- Provider interface extended for cloud provider support
- Existing providers (Anthropic, Z.AI, Ollama) still work unchanged
- Shared transformation utilities ready for cloud providers
- Cloud-specific config fields parseable from YAML
</success_criteria>

<output>
After completion, create `.planning/phases/06-cloud-providers/06-01-SUMMARY.md`
</output>
