---
phase: 06-cloud-providers
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/providers/foundry.go
  - internal/providers/foundry_test.go
  - go.mod
  - go.sum
autonomous: true

user_setup:
  - service: azure
    why: "Azure Foundry access for integration testing"
    env_vars:
      - name: AZURE_FOUNDRY_API_KEY
        source: "Azure Portal -> Azure AI Foundry -> Keys and Endpoint"
    dashboard_config:
      - task: "Create Azure AI Foundry resource"
        location: "Azure Portal -> Create a resource -> Azure AI Foundry"
      - task: "Deploy Claude model"
        location: "Azure AI Foundry -> Model catalog -> Anthropic Claude"
      - task: "Configure content filters"
        location: "Azure AI Foundry -> Content filters (required for Claude)"

must_haves:
  truths:
    - "FoundryProvider supports API key authentication"
    - "FoundryProvider supports Azure Entra ID fallback"
    - "FoundryProvider returns false for SupportsTransparentAuth"
  artifacts:
    - path: "internal/providers/foundry.go"
      provides: "Azure Foundry provider with API key or Entra ID"
      contains: "DefaultAzureCredential"
    - path: "internal/providers/foundry_test.go"
      provides: "Unit tests for Foundry provider"
  key_links:
    - from: "internal/providers/foundry.go"
      to: "github.com/Azure/azure-sdk-for-go/sdk/azidentity"
      via: "NewDefaultAzureCredential"
      pattern: "azidentity\\.NewDefaultAzureCredential"
---

<objective>
Implement Azure Foundry provider with API key authentication and Entra ID fallback using the official Azure SDK.

Purpose: Enable cc-relay to route requests to Azure Foundry Claude models with flexible authentication.
Output: FoundryProvider implementation with dual auth support and comprehensive unit tests.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-cloud-providers/06-RESEARCH.md
@internal/providers/base.go
@internal/providers/ollama.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Azure SDK dependencies</name>
  <files>go.mod, go.sum</files>
  <action>
Install required Azure SDK packages:

```bash
go get github.com/Azure/azure-sdk-for-go/sdk/azidentity
go get github.com/Azure/azure-sdk-for-go/sdk/azcore
```

These provide:
- azidentity: DefaultAzureCredential for Entra ID
- azcore: Core types and interfaces

Run `go mod tidy` after installation.
  </action>
  <verify>go mod tidy && go build ./... compiles</verify>
  <done>Azure SDK packages installed in go.mod</done>
</task>

<task type="auto">
  <name>Task 2: Implement FoundryProvider</name>
  <files>internal/providers/foundry.go</files>
  <action>
Create FoundryProvider following the pattern from RESEARCH.md:

```go
package providers

import (
    "context"
    "fmt"
    "net/http"

    "github.com/Azure/azure-sdk-for-go/sdk/azcore/policy"
    "github.com/Azure/azure-sdk-for-go/sdk/azidentity"
)

const (
    FoundryOwner            = "foundry"
    FoundryAnthropicVersion = "2023-06-01"
    AzureCognitiveScope     = "https://cognitiveservices.azure.com/.default"
)

type FoundryProvider struct {
    BaseProvider
    credential *azidentity.DefaultAzureCredential
    resource   string
    useAPIKey  bool
    apiKey     string
}
```

Key implementation details:

1. **NewFoundryProvider(name, resource string, models, modelMapping):**
   - Create DefaultAzureCredential for Entra ID auth
   - Set baseURL to `https://{resource}.services.ai.azure.com/anthropic`
   - Return error if credential creation fails

2. **NewFoundryProviderWithAPIKey(name, resource, apiKey string, models, modelMapping):**
   - Skip credential creation
   - Store apiKey and set useAPIKey=true
   - For users with API key (simpler setup)

3. **NewFoundryProviderWithCredential(name, resource string, cred *azidentity.DefaultAzureCredential, models, modelMapping):**
   - For testing: accept pre-built credential
   - Skip credential creation

4. **Authenticate(req *http.Request, key string) error:**
   ```go
   // Prefer configured API key
   if p.useAPIKey && p.apiKey != "" {
       req.Header.Set("x-api-key", p.apiKey)
       return nil
   }

   // Then try passed key (from KeyPool)
   if key != "" {
       req.Header.Set("x-api-key", key)
       return nil
   }

   // Fall back to Entra ID
   if p.credential == nil {
       return fmt.Errorf("no authentication method available")
   }

   token, err := p.credential.GetToken(req.Context(), policy.TokenRequestOptions{
       Scopes: []string{AzureCognitiveScope},
   })
   if err != nil {
       return fmt.Errorf("failed to get Azure token: %w", err)
   }

   req.Header.Set("Authorization", "Bearer "+token.Token)
   return nil
   ```

5. **SupportsTransparentAuth() bool:** Return false (uses Azure creds, not client tokens)

Important: Azure prefers x-api-key header (not api-key). The fallback to Entra ID allows enterprise deployments without managing API keys.
  </action>
  <verify>go build ./internal/providers/... compiles</verify>
  <done>FoundryProvider struct with dual API key and Entra ID authentication</done>
</task>

<task type="auto">
  <name>Task 3: Add FoundryProvider unit tests</name>
  <files>internal/providers/foundry_test.go</files>
  <action>
Create comprehensive unit tests:

1. **TestNewFoundryProviderWithAPIKey:**
   - Verify name, resource, apiKey stored correctly
   - Verify baseURL format
   - Verify useAPIKey is true

2. **TestFoundryProvider_Authenticate_APIKey:**
   - Create provider with API key
   - Verify x-api-key header is set
   - Verify no Authorization header

3. **TestFoundryProvider_Authenticate_PassedKey:**
   - Create provider without API key
   - Call Authenticate with key parameter
   - Verify x-api-key header is set

4. **TestFoundryProvider_Authenticate_NoAuth:**
   - Create provider without API key and nil credential
   - Verify Authenticate returns error

5. **TestFoundryProvider_SupportsTransparentAuth:**
   - Verify returns false

6. **TestFoundryProvider_BaseProvider:**
   - Test inherited methods: Name(), BaseURL(), Owner(), ListModels()

Note: Testing actual Entra ID authentication requires mocking Azure SDK, which is complex. Focus on API key path and error cases. Document that Entra ID path needs integration testing.

Create helper for tests:
```go
func newTestFoundryProviderWithKey(resource, apiKey string) *FoundryProvider {
    return NewFoundryProviderWithAPIKey(
        "test-foundry",
        resource,
        apiKey,
        nil,
        nil,
    )
}

func newTestFoundryProviderNoAuth(resource string) *FoundryProvider {
    return &FoundryProvider{
        BaseProvider: NewBaseProvider("test-foundry",
            fmt.Sprintf("https://%s.services.ai.azure.com/anthropic", resource),
            FoundryOwner, nil),
        resource:   resource,
        useAPIKey:  false,
        credential: nil, // No Entra ID
    }
}
```
  </action>
  <verify>go test ./internal/providers/... -v -run Foundry passes</verify>
  <done>Unit tests cover API key auth, passed key, no-auth error, and inherited methods</done>
</task>

</tasks>

<verification>
1. `go build ./...` - compiles without errors
2. `go test ./internal/providers/... -v -run Foundry` - all Foundry tests pass
3. `task lint` - no linter errors
4. `go test ./internal/providers/... -cover` - coverage >80%
</verification>

<success_criteria>
- Azure SDK packages installed
- FoundryProvider implements Provider interface
- Authenticate supports API key and Entra ID fallback
- API key preference: configured > passed > Entra ID
- Unit tests pass without real Azure credentials
- SupportsTransparentAuth returns false
</success_criteria>

<output>
After completion, create `.planning/phases/06-cloud-providers/06-04-SUMMARY.md`
</output>
