---
phase: 06-cloud-providers
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/providers/bedrock.go
  - internal/providers/bedrock_test.go
  - go.mod
  - go.sum
autonomous: true

user_setup:
  - service: aws
    why: "AWS Bedrock access for integration testing"
    env_vars:
      - name: AWS_ACCESS_KEY_ID
        source: "AWS Console -> IAM -> Users -> Security credentials"
      - name: AWS_SECRET_ACCESS_KEY
        source: "AWS Console -> IAM -> Users -> Security credentials"
      - name: AWS_REGION
        source: "Set to region with Bedrock access (e.g., us-west-2)"
    dashboard_config:
      - task: "Enable Bedrock model access"
        location: "AWS Console -> Bedrock -> Model access -> Request access"

must_haves:
  truths:
    - "BedrockProvider signs requests with AWS SigV4"
    - "Bedrock requests include anthropic_version: bedrock-2023-05-31 in body"
    - "BedrockProvider returns false for SupportsTransparentAuth"
    - "GetEndpointPath returns model-in-URL path for Bedrock"
  artifacts:
    - path: "internal/providers/bedrock.go"
      provides: "AWS Bedrock provider with SigV4 signing"
      contains: "v4.NewSigner"
    - path: "internal/providers/bedrock_test.go"
      provides: "Unit tests for Bedrock provider"
  key_links:
    - from: "internal/providers/bedrock.go"
      to: "aws-sdk-go-v2/aws/signer/v4"
      via: "SignHTTP call"
      pattern: "signer\\.SignHTTP"
---

<objective>
Implement AWS Bedrock provider with SigV4 request signing using the official AWS SDK v2.

Purpose: Enable cc-relay to route requests to AWS Bedrock Claude models with proper AWS authentication.
Output: BedrockProvider implementation with SigV4 signing, body transformation, endpoint path routing, and comprehensive unit tests.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-cloud-providers/06-RESEARCH.md
@internal/providers/base.go
@internal/providers/ollama.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AWS SDK v2 dependencies</name>
  <files>go.mod, go.sum</files>
  <action>
Install required AWS SDK v2 packages:

```bash
go get github.com/aws/aws-sdk-go-v2/config
go get github.com/aws/aws-sdk-go-v2/aws/signer/v4
go get github.com/aws/aws-sdk-go-v2/credentials
```

These provide:
- config: Default credential chain loading
- signer/v4: SigV4 HTTP request signing
- credentials: Static credential provider (for testing)

Run `go mod tidy` after installation.
  </action>
  <verify>go mod tidy && go build ./... compiles</verify>
  <done>AWS SDK v2 packages installed in go.mod</done>
</task>

<task type="auto">
  <name>Task 2: Implement BedrockProvider with body transformation and endpoint path</name>
  <files>internal/providers/bedrock.go</files>
  <action>
Create BedrockProvider following the pattern from RESEARCH.md:

```go
package providers

import (
    "bytes"
    "context"
    "crypto/sha256"
    "encoding/hex"
    "encoding/json"
    "fmt"
    "io"
    "net/http"
    "time"

    "github.com/aws/aws-sdk-go-v2/aws"
    v4 "github.com/aws/aws-sdk-go-v2/aws/signer/v4"
    "github.com/aws/aws-sdk-go-v2/config"
)

const (
    BedrockOwner            = "bedrock"
    BedrockAnthropicVersion = "bedrock-2023-05-31"
    BedrockService          = "bedrock"
)

type BedrockProvider struct {
    BaseProvider
    awsConfig aws.Config
    signer    *v4.Signer
    region    string
}
```

Key implementation details:

1. **NewBedrockProvider(ctx, name, region, profile string, models, modelMapping):**
   - Use config.LoadDefaultConfig with region and optional profile
   - Create v4.NewSigner()
   - Set baseURL to `https://bedrock-runtime.{region}.amazonaws.com`

2. **Authenticate(req, _ string) error:**
   - Read request body, compute SHA256 hash
   - Restore body with io.NopCloser(bytes.NewReader(bodyBytes))
   - Set req.URL.RawPath = req.URL.EscapedPath() (prevents signature mismatch)
   - Call p.signer.SignHTTP(ctx, creds, req, payloadHash, "bedrock", p.region, time.Now())

3. **TransformRequestBody(body []byte) ([]byte, error):**
   - Parse body as JSON map
   - Inject `"anthropic_version": "bedrock-2023-05-31"` into the body
   - Re-serialize and return
   - This is CRITICAL for Bedrock compatibility

```go
func (p *BedrockProvider) TransformRequestBody(body []byte) ([]byte, error) {
    var reqBody map[string]interface{}
    if err := json.Unmarshal(body, &reqBody); err != nil {
        return nil, fmt.Errorf("failed to parse request body: %w", err)
    }

    // Inject Bedrock-specific anthropic_version
    reqBody["anthropic_version"] = BedrockAnthropicVersion

    return json.Marshal(reqBody)
}
```

4. **GetEndpointPath(model string) string:**
   - Return `/model/{model}/invoke` for non-streaming
   - For streaming: `/model/{model}/invoke-with-response-stream`
   - The proxy handler will use this to construct the full URL

```go
func (p *BedrockProvider) GetEndpointPath(model string, streaming bool) string {
    if streaming {
        return fmt.Sprintf("/model/%s/invoke-with-response-stream", model)
    }
    return fmt.Sprintf("/model/%s/invoke", model)
}
```

5. **SupportsTransparentAuth() bool:** Return false (uses AWS creds, not client tokens)

6. **sha256Hex(data []byte) string:** Helper to compute hex-encoded SHA256
  </action>
  <verify>go build ./internal/providers/... compiles</verify>
  <done>BedrockProvider struct with Authenticate method using SigV4, TransformRequestBody injecting anthropic_version, and GetEndpointPath for model-in-URL routing</done>
</task>

<task type="auto">
  <name>Task 3: Add BedrockProvider unit tests</name>
  <files>internal/providers/bedrock_test.go</files>
  <action>
Create comprehensive unit tests:

1. **TestNewBedrockProvider:**
   - Verify name, baseURL format, owner
   - Verify region stored correctly

2. **TestBedrockProvider_Authenticate:**
   - Use static credentials for test (aws.Credentials struct)
   - Create mock request
   - Call Authenticate
   - Verify Authorization header is set (SigV4 format starts with "AWS4-HMAC-SHA256")
   - Verify X-Amz-Date header is set

3. **TestBedrockProvider_TransformRequestBody:**
   - Test with standard Anthropic request body
   - Verify `anthropic_version: "bedrock-2023-05-31"` is injected
   - Verify existing fields are preserved
   - Test with empty body (should still work)
   - Test with malformed JSON (should return error)

4. **TestBedrockProvider_GetEndpointPath:**
   - Test with model "anthropic.claude-sonnet-4-5-20250929-v1:0"
   - Verify non-streaming returns `/model/anthropic.claude-sonnet-4-5-20250929-v1:0/invoke`
   - Verify streaming returns `/model/anthropic.claude-sonnet-4-5-20250929-v1:0/invoke-with-response-stream`

5. **TestBedrockProvider_SupportsTransparentAuth:**
   - Verify returns false

6. **TestBedrockProvider_BaseProvider:**
   - Test inherited methods: Name(), BaseURL(), Owner(), ListModels()

7. **TestSha256Hex:**
   - Test known input produces expected hash

Use table-driven tests where appropriate. Mock the AWS config loading in tests by providing static credentials directly to avoid needing real AWS credentials in unit tests.

Create a helper for test setup:
```go
func newTestBedrockProvider(region string) *BedrockProvider {
    // Use static credentials for testing
    staticCreds := aws.CredentialsProviderFunc(func(ctx context.Context) (aws.Credentials, error) {
        return aws.Credentials{
            AccessKeyID:     "test-key",
            SecretAccessKey: "test-secret",
            Source:          "test",
        }, nil
    })

    return &BedrockProvider{
        BaseProvider: NewBaseProvider("test-bedrock",
            fmt.Sprintf("https://bedrock-runtime.%s.amazonaws.com", region),
            BedrockOwner, nil),
        awsConfig: aws.Config{
            Region:      region,
            Credentials: staticCreds,
        },
        signer: v4.NewSigner(),
        region: region,
    }
}
```
  </action>
  <verify>go test ./internal/providers/... -v -run Bedrock passes</verify>
  <done>Unit tests cover constructor, authentication, body transformation, endpoint path, and inherited methods</done>
</task>

</tasks>

<verification>
1. `go build ./...` - compiles without errors
2. `go test ./internal/providers/... -v -run Bedrock` - all Bedrock tests pass
3. `task lint` - no linter errors
4. `go test ./internal/providers/... -cover` - coverage >80%
</verification>

<success_criteria>
- AWS SDK v2 packages installed
- BedrockProvider implements Provider interface
- Authenticate method signs requests with SigV4
- TransformRequestBody injects `anthropic_version: "bedrock-2023-05-31"`
- GetEndpointPath returns correct model-in-URL paths
- Unit tests pass without real AWS credentials
- SupportsTransparentAuth returns false
</success_criteria>

<output>
After completion, create `.planning/phases/06-cloud-providers/06-02-SUMMARY.md`
</output>
