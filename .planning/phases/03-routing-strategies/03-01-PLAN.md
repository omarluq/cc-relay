---
phase: 03-routing-strategies
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/router/router.go
  - internal/router/router_test.go
  - internal/config/config.go
  - internal/config/config_test.go
autonomous: true

must_haves:
  truths:
    - "ProviderRouter interface exists with Select and Name methods"
    - "ProviderInfo struct wraps providers with routing metadata"
    - "RoutingConfig struct exists in config package"
    - "Default routing strategy is failover"
  artifacts:
    - path: "internal/router/router.go"
      provides: "ProviderRouter interface, ProviderInfo struct, error types, strategy constants"
      exports: ["ProviderRouter", "ProviderInfo", "NewRouter", "ErrNoProviders", "ErrAllProvidersUnhealthy"]
      min_lines: 60
    - path: "internal/config/config.go"
      provides: "RoutingConfig struct with strategy field"
      contains: "type RoutingConfig struct"
  key_links:
    - from: "internal/router/router.go"
      to: "internal/providers/provider.go"
      via: "ProviderInfo.Provider field"
      pattern: "providers\\.Provider"
    - from: "internal/config/config.go"
      to: "internal/router/router.go"
      via: "Strategy field maps to router constants"
      pattern: "Strategy.*string"
---

<objective>
Create the ProviderRouter interface foundation and RoutingConfig structure

Purpose: Establish the routing abstraction layer that all strategy implementations will implement, mirroring the existing KeySelector pattern in keypool. This provides the contract for provider selection.

Output:
- internal/router/router.go with ProviderRouter interface, ProviderInfo struct, strategy constants, error types
- RoutingConfig struct added to internal/config/config.go
- Unit tests for factory function and config helpers
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-routing-strategies/03-RESEARCH.md
@.planning/phases/03-routing-strategies/03-CONTEXT.md

# Codebase patterns to follow
@internal/keypool/selector.go
@internal/providers/provider.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProviderRouter interface and types</name>
  <files>internal/router/router.go, internal/router/router_test.go</files>
  <action>
Create internal/router/router.go with:

1. Package doc comment explaining provider-level routing (distinct from key selection)

2. ProviderRouter interface (mirror KeySelector pattern):
   - `Select(ctx context.Context, providers []ProviderInfo) (ProviderInfo, error)` - choose provider
   - `Name() string` - return strategy name for logging/config

3. ProviderInfo struct wrapping provider with routing metadata:
   - `Provider providers.Provider` - the actual provider
   - `Weight int` - for weighted strategies
   - `Priority int` - for failover ordering (higher = first)
   - `IsHealthy func() bool` - health check closure (Phase 4 integration point)

4. Strategy constants:
   - `StrategyRoundRobin = "round_robin"`
   - `StrategyWeightedRoundRobin = "weighted_round_robin"`
   - `StrategyShuffle = "shuffle"`
   - `StrategyFailover = "failover"`

5. Common errors (sentinel errors pattern):
   - `ErrNoProviders = errors.New("router: no providers configured")`
   - `ErrAllProvidersUnhealthy = errors.New("router: all providers unhealthy")`

6. NewRouter factory function (stub that returns error for now - implementations added in later plans):
   - Takes strategy string and timeout duration
   - Returns (ProviderRouter, error)
   - Supports "", "failover" as default (return nil, fmt.Errorf for now)

7. Helper function `FilterHealthy(providers []ProviderInfo) []ProviderInfo` using lo.Filter

Create internal/router/router_test.go with:
- Test that NewRouter returns error for unknown strategy
- Test that FilterHealthy filters correctly
- Test strategy constant values match expected strings
  </action>
  <verify>
```bash
cd /home/omarluq/sandbox/go/cc-relay && go build ./internal/router/...
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/router/... -v
```
  </verify>
  <done>
- ProviderRouter interface defined with Select and Name methods
- ProviderInfo struct contains Provider, Weight, Priority, IsHealthy fields
- Four strategy constants defined
- Two sentinel errors defined
- NewRouter factory exists (returns error for unimplemented strategies)
- FilterHealthy helper uses lo.Filter
- Tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RoutingConfig to config package</name>
  <files>internal/config/config.go, internal/config/config_test.go</files>
  <action>
Modify internal/config/config.go to add:

1. RoutingConfig struct:
```go
// RoutingConfig defines routing strategy behavior.
type RoutingConfig struct {
    Strategy        string `yaml:"strategy"`         // round_robin, weighted_round_robin, shuffle, failover
    FailoverTimeout int    `yaml:"failover_timeout"` // Milliseconds, default 5000
    Debug           bool   `yaml:"debug"`            // Enable debug headers (X-CC-Relay-*)
}
```

2. Add Routing field to main Config struct:
```go
type Config struct {
    // ... existing fields
    Routing   RoutingConfig    `yaml:"routing"`
}
```

3. Helper methods on RoutingConfig:
- `GetEffectiveStrategy() string` - returns "failover" if Strategy is empty
- `GetFailoverTimeoutOption() mo.Option[time.Duration]` - returns timeout as duration Option
- `IsDebugEnabled() bool` - returns Debug field value

Add tests to internal/config/config_test.go:
- Test GetEffectiveStrategy returns "failover" for empty strategy
- Test GetEffectiveStrategy returns configured strategy
- Test GetFailoverTimeoutOption returns None for zero/negative values
- Test GetFailoverTimeoutOption returns Some with correct duration
  </action>
  <verify>
```bash
cd /home/omarluq/sandbox/go/cc-relay && go build ./internal/config/...
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/config/... -v -run TestRouting
```
  </verify>
  <done>
- RoutingConfig struct added with Strategy, FailoverTimeout, Debug fields
- Config struct has Routing field
- GetEffectiveStrategy returns "failover" as default
- GetFailoverTimeoutOption uses mo.Option pattern
- IsDebugEnabled helper exists
- Tests verify default behavior and Option handling
  </done>
</task>

</tasks>

<verification>
```bash
# All packages build
cd /home/omarluq/sandbox/go/cc-relay && go build ./...

# All tests pass
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/router/... ./internal/config/... -v

# Linters pass
cd /home/omarluq/sandbox/go/cc-relay && task lint
```
</verification>

<success_criteria>
- ProviderRouter interface exists in internal/router/router.go
- ProviderInfo struct wraps providers.Provider with Weight, Priority, IsHealthy
- RoutingConfig struct exists in internal/config/config.go
- Default strategy is "failover"
- FilterHealthy uses lo.Filter
- All tests pass
- Linters pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-routing-strategies/03-01-SUMMARY.md`
</output>
