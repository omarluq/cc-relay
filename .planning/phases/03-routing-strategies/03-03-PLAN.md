---
phase: 03-routing-strategies
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - internal/router/weighted_round_robin.go
  - internal/router/weighted_round_robin_test.go
  - internal/router/router.go
autonomous: true

must_haves:
  truths:
    - "Weighted round-robin distributes requests proportionally to weights"
    - "Provider with weight 3 gets 3x traffic of provider with weight 1"
    - "Default weight is 1 when not specified"
    - "Strategy uses smooth Nginx algorithm for even distribution"
  artifacts:
    - path: "internal/router/weighted_round_robin.go"
      provides: "WeightedRoundRobinRouter with smooth algorithm"
      exports: ["WeightedRoundRobinRouter", "NewWeightedRoundRobinRouter"]
      min_lines: 60
  key_links:
    - from: "internal/router/weighted_round_robin.go"
      to: "internal/router/router.go"
      via: "implements ProviderRouter interface"
      pattern: "func.*Select.*ProviderInfo"
    - from: "internal/router/weighted_round_robin.go"
      to: "github.com/samber/lo"
      via: "lo.SumBy for total weight"
      pattern: "lo\\.SumBy"
---

<objective>
Implement WeightedRoundRobinRouter strategy

Purpose: Provide proportional load distribution where providers with higher weights receive proportionally more traffic. Uses the smooth weighted round-robin algorithm from Nginx for even distribution.

Output:
- internal/router/weighted_round_robin.go with Nginx smooth algorithm
- Unit tests verifying proportional distribution
- NewRouter factory updated to create this strategy
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-routing-strategies/03-RESEARCH.md
@.planning/phases/03-routing-strategies/03-01-SUMMARY.md

# Pattern reference
@internal/router/router.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement WeightedRoundRobinRouter</name>
  <files>internal/router/weighted_round_robin.go, internal/router/weighted_round_robin_test.go</files>
  <action>
Create internal/router/weighted_round_robin.go implementing Nginx smooth weighted round-robin:

1. WeightedRoundRobinRouter struct:
   - `mu sync.Mutex` - protects state
   - `currentWeights []int` - current weight state per provider
   - `lastProviderIDs []string` - track if provider list changed (by Provider.Name())

2. NewWeightedRoundRobinRouter() constructor

3. Select method implementing smooth algorithm:
   - Return ErrNoProviders if providers slice is empty
   - Filter to healthy providers using FilterHealthy helper
   - Return ErrAllProvidersUnhealthy if no healthy providers
   - Lock mutex for state access
   - Check if provider list changed (compare provider names with lastProviderIDs)
   - If changed, reinitialize currentWeights slice and lastProviderIDs
   - Calculate totalWeight using lo.SumBy:
     ```go
     totalWeight := lo.SumBy(healthy, func(p ProviderInfo) int {
         if p.Weight <= 0 {
             return 1 // Default weight
         }
         return p.Weight
     })
     ```
   - Smooth algorithm:
     1. Add configured weight to each currentWeight
     2. Find index with highest currentWeight
     3. Subtract totalWeight from winner's currentWeight
     4. Return winner

4. Name() returns StrategyWeightedRoundRobin

5. Helper for getting effective weight:
   ```go
   func getEffectiveWeight(p ProviderInfo) int {
       if p.Weight <= 0 {
           return 1
       }
       return p.Weight
   }
   ```

Create internal/router/weighted_round_robin_test.go:
- Test returns ErrNoProviders for empty slice
- Test returns ErrAllProvidersUnhealthy when all unhealthy
- Test equal weights (3 providers, weight 1 each) -> equal distribution
- Test proportional weights (A:3, B:2, C:1) -> A gets ~50%, B gets ~33%, C gets ~17%
- Test default weight is 1 when Weight=0
- Test skips unhealthy providers (proportions adjust)
- Test reinitializes when provider list changes
- Test concurrent safety
  </action>
  <verify>
```bash
cd /home/omarluq/sandbox/go/cc-relay && go build ./internal/router/...
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/router/... -v -run TestWeighted
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/router/... -race -run TestWeighted
```
  </verify>
  <done>
- WeightedRoundRobinRouter uses Nginx smooth algorithm
- Distribution is proportional to weights over time
- Default weight is 1 for unspecified/zero weights
- Reinitializes state when provider list changes
- Thread-safe under concurrent load
- Tests verify proportional distribution within tolerance
  </done>
</task>

<task type="auto">
  <name>Task 2: Update NewRouter factory for weighted</name>
  <files>internal/router/router.go, internal/router/router_test.go</files>
  <action>
Update internal/router/router.go NewRouter factory:

Change the weighted case from error to implementation:
```go
case StrategyWeightedRoundRobin:
    return NewWeightedRoundRobinRouter(), nil
```

Update internal/router/router_test.go:
- Test NewRouter("weighted_round_robin", 0) returns WeightedRoundRobinRouter
- Verify Name() returns correct strategy name
  </action>
  <verify>
```bash
cd /home/omarluq/sandbox/go/cc-relay && go build ./internal/router/...
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/router/... -v -run TestNewRouter
```
  </verify>
  <done>
- NewRouter creates WeightedRoundRobinRouter for "weighted_round_robin"
- Factory test verifies correct type returned
  </done>
</task>

</tasks>

<verification>
```bash
# All packages build
cd /home/omarluq/sandbox/go/cc-relay && go build ./...

# All router tests pass
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/router/... -v

# Race detector passes
cd /home/omarluq/sandbox/go/cc-relay && go test ./internal/router/... -race

# Linters pass
cd /home/omarluq/sandbox/go/cc-relay && task lint
```
</verification>

<success_criteria>
- WeightedRoundRobinRouter distributes proportionally to weights
- Uses lo.SumBy for total weight calculation
- Default weight is 1 when not specified
- Distribution is smooth (Nginx algorithm)
- Thread-safe under concurrent load
- NewRouter creates correct instance
- All tests pass including race detector
- Linters pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-routing-strategies/03-03-SUMMARY.md`
</output>
