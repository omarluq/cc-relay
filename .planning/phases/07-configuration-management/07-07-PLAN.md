---
phase: 07-configuration-management
plan: 07-07
title: Fix Copilot Code Review Issues
wave: 1
depends_on: []
files_modified:
  - internal/config/validator.go
  - internal/config/validator_test.go
  - internal/config/watcher.go
  - internal/config/watcher_test.go
autonomous: true
gap_closure: true
gap_source: "Copilot PR review #59 feedback"
---

# 07-07: Fix Copilot Code Review Issues

## Objective

Address all code quality issues identified by GitHub Copilot in PR #59 review.

## Issues from Copilot Review

### Issue 1: `string(rune('0'+index))` Bug (Critical)

**Problem:** `string(rune('0'+index))` only works for indices 0-9. For index >= 10, produces incorrect Unicode characters (e.g., index=10 produces ":" instead of "10").

**Files affected:**
- `internal/config/validator.go` - prefix functions for error messages
- Test files with similar patterns

**Fix:** Replace with `strconv.Itoa(index)` or `fmt.Sprintf("%d", index)`

### Issue 2: String Concatenation Performance

**Problem:** Multiple string concatenations create temporary strings.

**Files affected:**
- `internal/config/validator.go` - error prefix construction

**Fix:** Use `fmt.Sprintf` for single-operation string construction:
```go
// Before
return "provider[" + name + "].keys[" + string(rune('0'+index)) + "]." + field

// After
return fmt.Sprintf("provider[%s].keys[%d].%s", name, index, field)
```

### Issue 3: Goroutine Leak in Watcher Timer Callback

**Problem:** When watcher context is canceled, `cleanupTimer` stops the timer. But if the timer has already fired, the goroutine from `time.AfterFunc` may still call `triggerReload()` after watcher cleanup.

**File:** `internal/config/watcher.go`

**Fix:** Add check in timer callback to verify watcher is still active before calling `triggerReload()`:
```go
time.AfterFunc(w.debounce, func() {
    select {
    case <-w.ctx.Done():
        return // Watcher is closed, don't trigger reload
    default:
        w.triggerReload()
    }
})
```

Or use `sync.Mutex` to guard the callback.

## Tasks

<task id="1">
Read internal/config/validator.go and identify all instances of:
- `string(rune('0'+index))` or similar patterns
- String concatenation in prefix/error message functions
</task>

<task id="2">
Fix validator.go:
- Replace all `string(rune('0'+...))` with `strconv.Itoa(...)`
- Convert prefix functions to use `fmt.Sprintf` for cleaner construction
- Add `import "strconv"` if not present
</task>

<task id="3">
Read internal/config/validator_test.go and identify any `string(rune('0'+i))` patterns.
Fix with `strconv.Itoa(i)`.
</task>

<task id="4">
Read internal/config/watcher.go and locate the `time.AfterFunc` callback (around line 154-159).
Add context check before `triggerReload()` to prevent goroutine leak.
</task>

<task id="5">
Search for any other occurrences of this pattern in the codebase:
```bash
grep -r "rune('0'" internal/
```
Fix any additional instances found.
</task>

<task id="6">
Run tests to verify fixes don't break functionality:
```bash
go test ./internal/config/... -v
```
</task>

<task id="7">
Run linter to ensure no new issues:
```bash
golangci-lint run ./internal/config/...
```
</task>

## Verification

- [ ] No `string(rune('0'+...))` patterns remain in config package
- [ ] Prefix functions use `fmt.Sprintf` for string construction
- [ ] Watcher timer callback checks context before triggering reload
- [ ] All tests pass
- [ ] Linter passes

## Must-Haves

1. All index-to-string conversions handle values >= 10 correctly
2. No potential goroutine leaks in watcher cleanup
3. All existing tests pass
4. No linter warnings in modified files
