---
phase: 07-configuration-management
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - docs-site/content/en/docs/configuration.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "English documentation mentions TOML format support"
    - "English documentation shows TOML config examples with tabs"
    - "Hot-reload feature documented with actual behavior (not 'planned')"
    - "File locations mention both .yaml and .toml extensions"
    - "Environment variable expansion documented for both formats"
  artifacts:
    - path: "docs-site/content/en/docs/configuration.md"
      provides: "Configuration documentation with TOML and hot-reload"
      contains:
        - "TOML"
        - ".toml"
        - "tabs items"
        - "hot-reload"
        - "fsnotify"
  key_links:
    - from: "docs-site/content/en/docs/configuration.md"
      to: "internal/config/loader.go"
      via: "documents Format type and extension detection"
      pattern: "TOML|toml"
    - from: "docs-site/content/en/docs/configuration.md"
      to: "internal/config/watcher.go"
      via: "documents Watcher behavior"
      pattern: "hot-reload|automatic reload|debounce"
---

<objective>
Update English configuration documentation to reflect implemented Phase 7 features: TOML format support and hot-reload.

Purpose: Close documentation gaps where CONF-02 (TOML support) and CONF-05 (hot-reload) are implemented but not documented.

Output: Updated configuration.md with:
- TOML format mentioned alongside YAML
- Tabbed examples showing both YAML and TOML
- Hot-reload section describing actual implemented behavior
- File location docs including .toml extension
</objective>

<execution_context>
@/home/omarluq/.claude/get-shit-done/workflows/execute-plan.md
@/home/omarluq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-configuration-management/07-04-SUMMARY.md

# Implementation references for accurate documentation
@internal/config/loader.go
@internal/config/watcher.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update configuration format documentation with TOML support</name>
  <files>docs-site/content/en/docs/configuration.md</files>
  <action>
Update the English configuration documentation to document TOML support:

1. **Update opening paragraph** (line ~6):
   - Change "CC-Relay is configured via YAML files" to "CC-Relay is configured via YAML or TOML files"

2. **Update Configuration File Location section** (around line 8-15):
   - Add `.toml` extensions to file location list:
     ```
     1. `./config.yaml` or `./config.toml` (current directory)
     2. `~/.config/cc-relay/config.yaml` or `~/.config/cc-relay/config.toml`
     3. Path specified via `--config` flag
     ```
   - Add note: "The format is automatically detected from the file extension (`.yaml`, `.yml`, or `.toml`)."

3. **Update Environment Variable Expansion section** (around line 22-32):
   - Add TOML example alongside YAML using Hextra tabs shortcode:
   ```
   {{< tabs items="YAML,TOML" >}}
     {{< tab >}}
   ```yaml
   providers:
     - name: "anthropic"
       type: "anthropic"
       keys:
         - key: "${ANTHROPIC_API_KEY}"  # Expanded at load time
   ```
     {{< /tab >}}
     {{< tab >}}
   ```toml
   [[providers]]
   name = "anthropic"
   type = "anthropic"

   [[providers.keys]]
   key = "${ANTHROPIC_API_KEY}"  # Expanded at load time
   ```
     {{< /tab >}}
   {{< /tabs >}}
   ```

4. **Update Complete Configuration Reference section** (around line 34-165):
   - Use tabs to show both YAML and TOML versions of the complete config
   - The TOML version should use:
     - `[[providers]]` for array of tables
     - `[server]`, `[logging]`, `[cache]`, `[routing]` for sections
     - `[cache.ristretto]`, `[cache.olric]` for nested sections
     - `providers.keys` = array of inline tables for keys
  </action>
  <verify>
   - grep -c "TOML" docs-site/content/en/docs/configuration.md returns > 5
   - grep -c "\.toml" docs-site/content/en/docs/configuration.md returns > 3
   - grep -c "tabs items" docs-site/content/en/docs/configuration.md returns >= 1
  </verify>
  <done>
   - Opening paragraph mentions both YAML and TOML
   - File locations include .toml extensions
   - Environment variable example shows both formats with tabs
   - Complete config reference shows both formats with tabs
  </done>
</task>

<task type="auto">
  <name>Task 2: Document hot-reload feature with actual implementation details</name>
  <files>docs-site/content/en/docs/configuration.md</files>
  <action>
Replace the incorrect "Hot Reloading" section (around line 641-643) that says "planned for a future release" with accurate documentation:

1. **Replace the Hot Reloading section** with:

```markdown
## Hot Reloading

CC-Relay automatically detects and applies configuration changes without requiring a restart. This enables zero-downtime configuration updates.

### How It Works

CC-Relay uses [fsnotify](https://github.com/fsnotify/fsnotify) to monitor the config file for changes:

1. **File watching**: The parent directory is monitored to properly detect atomic writes (temp file + rename pattern used by most editors)
2. **Debouncing**: Multiple rapid file events are coalesced with a 100ms debounce delay to handle editor save behavior
3. **Atomic swap**: New configuration is loaded and swapped atomically using Go's `sync/atomic.Pointer`
4. **In-flight preservation**: Requests in progress continue with the old configuration; new requests use the updated configuration

### Events That Trigger Reload

| Event | Triggers Reload |
|-------|-----------------|
| File write | Yes |
| File create (atomic rename) | Yes |
| File chmod | No (ignored) |
| Other file in directory | No (ignored) |

### Logging

When hot-reload occurs, you'll see log messages:

```
INF config file reloaded path=/path/to/config.yaml
INF config hot-reloaded successfully
```

If the new configuration is invalid:

```
ERR failed to reload config path=/path/to/config.yaml error="validation error"
```

Invalid configurations are rejected and the proxy continues with the previous valid configuration.

### Limitations

- **Provider changes**: Adding or removing providers requires a restart (routing infrastructure is initialized at startup)
- **Listen address**: Changing `server.listen` requires a restart
- **gRPC address**: Changing gRPC management API address requires a restart

Configuration options that can be hot-reloaded:
- Logging level and format
- Rate limits on existing keys
- Health check intervals
- Routing strategy weights and priorities
```

2. **Update the "Validating Configuration" section** to mention hot-reload validation:
   Add after the validate command:
   ```markdown
   **Tip**: Always validate configuration changes before deploying. Hot-reload will reject invalid configurations, but validation catches errors before they reach production.
   ```
  </action>
  <verify>
   - grep -c "fsnotify" docs-site/content/en/docs/configuration.md returns >= 1
   - grep -c "debounce" docs-site/content/en/docs/configuration.md returns >= 1
   - grep -c "atomic" docs-site/content/en/docs/configuration.md returns >= 1
   - grep "planned for a future release" docs-site/content/en/docs/configuration.md returns empty (text removed)
  </verify>
  <done>
   - Hot-reload section accurately describes implemented behavior
   - fsnotify, debouncing, and atomic swap documented
   - Trigger events table included
   - Log message examples provided
   - Limitations clearly stated
   - "Planned for future release" text removed
  </done>
</task>

<task type="auto">
  <name>Task 3: Add TOML example configurations</name>
  <files>docs-site/content/en/docs/configuration.md</files>
  <action>
Update the "Example Configurations" section (around line 566-631) to show TOML alternatives:

1. **Minimal Single Provider** - Add tabs:
```markdown
### Minimal Single Provider

{{< tabs items="YAML,TOML" >}}
  {{< tab >}}
```yaml
server:
  listen: "127.0.0.1:8787"

providers:
  - name: "anthropic"
    type: "anthropic"
    enabled: true
    keys:
      - key: "${ANTHROPIC_API_KEY}"
```
  {{< /tab >}}
  {{< tab >}}
```toml
[server]
listen = "127.0.0.1:8787"

[[providers]]
name = "anthropic"
type = "anthropic"
enabled = true

[[providers.keys]]
key = "${ANTHROPIC_API_KEY}"
```
  {{< /tab >}}
{{< /tabs >}}
```

2. **Multi-Provider Setup** - Add tabs with TOML version showing model_mapping as inline table

3. **Development with Debug Logging** - Add tabs with TOML version

Ensure TOML syntax is correct:
- Use `[[providers]]` for each provider in array
- Use `[[providers.keys]]` for each key in array
- Use `[section]` for single tables
- Use `key = "value"` not `key: value`
- Use `true`/`false` not `True`/`False`
  </action>
  <verify>
   - grep -c "tabs items" docs-site/content/en/docs/configuration.md returns >= 4 (env var, complete ref, and 3 examples)
   - grep "\\[\\[providers\\]\\]" docs-site/content/en/docs/configuration.md returns matches (TOML array syntax)
  </verify>
  <done>
   - All example configurations have YAML/TOML tabs
   - TOML syntax is correct (arrays, tables, inline tables)
   - Examples are equivalent between formats
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build Hugo site to verify no shortcode errors:
   ```bash
   cd docs-site && hugo --minify 2>&1 | grep -i error || echo "No errors"
   ```

2. Verify TOML is documented throughout:
   ```bash
   grep -c "TOML\|\.toml\|\[\[providers\]\]" docs-site/content/en/docs/configuration.md
   # Should return > 15
   ```

3. Verify hot-reload is properly documented:
   ```bash
   grep "planned for a future release" docs-site/content/en/docs/configuration.md
   # Should return empty (old text removed)
   grep -c "fsnotify\|debounce\|atomic" docs-site/content/en/docs/configuration.md
   # Should return >= 3
   ```

4. Verify tabs shortcode usage:
   ```bash
   grep -c "{{< tabs items" docs-site/content/en/docs/configuration.md
   # Should return >= 4
   ```
</verification>

<success_criteria>
1. English configuration.md mentions TOML support in opening paragraph
2. File location section includes .toml extensions
3. At least 4 tabbed YAML/TOML examples (env var, complete ref, 3 example configs)
4. Hot-reload section describes actual implementation (fsnotify, debounce, atomic swap)
5. "Planned for future release" text removed
6. Hugo builds without shortcode errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-configuration-management/07-05-SUMMARY.md`
</output>
