---
phase: 07-configuration-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - internal/config/config.go
  - internal/health/config.go
  - internal/cache/config.go
autonomous: true

must_haves:
  truths:
    - "go mod tidy shows both fsnotify and go-toml/v2 installed"
    - "All config structs have both yaml and toml tags"
  artifacts:
    - path: "go.mod"
      provides: "fsnotify and go-toml/v2 dependencies"
      contains: "github.com/fsnotify/fsnotify"
    - path: "internal/config/config.go"
      provides: "Config structs with dual tags"
      contains: "toml:"
    - path: "internal/health/config.go"
      provides: "Health config with dual tags"
      contains: "toml:"
    - path: "internal/cache/config.go"
      provides: "Cache config with dual tags"
      contains: "toml:"
  key_links:
    - from: "go.mod"
      to: "internal/config/config.go"
      via: "go-toml/v2 import"
      pattern: "pelletier/go-toml"
---

<objective>
Install configuration management dependencies and add TOML struct tags to all config types.

Purpose: Enable TOML config file support (CONF-02) alongside existing YAML support. This is a foundation task that must complete before format detection and hot-reload can be implemented.

Output:
- fsnotify v1.9.0 and pelletier/go-toml/v2 installed
- All config structs have both `yaml` and `toml` struct tags
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-configuration-management/07-RESEARCH.md
@internal/config/config.go
@internal/health/config.go
@internal/cache/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install fsnotify and go-toml/v2</name>
  <files>go.mod, go.sum</files>
  <action>
Install required dependencies for configuration management:

```bash
go get github.com/fsnotify/fsnotify@v1.9.0
go get github.com/pelletier/go-toml/v2
go mod tidy
```

fsnotify provides cross-platform file system notifications (for hot-reload in Plan 03).
go-toml/v2 is 2.7-5.1x faster than BurntSushi/toml and follows encoding/json conventions.
  </action>
  <verify>
`go list -m github.com/fsnotify/fsnotify` shows v1.9.0
`go list -m github.com/pelletier/go-toml/v2` shows v2.x
`go mod tidy` exits 0
  </verify>
  <done>Both dependencies appear in go.mod with correct versions</done>
</task>

<task type="auto">
  <name>Task 2: Add TOML tags to all config structs</name>
  <files>internal/config/config.go, internal/health/config.go, internal/cache/config.go</files>
  <action>
Add `toml` struct tags alongside existing `yaml` tags for all config struct fields.

**In internal/config/config.go, update ALL struct fields:**

```go
// Example pattern - apply to ALL fields in:
// Config, RoutingConfig, ServerConfig, AuthConfig, ProviderConfig,
// PoolingConfig, KeyConfig, LoggingConfig, DebugOptions

type Config struct {
    Providers []ProviderConfig `yaml:"providers" toml:"providers"`
    Routing   RoutingConfig    `yaml:"routing" toml:"routing"`
    Logging   LoggingConfig    `yaml:"logging" toml:"logging"`
    Health    health.Config    `yaml:"health" toml:"health"`
    Server    ServerConfig     `yaml:"server" toml:"server"`
    Cache     cache.Config     `yaml:"cache" toml:"cache"`
}

type RoutingConfig struct {
    ModelMapping    map[string]string `yaml:"model_mapping" toml:"model_mapping"`
    Strategy        string            `yaml:"strategy" toml:"strategy"`
    DefaultProvider string            `yaml:"default_provider" toml:"default_provider"`
    FailoverTimeout int               `yaml:"failover_timeout" toml:"failover_timeout"`
    Debug           bool              `yaml:"debug" toml:"debug"`
}

// ... continue for ServerConfig, AuthConfig, ProviderConfig, PoolingConfig,
// KeyConfig, LoggingConfig, DebugOptions
```

**In internal/health/config.go, update all fields:**

```go
type CircuitBreakerConfig struct {
    FailureThreshold int `yaml:"failure_threshold" toml:"failure_threshold"`
    OpenDurationMS   int `yaml:"open_duration_ms" toml:"open_duration_ms"`
    HalfOpenProbes   int `yaml:"half_open_probes" toml:"half_open_probes"`
}

type CheckConfig struct {
    Enabled    *bool `yaml:"enabled" toml:"enabled"`
    IntervalMS int   `yaml:"interval_ms" toml:"interval_ms"`
}

type Config struct {
    HealthCheck    CheckConfig          `yaml:"health_check" toml:"health_check"`
    CircuitBreaker CircuitBreakerConfig `yaml:"circuit_breaker" toml:"circuit_breaker"`
}
```

**In internal/cache/config.go, update all fields:**

```go
type Config struct {
    Mode      Mode            `yaml:"mode" toml:"mode"`
    Olric     OlricConfig     `yaml:"olric" toml:"olric"`
    Ristretto RistrettoConfig `yaml:"ristretto" toml:"ristretto"`
}

type RistrettoConfig struct {
    NumCounters int64 `yaml:"num_counters" toml:"num_counters"`
    MaxCost     int64 `yaml:"max_cost" toml:"max_cost"`
    BufferItems int64 `yaml:"buffer_items" toml:"buffer_items"`
}

type OlricConfig struct {
    DMapName          string        `yaml:"dmap_name" toml:"dmap_name"`
    BindAddr          string        `yaml:"bind_addr" toml:"bind_addr"`
    Environment       string        `yaml:"environment" toml:"environment"`
    Addresses         []string      `yaml:"addresses" toml:"addresses"`
    Peers             []string      `yaml:"peers" toml:"peers"`
    ReplicaCount      int           `yaml:"replica_count" toml:"replica_count"`
    ReadQuorum        int           `yaml:"read_quorum" toml:"read_quorum"`
    WriteQuorum       int           `yaml:"write_quorum" toml:"write_quorum"`
    LeaveTimeout      time.Duration `yaml:"leave_timeout" toml:"leave_timeout"`
    MemberCountQuorum int32         `yaml:"member_count_quorum" toml:"member_count_quorum"`
    Embedded          bool          `yaml:"embedded" toml:"embedded"`
}
```

**IMPORTANT:**
- Keep tag values identical to yaml tag values
- Do NOT change any field names or types
- Do NOT remove yaml tags
- Preserve all existing comments and godoc
  </action>
  <verify>
`grep -c 'toml:' internal/config/config.go` shows 40+ fields with toml tags
`grep -c 'toml:' internal/health/config.go` shows 8 fields with toml tags
`grep -c 'toml:' internal/cache/config.go` shows 15+ fields with toml tags
`go build ./...` succeeds
`task test` passes
  </verify>
  <done>
All config structs have both yaml and toml tags, no existing tests broken
  </done>
</task>

</tasks>

<verification>
Run all checks to verify plan completion:

```bash
# Dependencies installed
go list -m github.com/fsnotify/fsnotify
go list -m github.com/pelletier/go-toml/v2

# TOML tags added
grep 'toml:' internal/config/config.go | head -5
grep 'toml:' internal/health/config.go | head -3
grep 'toml:' internal/cache/config.go | head -3

# Build and tests pass
go build ./...
task test
```
</verification>

<success_criteria>
1. fsnotify v1.9.0 appears in go.mod
2. pelletier/go-toml/v2 appears in go.mod
3. All config struct fields have both yaml and toml tags
4. `go build ./...` succeeds
5. All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-configuration-management/07-01-SUMMARY.md`
</output>
