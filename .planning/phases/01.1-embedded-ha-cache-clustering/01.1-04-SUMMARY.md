---
phase: 01.1-embedded-ha-cache-clustering
plan: 04
subsystem: cache
tags: [olric, clustering, integration-tests, ha, memberlist]
dependency-graph:
  requires: ["01.1-02", "01.1-03"]
  provides: ["multi-node cluster tests", "test utilities", "peer discovery"]
  affects: ["future clustering plans", "production deployment tests"]
tech-stack:
  added: ["github.com/hashicorp/memberlist"]
  patterns: ["test cluster helper", "peer discovery", "integration testing"]
key-files:
  created:
    - internal/cache/testutil.go
    - internal/cache/olric_cluster_test.go
  modified:
    - internal/cache/olric.go
    - Taskfile.yml
decisions:
  - id: CLUSTER-TEST-01
    decision: "Use integration build tag for cluster tests"
    rationale: "Cluster tests take 1-2 minutes; keep regular test suite fast"
  - id: CLUSTER-TEST-02
    decision: "Track memberlist addresses explicitly in testCacheCluster"
    rationale: "Stats API unavailable in embedded mode; cannot use MemberlistAddr()"
  - id: CLUSTER-PORT-01
    decision: "Memberlist port = Olric port + 2"
    rationale: "Match Olric defaults (3320 + 2 = 3322); avoid port conflicts"
  - id: CLUSTER-PORT-02
    decision: "Space test ports by 10"
    rationale: "Room for Olric port and memberlist port + safety margin"
metrics:
  duration: "~15 min"
  completed: "2026-01-21"
---

# Phase 01.1 Plan 04: Multi-Node Cluster Integration Tests

**One-liner:** Integration tests verifying multi-node Olric clustering with peer discovery, data replication, and graceful node departure.

## What Was Built

### 1. testutil.go - Cluster Test Utilities

Created reusable test helpers for multi-node cluster testing:

- **testCacheCluster**: Manages group of embedded Olric nodes
  - `addMember()`: Creates nodes with automatic peer discovery
  - `removeMember()`: Graceful node removal
  - `waitForConvergence()`: Polls cluster membership status
  - Tracks memberlist addresses explicitly (Stats API unavailable in embedded mode)

- **Port allocation**: Spaced by 10 to avoid Olric/memberlist overlap

### 2. olric_cluster_test.go - Integration Tests

Seven comprehensive cluster tests:

| Test | Validates |
|------|-----------|
| `TestOlricCluster_Formation` | 2-node cluster discovery |
| `TestOlricCluster_DataReplication` | Write node1, read node2 |
| `TestOlricCluster_NodeLeave` | Data survives node departure |
| `TestOlricCluster_DynamicJoin` | Node joins running cluster |
| `TestOlricCluster_ThreeNode` | 3-node full replication |
| `TestOlricCluster_WriteReadConsistency` | Multi-key consistency |
| `TestOlricCluster_TTLReplication` | TTL preserved across nodes |

### 3. olric.go Bug Fix

Fixed memberlist configuration:
- Added `github.com/hashicorp/memberlist` import
- Configure memberlist to bind to specified address (not default interface)
- Use port + 2 for memberlist (matching Olric defaults)

### 4. Taskfile Target

Added `test-cluster` task for running integration tests:
```bash
task test-cluster
```

## Commits

| Hash | Type | Description |
|------|------|-------------|
| de41a3a | test | Add testutil.go and olric_cluster_test.go |
| 122f6cd | chore | Add test-cluster task to Taskfile |
| 0a5146b | fix | Configure memberlist port and peer discovery |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Memberlist binding to wrong interface**

- **Found during:** Task 2 verification
- **Issue:** Memberlist defaulted to first non-loopback interface instead of 127.0.0.1
- **Fix:** Configure MemberlistConfig.BindAddr and BindPort in buildOlricConfig
- **Files modified:** internal/cache/olric.go
- **Commit:** 0a5146b

**2. [Rule 3 - Blocking] Olric uses two ports**

- **Found during:** Task 2 verification
- **Issue:** Olric client port conflicted with memberlist port (both trying to use same port)
- **Fix:** Use port + 2 for memberlist (matching Olric defaults 3320/3322)
- **Files modified:** internal/cache/olric.go
- **Commit:** 0a5146b

**3. [Rule 1 - Bug] MemberlistAddr() unavailable in embedded mode**

- **Found during:** Task 2 verification
- **Issue:** Stats API returns empty in embedded mode; cannot get memberlist address
- **Fix:** Track memberlist addresses explicitly in testCacheCluster
- **Files modified:** internal/cache/testutil.go
- **Commit:** 0a5146b

## Verification Results

```bash
# Regular tests pass
go test -v ./internal/cache/...
PASS ok github.com/omarluq/cc-relay/internal/cache 1.627s

# Cluster tests pass (with integration tag)
go test -tags=integration -v ./internal/cache/... -run "TestOlricCluster"
--- PASS: TestOlricCluster_Formation (11.60s)
--- PASS: TestOlricCluster_DataReplication (11.80s)
--- PASS: TestOlricCluster_NodeLeave (13.30s)
--- PASS: TestOlricCluster_DynamicJoin (27.51s)
--- PASS: TestOlricCluster_ThreeNode (17.91s)
--- PASS: TestOlricCluster_WriteReadConsistency (12.20s)
--- PASS: TestOlricCluster_TTLReplication (14.30s)
PASS ok github.com/omarluq/cc-relay/internal/cache 108.639s

# Task target works
task test-cluster
```

## HA Requirements Validation

| Requirement | Status | Evidence |
|-------------|--------|----------|
| CACHE-HA-01: Nodes discover each other | VERIFIED | Formation test passes |
| CACHE-HA-02: Data replicated across nodes | VERIFIED | DataReplication test passes |
| CACHE-HA-03: Node departure doesn't break cluster | VERIFIED | NodeLeave test passes |
| CACHE-HA-04: Dynamic node join | VERIFIED | DynamicJoin test passes |

## Next Phase Readiness

Phase 1.1 is now complete. All 4 plans executed:
- Plan 01: OlricConfig extended with HA fields
- Plan 02: buildOlricConfig helper applies HA settings
- Plan 03: ClusterInfo interface for observability
- Plan 04: Integration tests validate clustering

**Ready for:** Phase 2 or production deployment testing
