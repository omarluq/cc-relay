---
phase: 01.1-embedded-ha-cache-clustering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/cache/config.go
autonomous: true

must_haves:
  truths:
    - "OlricConfig has Environment field for memberlist preset selection"
    - "OlricConfig has ReplicaCount field for data replication"
    - "OlricConfig has ReadQuorum and WriteQuorum fields for consistency control"
    - "OlricConfig has MemberCountQuorum field for split-brain prevention"
    - "OlricConfig has LeaveTimeout field for graceful shutdown"
    - "Config validation rejects invalid quorum combinations"
  artifacts:
    - path: "internal/cache/config.go"
      provides: "Extended OlricConfig with HA clustering fields"
      contains: "Environment string"
  key_links:
    - from: "internal/cache/config.go"
      to: "internal/cache/olric.go"
      via: "OlricConfig struct fields"
      pattern: "cfg\\.Environment|cfg\\.ReplicaCount|cfg\\.WriteQuorum"
---

<objective>
Extend OlricConfig struct with HA clustering configuration fields

Purpose: Enable cc-relay to configure Olric for HA clustering with replication, quorum settings, and environment presets. These fields map directly to Olric's native clustering configuration.

Output: Updated OlricConfig struct with new fields and validation logic
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-embedded-ha-cache-clustering/01.1-RESEARCH.md

# Existing implementation
@internal/cache/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HA clustering fields to OlricConfig</name>
  <files>internal/cache/config.go</files>
  <action>
Add the following fields to the OlricConfig struct after the existing fields (Embedded):

```go
// Environment selects memberlist configuration preset.
// Valid values: "local" (development/loopback), "lan" (same datacenter), "wan" (cross-datacenter)
// Default: "local" if not specified
Environment string `yaml:"environment"`

// ReplicaCount is the number of replicas for each key.
// 1 = no replication (single copy), 2+ = replicated across nodes.
// Default: 1 (Olric default)
ReplicaCount int `yaml:"replica_count"`

// ReadQuorum is minimum successful reads required for a read response.
// Must be <= ReplicaCount. 1 = read from any replica.
// Default: 1
ReadQuorum int `yaml:"read_quorum"`

// WriteQuorum is minimum successful writes required for a write response.
// Must be <= ReplicaCount. 1 = fire-and-forget to replicas (async).
// Default: 1
WriteQuorum int `yaml:"write_quorum"`

// MemberCountQuorum is minimum cluster members required to operate.
// Prevents split-brain scenarios by refusing operations with too few nodes.
// Default: 1 (single node okay)
MemberCountQuorum int32 `yaml:"member_count_quorum"`

// LeaveTimeout is maximum time to wait for leave message broadcast during shutdown.
// Default: 5s (Olric default)
LeaveTimeout time.Duration `yaml:"leave_timeout"`
```

Add import for "time" package if not already present.
  </action>
  <verify>go build ./internal/cache/...</verify>
  <done>OlricConfig struct contains all six new HA clustering fields with proper yaml tags and documentation</done>
</task>

<task type="auto">
  <name>Task 2: Add validation for HA clustering fields</name>
  <files>internal/cache/config.go</files>
  <action>
Update the Validate() method to add validation for HA fields inside the ModeHA case:

1. Validate Environment if specified:
   - Must be one of: "", "local", "lan", "wan"
   - Empty string is valid (defaults to "local")
   - Return error: `cache: olric.environment must be "local", "lan", or "wan"`

2. Validate quorum relationships:
   - If WriteQuorum > ReplicaCount (and both > 0), return error:
     `cache: olric.write_quorum cannot exceed replica_count`
   - If ReadQuorum > ReplicaCount (and both > 0), return error:
     `cache: olric.read_quorum cannot exceed replica_count`

3. Validate MemberCountQuorum:
   - Must be >= 0 (negative is invalid)
   - Return error: `cache: olric.member_count_quorum cannot be negative`

4. Validate LeaveTimeout:
   - Must be >= 0 (negative is invalid)
   - Return error: `cache: olric.leave_timeout cannot be negative`

Note: Zero values for ReplicaCount, ReadQuorum, WriteQuorum, MemberCountQuorum are valid and will use Olric defaults (typically 1).
  </action>
  <verify>go test -v -run TestConfig ./internal/cache/... 2>/dev/null || go build ./internal/cache/...</verify>
  <done>Validate() rejects invalid environment values and quorum combinations with clear error messages</done>
</task>

<task type="auto">
  <name>Task 3: Update DefaultOlricConfig with HA defaults</name>
  <files>internal/cache/config.go</files>
  <action>
Update the DefaultOlricConfig() function to include sensible defaults for HA fields:

```go
func DefaultOlricConfig() OlricConfig {
    return OlricConfig{
        DMapName:          "cc-relay",
        Environment:       "local",
        ReplicaCount:      1,
        ReadQuorum:        1,
        WriteQuorum:       1,
        MemberCountQuorum: 1,
        LeaveTimeout:      5 * time.Second,
    }
}
```

These defaults match Olric's internal defaults and are suitable for single-node operation. Users can override for HA deployments.
  </action>
  <verify>go build ./internal/cache/...</verify>
  <done>DefaultOlricConfig returns OlricConfig with all HA fields set to sensible defaults</done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
go build ./internal/cache/...

# Existing tests pass
go test -v -short ./internal/cache/...

# Verify new fields exist in struct
grep -A 20 "type OlricConfig struct" internal/cache/config.go | grep -E "Environment|ReplicaCount|ReadQuorum|WriteQuorum|MemberCountQuorum|LeaveTimeout"
```
</verification>

<success_criteria>
- OlricConfig struct has 6 new fields: Environment, ReplicaCount, ReadQuorum, WriteQuorum, MemberCountQuorum, LeaveTimeout
- Each field has proper yaml tag and documentation comment
- Validate() rejects invalid environment values ("invalid", "production", etc.)
- Validate() rejects WriteQuorum > ReplicaCount
- Validate() rejects ReadQuorum > ReplicaCount
- Validate() rejects negative MemberCountQuorum and LeaveTimeout
- DefaultOlricConfig() returns config with all HA fields populated
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-embedded-ha-cache-clustering/01.1-01-SUMMARY.md`
</output>
