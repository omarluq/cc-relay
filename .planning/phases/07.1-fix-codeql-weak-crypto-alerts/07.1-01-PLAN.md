---
phase: 07.1-fix-codeql-weak-crypto-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/auth/apikey.go
  - internal/proxy/middleware.go
  - internal/keypool/key.go
  - internal/auth/apikey_test.go
  - internal/proxy/middleware_test.go
autonomous: true

must_haves:
  truths:
    - "CodeQL alert #1 (auth/apikey.go:22) no longer triggers"
    - "CodeQL alert #2 (keypool/key.go:71) no longer triggers"
    - "CodeQL alert #3 (proxy/middleware.go:23) no longer triggers"
    - "All existing auth tests pass"
    - "Constant-time comparison maintained"
  artifacts:
    - path: "internal/auth/apikey.go"
      provides: "API key authentication with SHA-256"
      contains: "sha256.Sum256"
    - path: "internal/proxy/middleware.go"
      provides: "Auth middleware with SHA-256"
      contains: "sha256.Sum256"
    - path: "internal/keypool/key.go"
      provides: "Key ID generation"
      contains: "sha256.Sum256"
  key_links:
    - from: "internal/auth/apikey.go"
      to: "crypto/sha256"
      via: "SHA-256 hashing for API keys"
    - from: "internal/proxy/middleware.go"
      to: "crypto/subtle"
      via: "Constant-time comparison"
---

<objective>
Fix 3 CodeQL weak cryptographic hashing alerts (CWE-327, CWE-328, CWE-916).

Purpose: Address GitHub CodeQL security alerts flagging SHA-256 as weak for sensitive data.
Output: Updated code that satisfies CodeQL's `go/weak-sensitive-data-hashing` query.

Based on CodeQL's recommendation and the specific nature of API keys (high-entropy secrets, not passwords):
- SHA-256 IS appropriate for API key hashing (it's SHA-2, not MD5/SHA1)
- The alerts trigger because CodeQL classifies API keys as "sensitive data"
- Fix: Use crypto/sha256 with proper constant-time comparison (already done)
- Alternative: Add CodeQL inline suppressions with security rationale
</objective>

<execution_context>
@/home/omarluq/.claude/get-shit-done/workflows/execute-plan.md
@/home/omarluq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-fix-codeql-weak-crypto-alerts/07.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix auth/apikey.go CodeQL alert with security annotation</name>
  <files>internal/auth/apikey.go</files>
  <action>
The SHA-256 hash is being flagged because CodeQL detects "sensitive data" (API key parameter).
For API keys (high-entropy random secrets), SHA-256 is cryptographically appropriate.

Add a CodeQL suppression comment explaining the security rationale:
- API keys have high entropy (32+ random characters), unlike passwords
- SHA-256 provides pre-image resistance for high-entropy inputs
- Constant-time comparison already prevents timing attacks
- The hash is NOT stored, only compared in memory

Add this comment above line 22:
```go
// CodeQL: API keys are high-entropy secrets (not passwords), so SHA-256 is appropriate.
// Passwords require slow hashes (bcrypt/argon2) due to limited entropy.
// API keys have sufficient entropy that SHA-256's pre-image resistance is adequate.
// #nosec codeql-go/weak-sensitive-data-hashing
```

Alternatively, ensure the code is structured so CodeQL recognizes this is not password hashing.
  </action>
  <verify>go build ./... passes, go test ./internal/auth/... passes</verify>
  <done>CodeQL alert #1 addressed with security rationale documented</done>
</task>

<task type="auto">
  <name>Task 2: Fix proxy/middleware.go CodeQL alert with security annotation</name>
  <files>internal/proxy/middleware.go</files>
  <action>
Same pattern as Task 1. The middleware pre-hashes the expected API key and uses constant-time comparison.

Add this comment above line 23:
```go
// CodeQL: API keys are high-entropy secrets (not passwords), so SHA-256 is appropriate.
// Pre-hashing at middleware creation prevents per-request hash computation.
// Constant-time comparison (subtle.ConstantTimeCompare) prevents timing attacks.
// #nosec codeql-go/weak-sensitive-data-hashing
```
  </action>
  <verify>go build ./... passes, go test ./internal/proxy/... passes</verify>
  <done>CodeQL alert #3 addressed with security rationale documented</done>
</task>

<task type="auto">
  <name>Task 3: Fix keypool/key.go CodeQL alert - non-security use case</name>
  <files>internal/keypool/key.go</files>
  <action>
The key ID generation at line 71 is NOT security-critical. It's for logging/identification only.
The first 8 characters of a SHA-256 hash provide a stable, non-reversible identifier for logs.

Add this comment above line 71:
```go
// CodeQL: This hash is for identification/logging, NOT security comparison.
// The key ID appears in logs for debugging. It's not used for authentication.
// SHA-256 provides a stable, reproducible identifier from the key material.
// #nosec codeql-go/weak-sensitive-data-hashing
```
  </action>
  <verify>go build ./... passes, go test ./internal/keypool/... passes</verify>
  <done>CodeQL alert #2 addressed with rationale that this is non-security use</done>
</task>

</tasks>

<verification>
```bash
# Build passes
go build ./...

# All tests pass
go test ./internal/auth/... -v
go test ./internal/proxy/... -v
go test ./internal/keypool/... -v

# Full test suite
task test

# Lint passes
task lint
```
</verification>

<success_criteria>
- [ ] All 3 CodeQL-flagged files updated with security annotations
- [ ] go build ./... passes
- [ ] All existing tests pass (auth, proxy, keypool)
- [ ] task lint passes
- [ ] Constant-time comparison preserved in auth code
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-fix-codeql-weak-crypto-alerts/07.1-01-SUMMARY.md`
</output>
