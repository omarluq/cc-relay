# cc-relay Example Configuration
#
# Copy this file to ~/.config/cc-relay/config.yaml and customize for your setup.
# Environment variables can be used with ${VAR_NAME} syntax.

# ============================================================================
# Server Configuration
# ============================================================================
server:
  # Address to listen on (Claude Code connects here)
  listen: "127.0.0.1:8787"

  # Request timeout in milliseconds (10 minutes default for long operations)
  timeout_ms: 600000

  # Maximum concurrent requests (0 = unlimited)
  max_concurrent: 0

  # Enable HTTP/2 cleartext (h2c) support for better multiplexing
  # HTTP/2 provides improved performance for Claude Code's concurrent tool calls
  enable_http2: true

  # --------------------------------------------------------------------------
  # Authentication
  # --------------------------------------------------------------------------
  # cc-relay supports multiple authentication methods. Enable one or more:
  #
  # 1. API Key (x-api-key header) - For Anthropic API key users
  # 2. Bearer Token (Authorization: Bearer) - Generic OAuth/token auth
  # 3. Subscription Token - For Claude Code subscription users (alias for Bearer)
  #
  # All enabled methods are tried in order; first success wins.
  auth:
    # API key authentication (optional)
    # Set this to require clients to send a specific x-api-key header
    # api_key: "${PROXY_API_KEY}"

    # Claude Code subscription token support (recommended for subscription users)
    # Enable this to accept Authorization: Bearer tokens from Claude Code
    # The token is passed through to Anthropic for validation
    allow_subscription: true

    # Alternative: use allow_bearer for generic Bearer token auth
    # allow_bearer: true
    # bearer_secret: ""  # Empty = accept any bearer token (passthrough mode)

# ============================================================================
# Routing Configuration
# ============================================================================
routing:
  # Strategy: round_robin, weighted_round_robin, shuffle, failover (default), model_based
  # - round_robin: Sequential rotation through providers
  # - weighted_round_robin: Proportional distribution by weight
  # - shuffle: Fair random ("dealing cards" pattern)
  # - failover: Priority-based with automatic retry (default)
  # - model_based: Route by model name prefix to specific providers
  strategy: "failover"

  # Timeout for failover attempts in milliseconds (default: 5000)
  failover_timeout: 5000

  # Enable debug headers (X-CC-Relay-Strategy, X-CC-Relay-Provider, X-CC-Relay-Health)
  debug: false

  # Model-based routing configuration (only used when strategy: model_based)
  # Maps model name prefixes to provider names. Uses longest prefix match.
  # model_mapping:
  #   claude-opus: anthropic      # claude-opus-* → anthropic
  #   claude-sonnet: anthropic    # claude-sonnet-* → anthropic
  #   glm-4: zai                  # glm-4* → zai
  #   qwen: ollama                # qwen* → ollama
  #   llama: ollama               # llama* → ollama

  # Default provider when no model mapping matches (only used with model_based)
  # default_provider: anthropic

# ============================================================================
# Provider Configurations
# ============================================================================
providers:
  # --------------------------------------------------------------------------
  # Anthropic Direct API (recommended primary)
  # --------------------------------------------------------------------------
  - name: "anthropic-pool"
    type: "anthropic"
    enabled: true

    # Models available from this provider (shown in /v1/models endpoint)
    models:
      - "claude-sonnet-4-5-20250514"
      - "claude-opus-4-5-20250514"
      - "claude-haiku-3-5-20241022"

    # Multiple API keys for rate limit pooling
    keys:
      - key: "${ANTHROPIC_API_KEY}"
        rpm_limit: 60 # Requests per minute
        tpm_limit: 100000 # Tokens per minute
      # Add more keys to increase throughput:
      # - key: "${ANTHROPIC_API_KEY_2}"
      #   rpm_limit: 60
      #   tpm_limit: 100000

  # --------------------------------------------------------------------------
  # Z.AI / Zhipu GLM (Anthropic-compatible, ~1/7 cost)
  # --------------------------------------------------------------------------
  - name: "zai"
    type: "zai"
    enabled: true
    base_url: "https://api.z.ai/api/anthropic"

    # Models available from Z.AI (shown in /v1/models endpoint)
    models:
      - "GLM-4.7"
      - "GLM-4.5-Air"

    keys:
      - key: "${ZAI_API_KEY}"

    # Map Anthropic model names to Z.AI models
    model_mapping:
      "claude-sonnet-4-5-20250929": "GLM-4.7"
      "claude-sonnet-4-5": "GLM-4.7"
      "claude-haiku-4-5-20251001": "GLM-4.5-Air"
      "claude-haiku-4-5": "GLM-4.5-Air"

  # --------------------------------------------------------------------------
  # Ollama (Local models)
  # Note: Limited feature support (no prompt caching, no extended thinking)
  # --------------------------------------------------------------------------
  - name: "ollama"
    type: "ollama"
    enabled: true
    base_url: "http://localhost:11434"

    model_mapping:
      "claude-sonnet-4-5-20250929": "qwen3:32b"
      "claude-sonnet-4-5": "qwen3:32b"
      "claude-haiku-4-5-20251001": "qwen3:8b"
      "claude-haiku-4-5": "qwen3:8b"

  # --------------------------------------------------------------------------
  # AWS Bedrock
  # --------------------------------------------------------------------------
  # Bedrock provides Claude access through AWS with SigV4 authentication.
  # Requires AWS credentials (via env vars, IAM role, or explicit config).
  # Note: Bedrock returns Event Stream format which cc-relay converts to SSE.
  - name: "bedrock"
    type: "bedrock"
    enabled: false

    # AWS region (required)
    aws_region: "us-east-1"

    # Explicit AWS credentials (optional - uses default credential chain if empty)
    # aws_access_key_id: "${AWS_ACCESS_KEY_ID}"
    # aws_secret_access_key: "${AWS_SECRET_ACCESS_KEY}"

    # Map Claude model names to Bedrock model IDs
    # Bedrock uses format: anthropic.{model}-v1:0
    model_mapping:
      "claude-sonnet-4-5-20250929": "anthropic.claude-sonnet-4-5-20250929-v1:0"
      "claude-sonnet-4-5": "anthropic.claude-sonnet-4-5-20250929-v1:0"
      "claude-haiku-4-5-20251001": "anthropic.claude-haiku-4-5-20251001-v1:0"

  # --------------------------------------------------------------------------
  # Azure AI Foundry
  # --------------------------------------------------------------------------
  # Azure provides Claude access through Azure AI Foundry (MAAS).
  # Uses Anthropic-compatible API format with api-version query parameter.
  - name: "azure"
    type: "azure"
    enabled: false

    # Your Azure resource name (appears before .services.ai.azure.com)
    azure_resource_name: "my-azure-resource"

    # Azure API version (default: 2024-06-01)
    azure_api_version: "2024-06-01"

    # Azure uses x-api-key for authentication (Anthropic-compatible)
    keys:
      - key: "${AZURE_API_KEY}"

    # Azure uses deployment names as model identifiers
    model_mapping:
      "claude-sonnet-4-5-20250929": "claude-sonnet-4-5"
      "claude-sonnet-4-5": "claude-sonnet-4-5"
      "claude-haiku-4-5": "claude-haiku-4-5"

  # --------------------------------------------------------------------------
  # Google Vertex AI
  # --------------------------------------------------------------------------
  # Vertex AI provides Claude access through Google Cloud.
  # Uses OAuth2 for authentication (GOOGLE_APPLICATION_CREDENTIALS or gcloud CLI).
  - name: "vertex"
    type: "vertex"
    enabled: false

    # Google Cloud project ID (required)
    gcp_project_id: "${GOOGLE_CLOUD_PROJECT}"

    # Google Cloud region (required)
    gcp_region: "us-east5"

    # Authentication via GOOGLE_APPLICATION_CREDENTIALS env var or gcloud CLI
    # No explicit auth config needed if using default credentials

    # Model mapping for Vertex AI format
    model_mapping:
      "claude-sonnet-4-5-20250929": "claude-sonnet-4-5@20250929"
      "claude-sonnet-4-5": "claude-sonnet-4-5@20250929"
      "claude-haiku-4-5-20251001": "claude-haiku-4-5@20251001"

# ============================================================================
# Cache Configuration
# ============================================================================
cache:
  # Cache mode options:
  #   - single: Local in-memory cache using Ristretto (default, best for single instance)
  #   - ha: Distributed cache using Olric (for multi-instance deployments)
  #   - disabled: No caching (passthrough mode)
  mode: single

  # Ristretto configuration (used when mode: single)
  ristretto:
    # Number of 4-bit access counters
    # Recommended: 10x expected max items for optimal admission policy
    num_counters: 1000000

    # Maximum memory for cached values (in bytes)
    # 104857600 = 100 MB
    max_cost: 104857600

    # Number of keys per Get buffer (default: 64)
    buffer_items: 64

  # Olric configuration (used when mode: ha)
  # olric:
  #   # For connecting to external Olric cluster:
  #   # addresses:
  #   #   - "olric-1:3320"
  #   #   - "olric-2:3320"
  #
  #   # For embedded Olric node:
  #   # embedded: true
  #   # bind_addr: "0.0.0.0:3320"
  #   # peers:
  #   #   - "olric-1:3320"
  #   #   - "olric-2:3320"
  #
  #   # Distributed map name (default: "cc-relay")
  #   dmap_name: "cc-relay"

# ============================================================================
# gRPC Management API
# ============================================================================
grpc:
  # gRPC server for TUI/CLI management
  listen: "127.0.0.1:9090"

  # Optional: grpc-web for browser-based WebUI
  # web_listen: "127.0.0.1:9091"

# ============================================================================
# Logging
# ============================================================================
logging:
  # Options: "debug", "info", "warn", "error"
  level: "info"

  # Options: "json", "text"
  format: "text"

  # Log file (optional, defaults to stdout)
  # file: "/var/log/cc-relay/relay.log"

# ============================================================================
# Metrics
# ============================================================================
metrics:
  enabled: true

  # Prometheus metrics endpoint
  prometheus_endpoint: "/metrics"
  prometheus_listen: "127.0.0.1:9100"

# ============================================================================
# Health Checking
# ============================================================================
health:
  # Health check settings
  health_check:
    # Enable periodic health checks (default: true)
    enabled: true
    # Check interval in milliseconds (default: 10000 = 10s)
    interval_ms: 10000

  # Circuit breaker settings
  circuit_breaker:
    # Number of consecutive failures before opening circuit (default: 5)
    failure_threshold: 5

    # Duration circuit stays open before half-open, in milliseconds (default: 30000 = 30s)
    open_duration_ms: 30000

    # Number of probe requests allowed in half-open state (default: 3)
    # If all succeed, circuit closes. If any fails, circuit reopens.
    half_open_probes: 3
