# Implementation Report: /v1/models Endpoint

Generated: 2026-01-20T21:55:36-06:00

## Task

Implement `/v1/models` endpoint for cc-relay to list available models from all configured providers, allowing Claude Code to discover what models are available.

## TDD Summary

### Tests Written

**Config Tests (internal/config/loader_test.go):**
- `TestLoad_ProviderModels` - Tests that models can be configured in provider config
- `TestLoad_ProviderModelsEmpty` - Tests empty/missing models field
- `TestLoad_MultipleProvidersWithModels` - Tests multiple providers each with their own models

**Provider Tests (internal/providers/anthropic_test.go):**
- `TestListModels_WithConfiguredModels` - Tests ListModels returns correct Model structs
- `TestListModels_Empty` - Tests empty models returns empty slice
- `TestListModels_NilModels` - Tests nil models handled gracefully
- `TestProviderOwner` - Tests Owner() returns "anthropic"

**Models Handler Tests (internal/proxy/models_test.go):**
- `TestModelsHandler_ReturnsCorrectFormat` - Tests response format matches Anthropic/OpenAI style
- `TestModelsHandler_MultipleProviders` - Tests aggregation from multiple providers
- `TestModelsHandler_EmptyProviders` - Tests empty provider list returns empty data array
- `TestModelsHandler_ProviderWithNoModels` - Tests providers without configured models
- `TestModelsHandler_NilProviders` - Tests nil provider list handled gracefully

**Routes Tests (internal/proxy/routes_test.go):**
- `TestSetupRoutes_ModelsEndpoint` - Tests /v1/models returns 200 and correct Content-Type
- `TestSetupRoutes_ModelsEndpointOnlyGET` - Tests POST to /v1/models returns 405
- `TestSetupRoutes_ModelsEndpointEmptyProviders` - Tests endpoint with no providers

### Implementation

**internal/config/config.go:**
- Added `Models []string` field to `ProviderConfig` struct

**internal/providers/provider.go:**
- Added `Model` struct with JSON tags matching Anthropic/OpenAI format
- Added `Owner()` method to Provider interface
- Added `ListModels()` method to Provider interface

**internal/providers/anthropic.go:**
- Added `models` field to `AnthropicProvider` struct
- Added `NewAnthropicProviderWithModels()` constructor
- Implemented `Owner()` method returning "anthropic"
- Implemented `ListModels()` method

**internal/providers/zai.go:**
- Added `models` field to `ZAIProvider` struct
- Added `NewZAIProviderWithModels()` constructor
- Implemented `Owner()` method returning "zhipu"
- Implemented `ListModels()` method

**internal/proxy/models.go (NEW):**
- Created `ModelsResponse` struct for JSON response
- Created `ModelsHandler` struct
- Implemented `NewModelsHandler()` constructor
- Implemented `ServeHTTP()` to aggregate models from all providers

**internal/proxy/routes.go:**
- Added `SetupRoutesWithProviders()` function with allProviders parameter
- Modified `SetupRoutes()` to call `SetupRoutesWithProviders()` with nil
- Registered `GET /v1/models` route (no auth required)

## Test Results

```
ok      github.com/omarluq/cc-relay/cmd/cc-relay       0.003s
ok      github.com/omarluq/cc-relay/internal/auth      (cached)
ok      github.com/omarluq/cc-relay/internal/config    (cached)
ok      github.com/omarluq/cc-relay/internal/providers (cached)
ok      github.com/omarluq/cc-relay/internal/proxy     (cached)
ok      github.com/omarluq/cc-relay/internal/version   (cached)
```

- Total: 50+ tests
- Passed: All
- Failed: 0

## Changes Made

1. **Config Enhancement:** Added `Models []string` field to ProviderConfig to allow specifying available models per provider in YAML config.

2. **Provider Interface Extension:** Added `Owner()` and `ListModels()` methods to the Provider interface. Both Anthropic and ZAI providers now implement these methods.

3. **Model Discovery:** Created ModelsHandler that aggregates models from all configured providers and returns them in a format compatible with Anthropic/OpenAI model list endpoints.

4. **Route Registration:** Added `GET /v1/models` endpoint that does not require authentication, allowing Claude Code to discover available models.

5. **Backward Compatibility:** The existing `SetupRoutes()` function signature is preserved; a new `SetupRoutesWithProviders()` function was added for cases where all providers need to be passed for the models endpoint.

## Response Format

The `/v1/models` endpoint returns:

```json
{
  "object": "list",
  "data": [
    {
      "id": "claude-sonnet-4-5-20250514",
      "object": "model",
      "created": 1234567890,
      "owned_by": "anthropic",
      "provider": "anthropic-primary"
    },
    {
      "id": "glm-4",
      "object": "model",
      "created": 1234567890,
      "owned_by": "zhipu",
      "provider": "zai-primary"
    }
  ]
}
```

## Files Modified

| File | Change |
|------|--------|
| `/home/omarluq/sandbox/go/cc-relay/internal/config/config.go` | Added Models field to ProviderConfig |
| `/home/omarluq/sandbox/go/cc-relay/internal/config/loader_test.go` | Added 3 tests for models config |
| `/home/omarluq/sandbox/go/cc-relay/internal/providers/provider.go` | Added Model struct, Owner(), ListModels() to interface |
| `/home/omarluq/sandbox/go/cc-relay/internal/providers/anthropic.go` | Implemented new interface methods |
| `/home/omarluq/sandbox/go/cc-relay/internal/providers/anthropic_test.go` | Added 4 tests for new methods |
| `/home/omarluq/sandbox/go/cc-relay/internal/providers/zai.go` | Implemented new interface methods |
| `/home/omarluq/sandbox/go/cc-relay/internal/proxy/models.go` | NEW: Models endpoint handler |
| `/home/omarluq/sandbox/go/cc-relay/internal/proxy/models_test.go` | NEW: 5 tests for models handler |
| `/home/omarluq/sandbox/go/cc-relay/internal/proxy/routes.go` | Added SetupRoutesWithProviders, registered /v1/models |
| `/home/omarluq/sandbox/go/cc-relay/internal/proxy/routes_test.go` | Added 3 tests for models route |

## Notes

1. **No auth on /v1/models:** The models endpoint does not require authentication, matching the pattern used by the /health endpoint. This allows Claude Code to discover available models without credentials.

2. **serve.go not updated:** The cmd/cc-relay/serve.go file needs to be updated to build all providers with their models and pass them to SetupRoutesWithProviders. This is outside the immediate scope but required for full functionality.

3. **Provider models must be configured:** Models are not auto-discovered from the backend API. They must be explicitly listed in the config YAML for each provider.

Example config:
```yaml
providers:
  - name: anthropic-primary
    type: anthropic
    enabled: true
    models:
      - claude-sonnet-4-5-20250514
      - claude-opus-4-5-20250514
    keys:
      - key: ${ANTHROPIC_API_KEY}
```
