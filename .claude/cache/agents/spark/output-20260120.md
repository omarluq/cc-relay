# Quick Fix: Enhanced Zerolog Logging with Colors and CLI Flags
Generated: 2026-01-20

## Change Made

Enhanced zerolog logging for cc-relay with better formatting, colors, CLI flags, and terminal auto-detection.

### 1. CLI Flags Added (cmd/cc-relay/serve.go)
- Lines: 22-25, 38-40, 58-65
- Added `--log-level` flag (debug, info, warn, error) - overrides config
- Added `--log-format` flag (json, pretty) - overrides config
- Flags are applied before logger initialization

### 2. Enhanced Logger (internal/proxy/logger.go)
- Lines: 24-126
- **Terminal auto-detection**: Uses `go-isatty` to detect if stdout is a terminal
- **Format modes**:
  - `json`: Raw JSON output (no colors)
  - `pretty`: Force colored console output
  - `console`: Auto-detect (pretty if terminal, json if piped)
  - Default: Auto-detect
- **Custom ConsoleWriter formatting**:
  - Colors: INFO=green, WARN=yellow, ERROR=red, DEBUG=cyan, FATAL/PANIC=magenta
  - Time format: `15:04:05` (HH:MM:SS)
  - Message prefix: `→ <message>`
  - Field names: Dimmed gray
- **Better color coding**:
  - `DBG` (cyan): `\033[36mDBG\033[0m`
  - `INF` (green): `\033[32mINF\033[0m`
  - `WRN` (yellow): `\033[33mWRN\033[0m`
  - `ERR` (red): `\033[31mERR\033[0m`
  - `FTL`/`PNC` (magenta): `\033[35m...\033[0m`

### 3. Improved Request Logging (internal/proxy/middleware.go)
- Lines: 69-141
- **Request start format**: `→ POST /v1/messages`
- **Request completion format**: `✓ OK (1.84s)` or `✗ Internal Server Error (2.1s)` or `⚠ Bad Request (105ms)`
- **Request ID**: Shows short ID (first 8 chars) in `req_id` field
- **Status symbols**:
  - 2xx/3xx: `✓` (success)
  - 4xx: `⚠` (warning)
  - 5xx: `✗` (error)
- **Duration formatting**: Auto-rounds to milliseconds for readability
- Added helper functions:
  - `formatDuration()`: Rounds to milliseconds
  - `formatCompletionMessage()`: Formats status with symbol and duration

### 4. Bug Fixes
- Fixed missing `log` import in `cmd/cc-relay/status.go` (line 10)
- Removed unused `time` import from `internal/providers/zai.go` (later re-added by linter because it's used in ListModels)

## Verification

- Syntax check: PASS (build successful)
- Pattern followed: Standard zerolog ConsoleWriter customization
- CLI flags: PASS (visible in `--help` output)

## Files Modified

1. `cmd/cc-relay/serve.go` - Added CLI flags and flag override logic
2. `internal/proxy/logger.go` - Enhanced ConsoleWriter with colors, auto-detection
3. `internal/proxy/middleware.go` - Improved request logging format
4. `cmd/cc-relay/status.go` - Added missing log import

## Example Output

**Before** (JSON):
```json
{"level":"info","time":"2026-01-20T15:04:05Z","message":"request started","method":"POST","path":"/v1/messages","request_id":"abc123def456"}
{"level":"info","time":"2026-01-20T15:04:07Z","message":"request completed","method":"POST","path":"/v1/messages","status":200,"duration_ms":1840}
```

**After** (Pretty Console):
```
15:04:05 INF → POST /v1/messages method=POST path=/v1/messages req_id=abc123de
15:04:07 INF → ✓ OK (1.84s) method=POST path=/v1/messages status=200 duration=1.84s req_id=abc123de
```

**After** (Pretty Console - Error):
```
15:04:05 INF → POST /v1/messages method=POST path=/v1/messages req_id=xyz789ab
15:04:07 ERR → ✗ Internal Server Error (2.1s) method=POST path=/v1/messages status=500 duration=2.1s req_id=xyz789ab
```

## Usage

```bash
# Use default (auto-detect terminal)
./cc-relay serve

# Force pretty output
./cc-relay serve --log-format pretty

# Force JSON output
./cc-relay serve --log-format json

# Set log level to debug
./cc-relay serve --log-level debug

# Combine flags
./cc-relay serve --log-level debug --log-format pretty
```

## Notes

- Terminal auto-detection works by checking if stdout is a TTY using `go-isatty`
- When piping to files or `jq`, automatically switches to JSON format (unless `--log-format` overrides)
- Colors use ANSI escape codes (may not work on Windows Command Prompt, but work in Windows Terminal)
- The `→` arrow prefix makes log messages visually distinct
- Status symbols (✓/✗/⚠) provide quick visual feedback
- Short request IDs (8 chars) keep logs compact while still being unique enough for debugging

## Dependencies Added

- `github.com/mattn/go-isatty` (already in go.mod as indirect dependency)
