# Fix Format Issues Skill

**CRITICAL**: When formatters fail or code is unformatted, FIX THE CODE formatting, not the formatter configuration.

## Core Principle

❌ **NEVER** modify `.yamlfmt`, `.yamllint`, or formatter configs to bypass issues
✅ **ALWAYS** let formatters fix the code

## Automatic Formatting

Most formatting is automatic:

```bash
# Format everything
task fmt

# Individual formatters
gofmt -w .
goimports -w .
gofumpt -w .
yamlfmt -w .
markdownlint --fix '**/*.md'
```

## Go Code Formatting

### Let Formatters Fix It

```bash
# Run all Go formatters
task fmt

# This runs:
# 1. gofmt -w .      # Basic formatting
# 2. goimports -w .  # Import organization
# 3. gofumpt -w .    # Strict formatting
```

### Common Go Format Issues

#### 1. Import Organization

❌ Don't manually organize:
```go
import (
    "fmt"
    "github.com/omarluq/cc-relay/internal/proxy"
    "net/http"
)
```

✅ Let goimports fix it:
```bash
goimports -w internal/proxy/proxy.go
```

Result:
```go
import (
    "fmt"
    "net/http"

    "github.com/omarluq/cc-relay/internal/proxy"
)
```

#### 2. Line Spacing

❌ Don't manually adjust:
```go
func process(){
if ready{
do()
}
}
```

✅ Let gofmt fix it:
```bash
gofmt -w internal/proxy/proxy.go
```

Result:
```go
func process() {
    if ready {
        do()
    }
}
```

#### 3. Simplifications

❌ Don't manually simplify:
```go
if x == true {
    return true
} else {
    return false
}
```

✅ Let gofumpt fix it:
```bash
gofumpt -w internal/proxy/proxy.go
```

Result:
```go
return x
```

## YAML Formatting

### Auto-Fix YAML

```bash
# Format all YAML files
task yaml-fmt

# Or directly
yamlfmt -w .
```

### Common YAML Issues

#### 1. Indentation

❌ Bad:
```yaml
server:
   port: 8787
     host: localhost
```

✅ Fixed by yamlfmt:
```yaml
server:
  port: 8787
  host: localhost
```

#### 2. Line Length

❌ Bad:
```yaml
description: "This is a very long description that exceeds the maximum line length and should be wrapped"
```

✅ Fixed by yamlfmt:
```yaml
description: >
  This is a very long description that exceeds
  the maximum line length and should be wrapped
```

## Markdown Formatting

### Auto-Fix Markdown

```bash
# Fix all markdown files
task markdown-lint

# Or directly
markdownlint --fix '**/*.md'
```

### Common Markdown Issues

#### 1. List Formatting

❌ Bad:
```markdown
-item1
- item2
-  item3
```

✅ Fixed by markdownlint:
```markdown
- item1
- item2
- item3
```

#### 2. Heading Spacing

❌ Bad:
```markdown
#Heading
Content
##SubHeading
```

✅ Fixed by markdownlint:
```markdown
# Heading

Content

## SubHeading
```

## Pre-Commit Integration

Formatters run automatically:

```bash
git add file.go
git commit -m "feat: add feature"

# Hooks automatically:
# 1. Run gofmt, goimports, gofumpt
# 2. Run yamlfmt on YAML files
# 3. Run markdownlint on MD files
# 4. Stage fixed files
# 5. Complete commit
```

## Manual Formatting Workflow

### Before Committing

```bash
# 1. Format all code
task fmt

# 2. Check what changed
git diff

# 3. Stage changes
git add .

# 4. Commit (hooks will verify)
git commit -m "feat: add feature"
```

### Fixing Specific Files

```bash
# Format single Go file
gofmt -w internal/proxy/proxy.go
goimports -w internal/proxy/proxy.go
gofumpt -w internal/proxy/proxy.go

# Format single YAML file
yamlfmt -w example.yaml

# Format single Markdown file
markdownlint --fix README.md
```

## Never Do This

❌ Modify `.yamlfmt` to allow bad formatting
❌ Modify `.yamllint` to disable rules
❌ Modify `.markdownlint.json` to bypass checks
❌ Add files to formatter exclusion lists
❌ Disable formatters in lefthook

## Always Do This

✅ Run `task fmt` before committing
✅ Let formatters fix the code
✅ Trust the formatter output
✅ Keep formatter configs as-is
✅ Fix code structure, not formatter settings

## Edge Cases

### Generated Code

If code is generated and formatter breaks it:

```go
// At top of file
//go:generate some-generator

// Add this comment
// Code generated by some-generator. DO NOT EDIT.

// Formatters will still run, but you can
// regenerate if needed
```

### Proto Files

```bash
# Format proto files
task proto-format

# Or
buf format -w
```

## Integration

- **Pre-commit**: All formatters run automatically
- **Task**: `task fmt` for manual formatting
- **CI**: Format check in GitHub Actions

## Tips

1. **Run early**: Format before linting/testing
2. **Trust tools**: Formatters are rarely wrong
3. **Commit formatted**: Always commit formatted code
4. **Check diffs**: Review formatter changes before committing
5. **Don't fight it**: If formatter changes it, it's for consistency

## Troubleshooting

### Formatter Errors

```bash
# If gofmt fails
go fmt ./...

# If yamlfmt fails
yamlfmt -w -lint .

# Check file syntax
yamllint file.yaml
```

### Conflicting Changes

```bash
# Format
task fmt

# Check changes
git diff

# If too many changes, format incrementally
gofmt -w internal/
git add internal/
git commit -m "style: format internal package"
```
